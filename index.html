<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlightLog Converter - Air Canada to MyFlightBook</title>
    <meta name="description" content="Convert Air Canada PQRM logbook exports to MyFlightBook CSV format. Free, private, runs entirely in your browser.">
    <meta property="og:title" content="FlightLog Converter">
    <meta property="og:description" content="Convert Air Canada PQRM exports to MyFlightBook format. Free & private - all processing happens in your browser.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0f1a' width='100' height='100'/><text x='50' y='60' text-anchor='middle' font-size='50'>‚úàÔ∏è</text></svg>">
    <meta name="twitter:card" content="summary">
    <meta name="theme-color" content="#0a0f1a">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23dc2626'><path d='M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z'/></svg>">
    <style>
        :root,html[data-theme="dark"]{--bg:#0a0f1a;--bg2:#111827;--card:#1a2234;--hover:#1e293b;--red:#dc2626;--blue:#3b82f6;--green:#10b981;--yellow:#eab308;--purple:#8b5cf6;--orange:#f97316;--cyan:#06b6d4;--text:#f8fafc;--text2:#94a3b8;--muted:#64748b;--border:#2d3748;--shadow:0 4px 20px rgba(0,0,0,.4);--primary:#3b82f6;--primary-hover:#2563eb}
        html[data-theme="light"]{--bg:#f1f5f9;--bg2:#ffffff;--card:#ffffff;--hover:#e2e8f0;--red:#dc2626;--blue:#2563eb;--green:#059669;--yellow:#ca8a04;--purple:#7c3aed;--orange:#ea580c;--cyan:#0891b2;--text:#0f172a;--text2:#475569;--muted:#64748b;--border:#cbd5e1;--shadow:0 4px 20px rgba(0,0,0,.08);--primary:#2563eb;--primary-hover:#1d4ed8}
        @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideIn{from{opacity:0;transform:translateX(-10px)}to{opacity:1;transform:translateX(0)}}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
        @keyframes spin{to{transform:rotate(360deg)}}
        @keyframes scaleIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
        @keyframes checkmark{0%{stroke-dashoffset:100}100%{stroke-dashoffset:0}}
        @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6;font-size:14px}
        .container{max-width:1400px;margin:0 auto;padding:1.5rem}
        header{text-align:center;margin-bottom:1.5rem;position:relative;padding:1.25rem 0}
        .logo{font-size:2.5rem;margin-bottom:.35rem;display:block;filter:drop-shadow(0 2px 8px rgba(59,130,246,.3));animation:fadeIn .5s ease}
        h1{font-size:1.85rem;font-weight:700;background:linear-gradient(135deg,var(--blue),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.02em;margin-bottom:.2rem}
        .subtitle{color:var(--text2);font-size:.95rem}
        .subtitle strong{color:var(--text);font-weight:600}
        .theme-toggle{position:absolute;top:0;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:20px;padding:4px;display:flex;gap:2px}
        .theme-toggle button{border:none;background:transparent;width:28px;height:28px;border-radius:50%;cursor:pointer;font-size:.85rem;transition:all .2s;display:flex;align-items:center;justify-content:center}
        .theme-toggle button:hover{background:var(--hover)}
        .theme-toggle button.active{background:var(--primary);color:#fff}
        .steps{display:flex;justify-content:center;align-items:center;gap:0;margin:1.5rem 0;position:relative}
        .step{display:flex;align-items:center;gap:.5rem;padding:.7rem 1.5rem;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:.9rem;font-weight:600;transition:all .3s ease;position:relative}
        .step:first-child{border-radius:10px 0 0 10px}.step:last-child{border-radius:0 10px 10px 0}
        .step.active{background:linear-gradient(135deg,var(--primary),var(--blue));border-color:var(--primary);color:#fff;box-shadow:0 4px 15px rgba(59,130,246,.4);transform:scale(1.02)}
        .step.completed{background:var(--green);border-color:var(--green);color:#fff}
        .step.completed span{background:rgba(255,255,255,.3)}
        .step.completed span::after{content:'‚úì';font-size:.65rem}
        .step span{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;background:rgba(255,255,255,.15);border-radius:50%;font-size:.8rem;font-weight:700;transition:all .3s}
        .step:not(.completed) span::after{content:attr(data-num)}
        .step-connector{width:30px;height:3px;background:var(--border);transition:background .3s}
        .step-connector.done{background:var(--green)}
        .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:1.5rem;margin-bottom:1rem;box-shadow:var(--shadow);animation:fadeIn .4s ease}
        .loading{position:relative;pointer-events:none;opacity:.7}
        .loading::after{content:'';position:absolute;top:50%;left:50%;width:24px;height:24px;margin:-12px 0 0 -12px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite}
        .btn.loading{color:transparent}
        .btn.loading::after{width:16px;height:16px;margin:-8px 0 0 -8px;border-width:2px}
        .card-header{display:flex;align-items:center;gap:.6rem;margin-bottom:1rem;padding-bottom:.75rem;border-bottom:1px solid var(--border);flex-wrap:wrap}
        .card-title{font-size:1.1rem;font-weight:600}
        .format-row{display:flex;gap:1rem;flex-wrap:wrap;margin-bottom:1rem}
        .format-group{flex:1;min-width:200px}
        .format-group label{display:block;font-size:.8rem;font-weight:600;color:var(--text2);margin-bottom:.4rem;text-transform:uppercase;letter-spacing:.03em}
        .format-group select{width:100%;padding:.6rem .75rem;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.9rem;cursor:pointer;transition:border-color .2s}
        .format-group select:hover{border-color:var(--primary)}
        .mode-toggle{display:inline-flex;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:4px;margin-bottom:1rem}
        .mode-toggle button{padding:.5rem 1rem;border:none;background:transparent;color:var(--muted);font-size:.875rem;font-weight:500;border-radius:6px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:.35rem}
        .mode-toggle button.active{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.25)}
        .mode-toggle button:hover:not(.active){color:var(--text);background:var(--hover)}
        .upload-zone{border:2px dashed var(--border);border-radius:16px;padding:3rem 2rem;text-align:center;cursor:pointer;transition:all .3s ease;background:linear-gradient(135deg,rgba(59,130,246,.02),rgba(6,182,212,.02))}
        .upload-zone:hover,.upload-zone.dragover{border-color:var(--primary);background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(6,182,212,.08));transform:translateY(-2px);box-shadow:0 8px 25px rgba(59,130,246,.15)}
        .upload-zone.has-file{border-color:var(--green);border-style:solid;background:linear-gradient(135deg,rgba(16,185,129,.08),rgba(6,182,212,.05))}
        .upload-icon{font-size:3rem;margin-bottom:.75rem;display:block;transition:transform .3s}
        .upload-zone:hover .upload-icon{transform:scale(1.1) translateY(-3px)}
        .upload-text{font-size:1.1rem;color:var(--text);margin-bottom:.4rem;font-weight:600}.upload-hint{font-size:.9rem;color:var(--muted)}
        .file-input{display:none}
        .file-list{margin-top:1rem;display:flex;flex-direction:column;gap:.4rem}
        .file-item{display:flex;align-items:center;justify-content:space-between;padding:.65rem 1rem;background:var(--bg2);border-radius:8px;font-size:.9rem;color:var(--green);border:1px solid var(--green);animation:slideIn .3s ease;font-weight:500}
        .file-item::before{content:'‚úì';margin-right:.5rem;font-weight:700}
        .file-item button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;padding:.3rem;border-radius:6px;transition:all .2s}
        .file-item button:hover{color:var(--red);background:rgba(220,38,38,.1);transform:scale(1.1)}
        .pilot-detection{background:var(--bg2);border:1px solid var(--border);border-left:4px solid var(--purple);border-radius:8px;padding:1rem;margin-top:1rem;display:none}
        .pilot-detection.visible{display:block}
        .pilot-detection h4{color:var(--purple);font-size:.9rem;font-weight:600;margin-bottom:.5rem;display:flex;align-items:center;gap:.4rem}
        .pilot-detection .detected-info{font-size:.8rem;color:var(--text2);margin-top:.4rem}
        .pilot-detection input{width:200px;padding:.5rem .65rem;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.9rem}
        .pilot-detection input:focus{border-color:var(--purple);outline:none}
        .instructions{background:var(--bg2);border-left:4px solid var(--yellow);border-radius:8px;padding:1rem;margin-top:1rem}
        .instructions h4{color:var(--yellow);font-size:.9rem;font-weight:600;margin-bottom:.35rem}
        .instructions p{color:var(--text2);line-height:1.5;font-size:.85rem}
        .settings-row{display:flex;gap:1rem;flex-wrap:wrap;margin-top:1rem;align-items:flex-end}
        .setting-group{min-width:140px}
        .setting-group.small{min-width:auto}
        label{display:block;font-size:.8rem;font-weight:600;color:var(--text2);margin-bottom:.35rem;text-transform:uppercase;letter-spacing:.03em}
        input[type="text"],input[type="date"],input[type="number"],input[type="datetime-local"],select{width:100%;padding:.5rem .65rem;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.9rem;transition:border-color .2s}
        input:focus,select:focus{outline:none;border-color:var(--primary)}
        .toggle-group{display:flex;align-items:center;gap:.4rem}
        .toggle-label{font-size:.85rem;color:var(--text2)}
        .toggle{width:36px;height:20px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;cursor:pointer;position:relative;transition:all .2s}
        .toggle.active{background:var(--primary);border-color:var(--primary)}
        .toggle::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:transform .2s;box-shadow:0 1px 3px rgba(0,0,0,.2)}
        .toggle.active::after{transform:translateX(16px)}
        .btn{display:inline-flex;align-items:center;gap:.35rem;padding:.6rem 1.1rem;border-radius:8px;font-size:.9rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
        .btn-primary{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(59,130,246,.25)}.btn-primary:hover:not(:disabled){background:var(--primary-hover);transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.3)}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed}
        .btn-secondary{background:var(--bg2);color:var(--text);border:1px solid var(--border)}
        .btn-secondary:hover{border-color:var(--primary);background:var(--hover)}
        .btn-success{background:linear-gradient(135deg,var(--green),#059669);color:#fff;box-shadow:0 2px 8px rgba(16,185,129,.3)}.btn-success:hover{background:linear-gradient(135deg,#059669,#047857);transform:translateY(-2px);box-shadow:0 6px 15px rgba(16,185,129,.35)}
        .btn-success::before{content:'';display:inline-block;width:0;height:0;transition:width .2s}
        .btn-success.downloaded{animation:pulse .5s}
        .btn-success.downloaded::before{content:'‚úì ';width:auto}
        .btn-small{padding:.35rem .6rem;font-size:.8rem}
        .btn-row{display:flex;gap:.5rem;margin-top:1.25rem;flex-wrap:wrap}
        .dropdown{position:relative;display:inline-block}
        .dropdown-content{display:none;position:absolute;top:100%;left:0;background:var(--card);border:1px solid var(--border);border-radius:8px;min-width:160px;z-index:50;max-height:250px;overflow-y:auto;margin-top:4px;box-shadow:var(--shadow)}
        .dropdown.open .dropdown-content{display:block}
        .dropdown-item{padding:.5rem .75rem;font-size:.85rem;cursor:pointer;display:flex;align-items:center;gap:.5rem;transition:background .15s}
        .dropdown-item:hover{background:var(--hover)}
        .dropdown-item input{width:14px;height:14px}
        .table-wrapper{position:relative;margin-top:.75rem;border:1px solid var(--border);border-radius:10px;overflow:hidden}
        .table-scroll{max-height:420px;overflow:auto;-webkit-overflow-scrolling:touch}
        table{width:100%;border-collapse:collapse;font-size:.8rem}
        thead{position:sticky;top:0;z-index:20}
        th{background:var(--bg2);padding:.6rem .4rem;text-align:left;font-weight:600;color:var(--text2);font-size:.75rem;border-bottom:2px solid var(--border);white-space:nowrap;position:relative;text-transform:uppercase;letter-spacing:.02em}
        th.center,td.center{text-align:center}
        th.sticky-col,td.sticky-col{position:sticky;left:0;z-index:10;background:var(--bg2)}
        td.sticky-col{background:var(--card)}
        th .col-delete{display:none;position:absolute;right:4px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:.7rem;padding:2px 4px;border-radius:3px}
        th:hover .col-delete{display:inline}
        th .col-delete:hover{color:var(--red);background:rgba(220,38,38,.1)}
        .header-label{cursor:pointer;border-bottom:1px dashed transparent;transition:border-color .15s}
        .header-label:hover{border-bottom-color:var(--primary)}
        td{padding:.5rem .4rem;border-bottom:1px solid var(--border);font-family:'SF Mono',Monaco,monospace;font-size:.8rem;white-space:nowrap}
        tbody tr{transition:background .15s ease}
        tr:nth-child(even) td{background:rgba(255,255,255,.02)}
        tr:nth-child(even) td.sticky-col{background:var(--hover)}
        tr:hover td{background:var(--hover)}
        tr.duplicate td{background:rgba(249,115,22,.12);border-left:3px solid var(--orange)}
        tr.time-error td{background:rgba(220,38,38,.1);border-left:3px solid var(--red)}
        tr.time-error td.time-cell{color:var(--red);font-weight:600}
        tr.rounding-notice td.time-cell{color:var(--cyan)}
        tr.assumed-rp td{border-left:3px solid var(--yellow)}
        td.selected-cell{outline:2px solid var(--primary);outline-offset:-1px}
        .cell-route{color:var(--blue);font-weight:600}
        .cell-time{color:var(--green)}
        .cell-pilot{color:var(--purple)}
        .cell-model{color:var(--cyan)}
        .editable{cursor:pointer;padding:.15rem .2rem;border-radius:4px;min-width:28px;display:inline-block;transition:background .15s}
        .editable:hover{background:rgba(59,130,246,.15)}
        .edit-input{width:100%;min-width:36px;padding:.2rem .25rem;background:var(--bg);border:2px solid var(--primary);border-radius:4px;color:var(--text);font-family:'SF Mono',Monaco,monospace;font-size:.8rem}
        .edit-input[type="datetime-local"]{min-width:140px}
        .edit-input[type="number"]{min-width:50px}
        .edit-input[type="date"]{min-width:100px}
        .flight-checkbox{width:16px;height:16px;accent-color:var(--primary);cursor:pointer}
        .flight-checkbox:focus{outline:2px solid var(--primary);outline-offset:2px}
        .role-toggle{display:inline-flex;background:var(--bg2);border-radius:6px;padding:2px;gap:1px}
        .role-toggle button{padding:.25rem .4rem;border:none;background:transparent;color:var(--muted);font-size:.7rem;font-weight:600;border-radius:4px;cursor:pointer;transition:all .15s}
        .role-toggle button.active{background:var(--primary);color:#fff}
        .role-toggle button:hover:not(.active){background:var(--hover)}
        .role-toggle button:focus{outline:2px solid var(--cyan);outline-offset:1px}
        .delete-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:.25rem;font-size:.85rem;border-radius:4px;transition:all .15s}
        .delete-btn:hover{color:var(--red);background:rgba(220,38,38,.1)}
        .badge{display:inline-block;padding:.2rem .45rem;border-radius:5px;font-size:.7rem;font-weight:700;margin-right:.25rem;animation:scaleIn .2s ease}
        .dup-badge{background:rgba(249,115,22,.15);border:1px solid var(--orange);color:var(--orange)}
        .err-badge{background:rgba(220,38,38,.15);border:1px solid var(--red);color:var(--red);animation:pulse 2s infinite}
        .info-badge{background:rgba(6,182,212,.12);border:1px solid var(--cyan);color:var(--cyan)}
        .unmapped-badge{background:rgba(139,92,246,.12);border:1px solid var(--purple);color:var(--purple);font-size:.65rem}
        .rp-badge{background:rgba(234,179,8,.15);border:1px solid var(--yellow);color:var(--yellow)}
        .assumed-rp{background:rgba(234,179,8,.05)}
        .stats-row{display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--border)}
        .stat-box{background:var(--bg2);padding:.5rem .75rem;border-radius:8px;min-width:60px;border:1px solid var(--border)}
        .stat-label{font-size:.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:.03em;margin-bottom:.1rem}
        .stat-value{font-size:1rem;font-weight:700;color:var(--primary);font-family:'SF Mono',Monaco,monospace}
        .status{padding:.85rem 1.25rem;border-radius:10px;margin-top:1rem;font-size:.95rem;font-weight:500;animation:fadeIn .3s ease;display:flex;align-items:center;gap:.6rem}
        .status::before{font-size:1.1rem}
        .status-error{background:rgba(220,38,38,.1);border:1px solid rgba(220,38,38,.3);color:#fca5a5}
        .status-error::before{content:'‚ö†Ô∏è'}
        .status-success{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#6ee7b7}
        .status-success::before{content:'‚úÖ'}
        .status-warning{background:rgba(249,115,22,.1);border:1px solid rgba(249,115,22,.3);color:#fdba74}
        .status-warning::before{content:'‚ö°'}
        .toolbar{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.75rem;padding:.75rem;background:var(--bg2);border-radius:10px;border:1px solid var(--border)}
        .toolbar .btn-small{transition:all .2s}
        .toolbar .btn-small:hover{transform:translateY(-1px)}
        .toolbar-sep{width:1px;height:24px;background:var(--border);margin:0 .35rem}
        .shortcuts-help{font-size:.8rem;color:var(--muted);padding:.35rem .6rem;background:var(--card);border:1px solid var(--border);border-radius:6px;cursor:help;position:relative}
        .shortcuts-help:hover .shortcuts-popup{display:block}
        .shortcuts-popup{display:none;position:absolute;bottom:100%;left:0;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.75rem;width:240px;z-index:100;margin-bottom:6px;box-shadow:var(--shadow)}
        .shortcuts-popup div{font-size:.8rem;padding:.25rem 0;display:flex;justify-content:space-between}
        .shortcuts-popup kbd{background:var(--bg2);padding:.15rem .35rem;border-radius:4px;font-family:'SF Mono',Monaco,monospace;font-size:.75rem;border:1px solid var(--border)}
        .optional-panel{margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)}
        .optional-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.6rem;flex-wrap:wrap;gap:.5rem}
        .optional-header h4{font-size:.95rem;color:var(--text);font-weight:600}
        .search-box{display:flex;align-items:center;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:.4rem .6rem}
        .search-box input{background:transparent;border:none;color:var(--text);font-size:.85rem;width:120px;outline:none}
        .search-box input::placeholder{color:var(--muted)}
        .category-tabs{display:flex;gap:.25rem;flex-wrap:wrap;margin-bottom:.5rem}
        .category-tab{padding:.4rem .7rem;background:var(--bg2);border:1px solid var(--border);border-radius:6px;font-size:.8rem;color:var(--muted);cursor:pointer;transition:all .15s;font-weight:500}
        .category-tab:hover{border-color:var(--primary);color:var(--text)}
        .category-tab.active{background:var(--primary);border-color:var(--primary);color:#fff}
        .fields-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.35rem;max-height:150px;overflow-y:auto;padding:.5rem;background:var(--bg2);border-radius:8px}
        .field-item{display:flex;align-items:center;gap:.35rem;padding:.4rem .5rem;background:var(--card);border:1px solid var(--border);border-radius:6px;font-size:.8rem;cursor:pointer;transition:all .15s}
        .field-item:hover{border-color:var(--primary);background:var(--hover)}
        .field-item.selected{background:rgba(59,130,246,.1);border-color:var(--primary)}
        .field-item input{width:14px;height:14px}
        .field-item .field-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .field-item .field-type{font-size:.65rem;padding:.1rem .25rem;background:var(--bg2);border-radius:4px;color:var(--muted)}
        .selected-fields{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem}
        .selected-tag{display:flex;align-items:center;gap:.25rem;padding:.35rem .5rem;background:rgba(59,130,246,.1);border:1px solid var(--primary);border-radius:6px;font-size:.8rem;color:var(--primary);font-weight:500}
        .selected-tag button{background:none;border:none;color:var(--primary);cursor:pointer;font-size:.85rem;line-height:1;padding:.1rem;border-radius:3px;transition:all .15s}
        .selected-tag button:hover{color:var(--red);background:rgba(220,38,38,.1)}
        .selected-tag .reorder-btn{color:var(--muted);font-size:.75rem}
        .selected-tag .reorder-btn:hover{color:var(--primary);background:rgba(59,130,246,.1)}
        .section{display:none;opacity:0}.section.active{display:block;opacity:1}
        .preview-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem}
        .row-count,.dup-count,.err-count,.rp-count{padding:.3rem .75rem;border-radius:999px;font-size:.85rem;font-weight:700;color:#fff;display:inline-flex;align-items:center;gap:.3rem}
        .row-count{background:linear-gradient(135deg,var(--primary),var(--blue))}.dup-count{background:linear-gradient(135deg,var(--orange),#ea580c)}.err-count{background:linear-gradient(135deg,var(--red),#b91c1c)}.rp-count{background:linear-gradient(135deg,var(--yellow),#ca8a04);color:#000}
        footer{text-align:center;padding:2rem 1.5rem;color:var(--muted);font-size:.9rem;border-top:1px solid var(--border);margin-top:1.5rem;background:linear-gradient(to top,rgba(59,130,246,.02),transparent)}
        footer a{color:var(--primary);text-decoration:none;font-weight:600;transition:color .2s}
        footer a:hover{color:var(--cyan);text-decoration:underline}
        .hidden{display:none!important}
        @media(max-width:640px){.container{padding:1rem}.format-row{flex-direction:column}.format-group{min-width:100%}.settings-row{flex-direction:column}.table-scroll{max-height:320px}th,td{padding:.4rem .25rem}.btn{padding:.5rem .75rem}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="theme-toggle" id="themeToggle" title="Switch theme">
                <button data-theme="light">‚òÄÔ∏è</button>
                <button data-theme="dark" class="active">üåô</button>
            </div>
            <span class="logo">‚úàÔ∏è</span>
            <h1>FlightLog Converter</h1>
            <p class="subtitle">Convert <strong>Air Canada</strong> logbooks to <strong>MyFlightBook</strong> format</p>
        </header>
        <div class="steps">
            <div class="step active" id="step1"><span data-num="1"></span> Setup</div>
            <div class="step-connector" id="conn1"></div>
            <div class="step" id="step2"><span data-num="2"></span> Review</div>
            <div class="step-connector" id="conn2"></div>
            <div class="step" id="step3"><span data-num="3"></span> Export</div>
        </div>
        <div class="section active" id="section1">
            <div class="card">
                <div class="card-header"><h2 class="card-title">Configure Import & Export</h2></div>
                <div class="format-row">
                    <div class="format-group">
                        <label>Source Format</label>
                        <select id="sourceFormat"><option value="ac-pqrm">Air Canada PQRM</option><option value="other" disabled>Other (Coming Soon)</option></select>
                    </div>
                    <div class="format-group">
                        <label>Export Format</label>
                        <select id="exportFormat"><option value="myflightbook">MyFlightBook</option><option value="other" disabled>Other (Coming Soon)</option></select>
                    </div>
                </div>
                <div class="mode-toggle" id="modeToggle">
                    <button class="active" data-mode="upload">üìÅ Upload</button>
                    <button data-mode="manual">‚úèÔ∏è Manual</button>
                </div>
                <div id="uploadSection">
                    <div class="upload-zone" id="uploadZone">
                        <span class="upload-icon">üìÅ</span>
                        <p class="upload-text">Drop your Air Canada XLS files here</p>
                        <p class="upload-hint">or click to browse ‚Ä¢ Supports .xls, .xlsx, .csv</p>
                        <input type="file" class="file-input" id="fileInput" accept=".xls,.xlsx,.csv,.txt" multiple>
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="pilot-detection" id="pilotDetection">
                        <h4>üë§ Detected Pilot</h4>
                        <input type="text" id="pilotName" placeholder="Your name">
                        <div class="detected-info" id="detectedInfo"></div>
                    </div>
                    <div class="instructions">
                        <h4>üìã Export from Aeronet</h4>
                        <p>Aeronet ‚Üí Flight Ops ‚Üí PQRM ‚Üí Logbook ‚Üí Select month ‚Üí Submit ‚Üí Save as Excel</p>
                    </div>
                </div>
                <div id="manualSection" class="hidden">
                    <div class="pilot-detection visible">
                        <h4>üë§ Your Name</h4>
                        <input type="text" id="pilotNameManual" placeholder="Enter your name">
                        <div class="detected-info">Used for "Self" in PIC/SIC fields</div>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-group">
                        <label>Employer</label>
                        <select id="employer"><option value="Rouge">Air Canada Rouge</option><option value="Air Canada">Air Canada Mainline</option></select>
                    </div>
                    <div class="setting-group small">
                        <label>&nbsp;</label>
                        <div class="toggle-group">
                            <span class="toggle-label">Self</span>
                            <div class="toggle" id="selfToggle"></div>
                            <span class="toggle-label">Name</span>
                        </div>
                    </div>
                </div>
                <div id="statusMessage"></div>
                <div class="btn-row">
                    <button class="btn btn-primary" id="processBtn" disabled>Process ‚Üí</button>
                    <button class="btn btn-primary hidden" id="manualStartBtn">Start ‚Üí</button>
                </div>
            </div>
        </div>
        <div class="section" id="section2">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Review & Edit</h2>
                    <span class="row-count" id="flightCount">0</span>
                    <span class="dup-count" id="dupCount" style="display:none">0</span>
                    <span class="err-count" id="errCount" style="display:none">0</span>
                    <span class="rp-count" id="rpCount" style="display:none">0</span>
                </div>
                <div class="toolbar">
                    <button class="btn btn-small btn-secondary" id="addBtn">+ Add</button>
                    <button class="btn btn-small btn-secondary" id="clearAllBtn" style="color:var(--red)">Clear All</button>
                    <div class="toolbar-sep"></div>
                    <button class="btn btn-small btn-secondary" id="allPicBtn">All PIC</button>
                    <button class="btn btn-small btn-secondary" id="allSicBtn">All SIC</button>
                    <button class="btn btn-small btn-secondary" id="allRpBtn">All RP</button>
                    <button class="btn btn-small btn-secondary" id="confirmRpBtn" style="display:none;color:var(--yellow)" title="Confirm all flights marked as assumed RP">Confirm RP?</button>
                    <div class="toolbar-sep"></div>
                    <div class="dropdown" id="colDropdown">
                        <button class="btn btn-small btn-secondary" id="colDropdownBtn">+ Columns</button>
                        <div class="dropdown-content" id="colDropdownContent"></div>
                    </div>
                    <div class="toolbar-sep"></div>
                    <div class="shortcuts-help">
                        ‚å® Keys
                        <div class="shortcuts-popup">
                            <div><span>Navigate</span><kbd>Tab</kbd> <kbd>Arrows</kbd></div>
                            <div><span>Edit cell</span><kbd>Enter</kbd></div>
                            <div><span>Cancel</span><kbd>Esc</kbd></div>
                            <div><span>Toggle checkbox</span><kbd>Space</kbd></div>
                            <div><span>Clear cell</span><kbd>Del</kbd></div>
                            <div><span>Undo</span><kbd>Ctrl+Z</kbd></div>
                            <div><span>Add row</span><kbd>Ctrl+N</kbd></div>
                            <div><span>Delete row</span><kbd>Ctrl+Del</kbd></div>
                            <div><span>Fill column</span><kbd>Ctrl+Shift+F</kbd></div>
                        </div>
                    </div>
                    <div class="toolbar-sep"></div>
                    <a href="https://myflightbook.com/logbook/mvc/pub/ImportTable" target="_blank" class="btn btn-small btn-secondary" style="text-decoration:none;color:var(--cyan)">üìñ MFB Fields</a>
                </div>
                <div class="table-wrapper">
                    <div class="table-scroll" id="tableScroll">
                        <table id="flightsTable"><thead id="flightsHead"></thead><tbody id="flightsBody"></tbody></table>
                    </div>
                </div>
                <div class="stats-row" id="statsRow"></div>
                <div class="optional-panel">
                    <div class="optional-header">
                        <h4>Optional Fields</h4>
                        <div class="search-box"><input type="text" id="fieldSearch" placeholder="Search..."></div>
                    </div>
                    <div class="category-tabs" id="categoryTabs"></div>
                    <div class="fields-grid" id="fieldsGrid"></div>
                    <div class="selected-fields" id="selectedFields"></div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-secondary" id="backBtn1">‚Üê Back</button>
                    <button class="btn btn-primary" id="previewBtn">Preview ‚Üí</button>
                </div>
            </div>
        </div>
        <div class="section" id="section3">
            <div class="card">
                <div class="preview-header">
                    <div style="display:flex;align-items:center;gap:.2rem">
                        <h2 class="card-title">CSV Preview</h2>
                        <span class="row-count" id="previewCount">0</span>
                    </div>
                    <button class="btn btn-success" id="downloadBtn">‚¨á Download</button>
                </div>
                <div class="table-wrapper" style="margin-top:.3rem">
                    <div class="table-scroll" style="max-height:240px">
                        <table><thead id="previewHead"></thead><tbody id="previewBody"></tbody></table>
                    </div>
                </div>
                <div class="btn-row"><button class="btn btn-secondary" id="backBtn2">‚Üê Back</button></div>
            </div>
        </div>
        <footer>
            <div style="margin-bottom:.35rem">‚úàÔ∏è FlightLog Converter v9.0</div>
            <div>üîí All data processed locally in your browser ‚Ä¢ <a href="https://myflightbook.com/logbook/mvc/pub/ImportTable" target="_blank">MyFlightBook Docs</a></div>
        </footer>
    </div>
<script>
const VERSION='9.0';
const STORAGE_KEY='flightlog_prefs_v9';

// Undo stack
const undoStack = [];
const MAX_UNDO = 50;
function saveUndo(){
    undoStack.push(JSON.stringify(flights.map(f=>({...f,opt:{...f.opt}}))));
    if(undoStack.length > MAX_UNDO) undoStack.shift();
}
function doUndo(){
    if(!undoStack.length){showStatus('Nothing to undo','warning');return}
    const scrollTop=tableScroll?tableScroll.scrollTop:0;
    const scrollLeft=tableScroll?tableScroll.scrollLeft:0;
    const prev = JSON.parse(undoStack.pop());
    flights = prev;
    renderTable();
    if(tableScroll){tableScroll.scrollTop=scrollTop;tableScroll.scrollLeft=scrollLeft}
    showStatus('Undone','success');
}

const MODEL_MAP={'l319':'A320','l-319':'A320','l 319':'A320','l320':'A320','l-320':'A320','l 320':'A320','l321':'A320','l-321':'A320','l 321':'A320','a319':'A320','a320':'A320','a321':'A320','319':'A320','320':'A320','321':'A320','l330':'A330','l-330':'A330','l 330':'A330','a330':'A330','330':'A330','l350':'A350','l-350':'A350','l 350':'A350','a350':'A350','350':'A350','b737':'B737','b-737':'B737','737':'B737','737max':'B737','7m8':'B737','7m9':'B737','b777':'B777','777':'B777','77l':'B777','77w':'B777','b787':'B787','787':'B787','788':'B787','789':'B787','e175':'E175','e190':'E190','crj':'CRJ','q400':'Q400'};
function normalizeModel(t){if(!t)return'';const n=t.toLowerCase().replace(/[\s\-]+/g,'');if(MODEL_MAP[n])return MODEL_MAP[n];for(const[k,v]of Object.entries(MODEL_MAP))if(n.includes(k)||k.includes(n))return v;return{model:t.trim().toUpperCase(),unmapped:true}}

const CATS={
'Time':[
    {k:'X-Country',l:'X-Country',t:'Number'},
    {k:'IMC',l:'IMC',t:'Number'},
    {k:'Simulated Instrument',l:'Sim Inst',t:'Number'},
    {k:'Dual Received',l:'Dual Rcvd',t:'Number'},
    {k:'CFI',l:'CFI',t:'Number'},
    {k:'Ground Simulator',l:'Ground Sim',t:'Number'},
    {k:'Pilot Flying Time',l:'PF Time',t:'Number'},
    {k:'Pilot Monitoring Time',l:'PM Time',t:'Number'},
    {k:'Multi-Pilot Time',l:'Multi-Pilot',t:'Number'},
    {k:'Solo Time',l:'Solo',t:'Number'},
    {k:'Relief Pilot Time',l:'Relief Time',t:'Number'},
    {k:'Night Cross-country Time',l:'Night XC',t:'Number'},
    {k:'Right Seat Time',l:'R Seat Time',t:'Number'},
    {k:'Turbine Time',l:'Turbine',t:'Number'},
    {k:'Jet Time',l:'Jet',t:'Number'},
    {k:'Acting PIC Time',l:'Acting PIC',t:'Number'}
],
'Landings':[
    {k:'FS Day Landings',l:'FS Day',t:'Number'},
    {k:'FS Night Landings',l:'FS Night',t:'Number'},
    {k:'Landings - Touch and Go',l:'Touch&Go',t:'Number'},
    {k:'Landings - Autoland',l:'Autoland',t:'Number'},
    {k:'Go-arounds',l:'Go-around',t:'Number'},
    {k:'Takeoffs - Night',l:'Night TO',t:'Number'},
    {k:'Landings - Night, towered Airport',l:'Night Twr',t:'Number'},
    {k:'Landings - Night, Non-towered airport',l:'Night Non-Twr',t:'Number'},
    {k:'Landings - Cross-wind',l:'Crosswind',t:'Number'}
],
'Approaches':[
    {k:'Approaches',l:'Approaches',t:'Number'},
    {k:'Hold',l:'Hold',t:'Yes/No'},
    {k:'Approaches - ILS',l:'ILS',t:'Number'},
    {k:'Approaches - GPS/LPV',l:'GPS/LPV',t:'Number'},
    {k:'Approaches - RNAV/GPS',l:'RNAV',t:'Number'},
    {k:'Approaches - VOR',l:'VOR',t:'Number'},
    {k:'Approaches - Visual',l:'Visual',t:'Number'},
    {k:'Approaches - Localizer',l:'LOC',t:'Number'},
    {k:'Approaches - Category I',l:'CAT I',t:'Number'},
    {k:'Approaches - Category II',l:'CAT II',t:'Number'},
    {k:'Approaches - Category III',l:'CAT III',t:'Number'},
    {k:'Missed Approaches',l:'Missed',t:'Number'}
],
'Personnel':[
    {k:'Instructor Name',l:'Instructor',t:'Text'},
    {k:'Safety-Pilot Name',l:'Safety Pilot',t:'Text'},
    {k:'Pilot Flying (Name)',l:'PF Name',t:'Text'},
    {k:'Pilot Monitoring (Name)',l:'PM Name',t:'Text'},
    {k:'Captain Name',l:'Captain',t:'Text'},
    {k:'First Officer Name',l:'First Officer',t:'Text'},
    {k:'Relief Crew Name(s)',l:'Relief Crew',t:'Text'},
    {k:'Flight Attendant Name(s)',l:'F/As',t:'Text'},
    {k:'Student Name',l:'Student',t:'Text'},
    {k:'Examiner Name',l:'Examiner',t:'Text'}
],
'Aircraft':[
    {k:'Route',l:'Route',t:'Text'},
    {k:'Additional Flight Remarks',l:'Remarks',t:'Text'},
    {k:'Distance Flown',l:'Distance',t:'Number'},
    {k:'Maximum Altitude',l:'Max Alt',t:'Number'},
    {k:'Aircraft Registration',l:'Registration',t:'Text'},
    {k:'Fuel Added',l:'Fuel Added',t:'Number'},
    {k:'Fuel Consumed',l:'Fuel Used',t:'Number'}
],
'Training':[
    {k:'ltc',l:'LTC',t:'cb',desc:'Line Training Captain'},
    {k:'Flight Review',l:'Flt Review',t:'Yes/No'},
    {k:'Instrument Proficiency Check (IPC) Received',l:'IPC',t:'Yes/No'},
    {k:'Line Check Flight',l:'Line Check',t:'Yes/No'},
    {k:'Line Training Flight',l:'Line Trng',t:'Yes/No'},
    {k:'Line Training Captain (LTC) Time',l:'LTC Time',t:'Number'},
    {k:'Line Check Airman (LCA) Time',l:'LCA Time',t:'Number'},
    {k:'Base Check/Check-Out',l:'Base Check',t:'Yes/No'},
    {k:'Checkride - ATP',l:'ATP Checkride',t:'Yes/No'},
    {k:'Checkride - Commercial',l:'Comm Checkride',t:'Yes/No'},
    {k:'Checkride - Instrument',l:'Inst Checkride',t:'Yes/No'},
    {k:'PIC Proficiency Check (FAR 61.58)',l:'61.58 Check',t:'Yes/No'},
    {k:'Initial Operating Experience Flight',l:'IOE',t:'Yes/No'}
],
'Operations':[
    {k:'International Flight',l:'Int\'l',t:'Yes/No'},
    {k:'Deadhead',l:'Deadhead',t:'Yes/No'},
    {k:'Diversion',l:'Diversion',t:'Yes/No'},
    {k:'Ferry Flight',l:'Ferry',t:'Yes/No'},
    {k:'Rejected Takeoff',l:'RTO',t:'Yes/No'},
    {k:'V1 Cut',l:'V1 Cut',t:'Yes/No'},
    {k:'Trans-Atlantic Flight',l:'Trans-Atl',t:'Yes/No'},
    {k:'Trans-Pacific Flight',l:'Trans-Pac',t:'Yes/No'},
    {k:'Oceanic Flight',l:'Oceanic',t:'Yes/No'},
    {k:'Revenue Flight',l:'Revenue',t:'Yes/No'},
    {k:'Repositioning Flight',l:'Repo',t:'Yes/No'}
],
'Regs':[
    {k:'Part 91 Flight',l:'Pt 91',t:'Yes/No'},
    {k:'Part 121 Flight',l:'Pt 121',t:'Yes/No'},
    {k:'Part 135 Flight',l:'Pt 135',t:'Yes/No'},
    {k:'Part 705 Flight',l:'Pt 705',t:'Yes/No'},
    {k:'Part 704 Flight',l:'Pt 704',t:'Yes/No'},
    {k:'Part 121 Check Flight',l:'121 Check',t:'Yes/No'},
    {k:'Part 135.293 Competency Check',l:'135.293',t:'Yes/No'},
    {k:'Part 135.297 Instrument Proficiency Check',l:'135.297 IPC',t:'Yes/No'}
],
'Duty':[
    {k:'Block Out Time',l:'Blk Out',t:'DateTime'},
    {k:'Block In Time',l:'Blk In',t:'DateTime'},
    {k:'Pay Time',l:'Pay',t:'Number'},
    {k:'Flight Duty Period Start (UTC)',l:'FDP Start',t:'DateTime'},
    {k:'Flight Duty Period End (UTC)',l:'FDP End',t:'DateTime'},
    {k:'Duty Time Start (UTC)',l:'Duty Start',t:'DateTime'},
    {k:'Duty Time End (UTC)',l:'Duty End',t:'DateTime'},
    {k:'RON (Remain Over Night)',l:'RON',t:'Number'}
]
};

// Base columns - PIC, SIC names derived; Comments always last
// Column order matches export CSV order
const BASE_COLS=[
{k:'Date',l:'Date',t:'date',deletable:false},
{k:'Tail Number',l:'Tail#',t:'text',deletable:true},
{k:'Model',l:'Model',t:'text',deletable:true},
{k:'Total Flight Time',l:'Total',t:'num',isTime:true,deletable:false},
{k:'From',l:'From',t:'text',deletable:false},
{k:'To',l:'To',t:'text',deletable:false},
{k:'role',l:'Role',t:'toggle',deletable:false},
{k:'picName',l:'PIC Name',t:'text',deletable:true},
{k:'sicName',l:'SIC Name',t:'text',deletable:true},
{k:'otherCrew',l:'Other Crew',t:'text',deletable:true},
{k:'IFR Time',l:'IFR',t:'num',deletable:true},
{k:'Day Flight',l:'Day',t:'num',isTime:true,deletable:true},
{k:'Night',l:'Night',t:'num',isTime:true,deletable:true},
{k:'rightSeat',l:'RSeat',t:'cb',deletable:true},
{k:'Takeoffs (any)',l:'T/O',t:'cb',deletable:true},
{k:'Landings',l:'Ldg',t:'num',deletable:true},
{k:'ETOPS Flight',l:'ETOPS',t:'yn',deletable:true},
{k:'Employer Name',l:'Employer',t:'text',deletable:true},
{k:'Nose Number',l:'Nose#',t:'text',deletable:true},
{k:'flightNumber',l:'Flt#',t:'text',deletable:true}
];

let files=[],rawFlights=[],flights=[],optFields=[],activeCat='Time',showSelf=true,csvData=[],customLabels={};
let detectedPilot='',pilotCounts={},entryMode='upload',hiddenCols=new Set();
let selectedCell={row:-1,col:-1},currentEdit=null,myName='';

const $=id=>document.getElementById(id);
const uploadZone=$('uploadZone'),fileInput=$('fileInput'),fileList=$('fileList'),
pilotDetection=$('pilotDetection'),pilotNameInput=$('pilotName'),pilotNameManual=$('pilotNameManual'),detectedInfo=$('detectedInfo'),
statusMsg=$('statusMessage'),employer=$('employer'),selfToggle=$('selfToggle'),
processBtn=$('processBtn'),manualStartBtn=$('manualStartBtn'),
flightsHead=$('flightsHead'),flightsBody=$('flightsBody'),flightCount=$('flightCount'),
dupCount=$('dupCount'),errCount=$('errCount'),rpCount=$('rpCount'),statsRow=$('statsRow'),
categoryTabs=$('categoryTabs'),fieldsGrid=$('fieldsGrid'),tableScroll=$('tableScroll'),
selectedFields=$('selectedFields'),fieldSearch=$('fieldSearch'),previewHead=$('previewHead'),
previewBody=$('previewBody'),previewCount=$('previewCount'),
uploadSection=$('uploadSection'),manualSection=$('manualSection'),
modeToggle=$('modeToggle'),colDropdown=$('colDropdown'),colDropdownBtn=$('colDropdownBtn'),colDropdownContent=$('colDropdownContent'),
themeToggle=$('themeToggle');

// Theme handling
let currentTheme='dark';
function setTheme(theme){
    currentTheme=theme;
    document.documentElement.setAttribute('data-theme',theme);
    themeToggle.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.theme===theme));
    // Update meta theme-color for mobile browsers
    document.querySelector('meta[name="theme-color"]').content=theme==='dark'?'#0a0f1a':'#f1f5f9';
    try{localStorage.setItem('flightlog_theme',theme)}catch(e){}
}
function loadTheme(){
    try{
        const saved=localStorage.getItem('flightlog_theme');
        // Default to system preference if no saved preference
        if(saved){setTheme(saved)}
        else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches){setTheme('light')}
    }catch(e){}
}
themeToggle.addEventListener('click',e=>{
    const btn=e.target.closest('button');
    if(btn&&btn.dataset.theme)setTheme(btn.dataset.theme);
});
loadTheme();

function loadPrefs(){
    try{
        const p=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
        if(p.employer)employer.value=p.employer;
        if(p.showSelf!==undefined){showSelf=p.showSelf;selfToggle.classList.toggle('active',!showSelf)}
        if(p.hiddenCols)hiddenCols=new Set(p.hiddenCols);
        if(p.optFields)optFields=p.optFields;
        if(p.customLabels)customLabels=p.customLabels;
    }catch(e){}
}
function savePrefs(){
    try{localStorage.setItem(STORAGE_KEY,JSON.stringify({employer:employer.value,showSelf,hiddenCols:[...hiddenCols],optFields,customLabels}))}catch(e){}
}

modeToggle.addEventListener('click',e=>{
    const btn=e.target.closest('button');if(!btn)return;
    entryMode=btn.dataset.mode;
    modeToggle.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.mode===entryMode));
    uploadSection.classList.toggle('hidden',entryMode==='manual');
    manualSection.classList.toggle('hidden',entryMode==='upload');
    processBtn.classList.toggle('hidden',entryMode==='manual');
    manualStartBtn.classList.toggle('hidden',entryMode==='upload');
});

employer.addEventListener('change',savePrefs);
// Toggle: active (right/blue) = show full Name, inactive (left) = show Self
selfToggle.addEventListener('click',()=>{showSelf=!showSelf;selfToggle.classList.toggle('active',!showSelf);savePrefs();if(flights.length)renderTable()});

uploadZone.addEventListener('click',e=>{if(e.target!==fileInput)fileInput.click()});
uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.classList.add('dragover')});
uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.classList.remove('dragover');handleFiles(e.dataTransfer.files)});
fileInput.addEventListener('change',e=>handleFiles(e.target.files));

processBtn.addEventListener('click',()=>{
    processBtn.classList.add('loading');
    processBtn.disabled=true;
    setTimeout(()=>{
        processAllFiles();
        processBtn.classList.remove('loading');
        processBtn.disabled=false;
    },100);
});
manualStartBtn.addEventListener('click',startManualEntry);
$('addBtn').addEventListener('click',addNewRow);
$('clearAllBtn').addEventListener('click',clearAllFlights);
function addNewRow(){
    flights.push(createEmptyFlight());
    const newRowIdx=flights.length-1;
    selectedCell={row:newRowIdx,col:0};
    renderTable();
    // Scroll to new row and start editing
    setTimeout(()=>{
        const tr=flightsBody.children[newRowIdx];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
        const cols=getVisibleCols();
        activateCell(newRowIdx,cols[0]);
    },30);
}
function fillColumn(){
    if(selectedCell.row<0||selectedCell.col<0)return;
    const cols=getVisibleCols();
    const col=cols[selectedCell.col];
    if(!col||col.t==='toggle')return;// Can't fill role toggle this way
    const srcFlight=flights[selectedCell.row];
    const val=col.isOpt?(srcFlight.opt[col.k]||''):(srcFlight[col.k]||'');
    if(!val){showStatus('Select a cell with a value first','warning');return}
    saveUndo();
    flights.forEach(f=>{
        if(col.isOpt)f.opt[col.k]=val;
        else if(col.t==='cb')f[col.k]=srcFlight[col.k];
        else if(col.t==='yn')f[col.k]=val;
        else f[col.k]=val;
    });
    showStatus(`Filled ${flights.length} rows with "${val}"`,'success');
    renderTable();
}
function scrollToCell(row,col){
    setTimeout(()=>{
        const tr=flightsBody.children[row];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
    },10);
}
$('allPicBtn').addEventListener('click',()=>{flights.forEach(f=>{f.role='PIC';f.assumedRP=false;updatePilotNames(f)});renderTable()});
$('allSicBtn').addEventListener('click',()=>{flights.forEach(f=>{f.role='SIC';f.assumedRP=false;updatePilotNames(f)});renderTable()});
$('allRpBtn').addEventListener('click',()=>{flights.forEach(f=>{f.role='RP';f.assumedRP=false;updatePilotNames(f)});renderTable()});
$('confirmRpBtn').addEventListener('click',()=>{flights.forEach(f=>{if(f.assumedRP)f.assumedRP=false});renderTable();showStatus('All assumed RP flights confirmed.','success')});
$('backBtn1').addEventListener('click',()=>goToStep(1));
$('previewBtn').addEventListener('click',generatePreview);
$('backBtn2').addEventListener('click',()=>goToStep(2));
$('downloadBtn').addEventListener('click',downloadCSV);
fieldSearch.addEventListener('input',renderFieldsGrid);

colDropdownBtn.addEventListener('click',e=>{e.stopPropagation();colDropdown.classList.toggle('open');renderColDropdown()});
document.addEventListener('click',()=>colDropdown.classList.remove('open'));

// Global keyboard shortcuts
document.addEventListener('keydown',e=>{
    const inInput=document.activeElement.tagName==='INPUT'&&document.activeElement.type!=='checkbox';
    const cols=getVisibleCols();
    
    // Ctrl+Z: Undo
    if(e.ctrlKey&&e.key==='z'&&!e.shiftKey){
        e.preventDefault();
        doUndo();
        return;
    }
    
    // Ctrl+N: Add new row
    if(e.ctrlKey&&e.key==='n'){
        e.preventDefault();
        addNewRow();
        return;
    }
    
    // Ctrl+Shift+F: Fill column with current cell value
    if(e.ctrlKey&&e.shiftKey&&(e.key==='F'||e.key==='f')&&selectedCell.row>=0){
        e.preventDefault();
        fillColumn();
        return;
    }
    
    // Ctrl+Delete or Ctrl+Backspace: Delete current row
    if(e.ctrlKey&&(e.key==='Delete'||e.key==='Backspace')&&selectedCell.row>=0&&!inInput){
        e.preventDefault();
        delFlight(selectedCell.row);
        return;
    }
    
    // Don't process other keys if in text input
    if(inInput)return;
    if(!flights.length)return;
    
    // F2 or Enter: Enter edit mode on selected cell
    if((e.key==='F2'||e.key==='Enter')&&selectedCell.row>=0&&!currentEdit){
        e.preventDefault();
        const col=cols[selectedCell.col];
        if(col)activateCell(selectedCell.row,col);
        return;
    }
    
    // Delete/Backspace: Clear current cell
    if((e.key==='Delete'||e.key==='Backspace')&&selectedCell.row>=0&&!currentEdit&&!e.ctrlKey){
        e.preventDefault();
        const col=cols[selectedCell.col];
        if(col&&!['toggle','cb','yn'].includes(col.t)){
            saveUndo();
            if(col.isOpt)flights[selectedCell.row].opt[col.k]='';
            else flights[selectedCell.row][col.k]='';
            const el=flightsBody.querySelector(`[data-i="${selectedCell.row}"][data-k="${col.k}"].editable`);
            if(el)el.textContent='\u00A0';
            updateStats();
        }
        return;
    }
    
    // Home: Go to first cell of row (Ctrl+Home = first cell of table)
    if(e.key==='Home'&&selectedCell.row>=0){
        e.preventDefault();
        const targetRow=e.ctrlKey?0:selectedCell.row;
        selectCell(targetRow,0);
        const tr=flightsBody.children[targetRow];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
        return;
    }
    
    // End: Go to last cell of row (Ctrl+End = last cell of table)
    if(e.key==='End'&&selectedCell.row>=0){
        e.preventDefault();
        const lastCol=cols.length-1;
        const targetRow=e.ctrlKey?flights.length-1:selectedCell.row;
        selectCell(targetRow,lastCol);
        const tr=flightsBody.children[targetRow];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
        return;
    }
    
    // Arrow key navigation
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)&&selectedCell.row>=0){
        e.preventDefault();
        let{row,col}=selectedCell;
        if(e.key==='ArrowUp'){row--;if(row<0)row=flights.length-1}
        else if(e.key==='ArrowDown'){row++;if(row>=flights.length)row=0}
        else if(e.key==='ArrowLeft'){col--;if(col<0){col=cols.length-1;row--;if(row<0)row=flights.length-1}}
        else if(e.key==='ArrowRight'){col++;if(col>=cols.length){col=0;row++;if(row>=flights.length)row=0}}
        selectCell(row,col);
        const tr=flightsBody.children[row];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
    }
});

flightsBody.addEventListener('click',e=>{
    const td=e.target.closest('td');
    if(!td||td.classList.contains('sticky-col'))return;
    const tr=td.closest('tr');if(!tr)return;
    const rowIdx=[...flightsBody.children].indexOf(tr);
    const colIdx=[...tr.children].indexOf(td)-1;
    if(rowIdx>=0&&colIdx>=0)selectCell(rowIdx,colIdx);
    
    const ed=e.target.closest('.editable');
    if(ed){const cols=getVisibleCols();activateCell(rowIdx,cols[colIdx])}
    const del=e.target.closest('.delete-btn');
    if(del)delFlight(parseInt(del.dataset.del));
    const rb=e.target.closest('.role-toggle button');
    if(rb){
        const i=parseInt(rb.dataset.i);
        flights[i].role=rb.dataset.r;
        flights[i].assumedRP=false; // User confirmed the role
        updatePilotNames(flights[i]);
        renderTable();
    }
});
flightsBody.addEventListener('change',e=>{
    if(e.target.classList.contains('flight-checkbox')){
        const i=parseInt(e.target.dataset.i),k=e.target.dataset.k,isOpt=e.target.dataset.opt==='1';
        if(isOpt){
            // For optional checkbox fields like ltc, store as boolean for special handling
            if(k==='ltc')flights[i].opt[k]=e.target.checked;
            else flights[i].opt[k]=e.target.checked?'Yes':'';
        }
        else if(k==='rightSeat'||k==='Takeoffs (any)')flights[i][k]=e.target.checked;
        else flights[i][k]=e.target.checked?'Yes':'';
        updateStats();
    }
});
flightsBody.addEventListener('keydown',e=>{
    const cb=e.target.closest('.flight-checkbox');
    const rb=e.target.closest('.role-toggle button');
    
    if(e.key==='Tab'&&(cb||rb)){
        e.preventDefault();
        const cols=getVisibleCols();
        let{row,col}=selectedCell;
        if(e.shiftKey){col--;if(col<0){col=cols.length-1;row--;if(row<0)row=flights.length-1}}
        else{col++;if(col>=cols.length){col=0;row++;if(row>=flights.length)row=0}}
        selectCell(row,col);
        const tr=flightsBody.children[row];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
        activateCell(row,cols[col]);
    }
    // Arrow keys for role toggle
    if(rb&&(e.key==='ArrowLeft'||e.key==='ArrowRight')){
        e.preventDefault();
        const i=parseInt(rb.dataset.i);
        const roles=['PIC','SIC','RP'];
        const curIdx=roles.indexOf(flights[i].role);
        const newIdx=e.key==='ArrowRight'?(curIdx+1)%3:(curIdx+2)%3;
        flights[i].role=roles[newIdx];
        flights[i].assumedRP=false; // User confirmed the role
        updatePilotNames(flights[i]);
        // Update just the role buttons and pilot name cells without full re-render
        const btns=flightsBody.querySelectorAll(`.role-toggle button[data-i="${i}"]`);
        btns.forEach(b=>b.classList.toggle('active',b.dataset.r===roles[newIdx]));
        // Re-focus
        const btn=flightsBody.querySelector(`.role-toggle button[data-i="${i}"][data-r="${roles[newIdx]}"]`);
        if(btn)btn.focus();
    }
});

flightsHead.addEventListener('click',e=>{
    const delBtn=e.target.closest('.col-delete');
    if(delBtn){
        const k=delBtn.dataset.k;
        hiddenCols.add(k);
        savePrefs();
        renderTable();
        return;
    }
    const headerLabel=e.target.closest('.header-label');
    if(headerLabel&&!headerLabel.querySelector('input')){
        const k=headerLabel.dataset.k;
        const col=getVisibleCols().find(c=>c.k===k);
        const currentLabel=customLabels[k]||col.l;
        const inp=document.createElement('input');
        inp.type='text';
        inp.value=currentLabel;
        inp.className='header-edit-input';
        inp.style.cssText='width:100%;font-size:inherit;font-weight:inherit;padding:0;border:1px solid var(--blue);background:var(--bg);color:inherit;border-radius:2px;text-align:center';
        headerLabel.innerHTML='';
        headerLabel.appendChild(inp);
        inp.focus();
        inp.select();
        const finish=(save)=>{
            if(save&&inp.value.trim()){
                if(inp.value.trim()!==col.l)customLabels[k]=inp.value.trim();
                else delete customLabels[k];
                savePrefs();
            }
            renderTable();
        };
        inp.addEventListener('blur',()=>finish(true));
        inp.addEventListener('keydown',ev=>{
            if(ev.key==='Enter'){ev.preventDefault();finish(true)}
            else if(ev.key==='Escape'){ev.preventDefault();finish(false)}
        });
    }
});

loadPrefs();initCatTabs();renderFieldsGrid();

function parseTimeToMinutes(t){if(!t)return 0;t=String(t).trim();const hm=t.match(/^(\d+):(\d+)$/);if(hm)return parseInt(hm[1])*60+parseInt(hm[2]);const d=parseFloat(t);return isNaN(d)?0:Math.round(d*60)}
function minutesToDisplay(m){return m?(m/60).toFixed(1):''}

function updatePilotNames(f){
    const self=showSelf?'Self':myName;
    if(f.role==='PIC'){
        f.picName=self;
        f.sicName=f.origOtherPilot||'';
        f.otherCrew=f.origOtherCrew||'';
    }else if(f.role==='SIC'){
        f.picName=f.origOtherPilot||'';
        f.sicName=self;
        f.otherCrew=f.origOtherCrew||'';
    }else{// RP
        f.picName=f.origPicName||'';
        f.sicName=f.origSicName||'';
        // User is other crew when RP
        // Don't duplicate if pilot is already listed in origOtherCrew
        if(f.origOtherCrew && f.origOtherCrew.trim()===myName){
            f.otherCrew=self; // Replace their name with Self display
        }else if(f.origOtherCrew){
            f.otherCrew=f.origOtherCrew+', '+self; // Add to existing crew
        }else{
            f.otherCrew=self; // No existing crew, just Self
        }
    }
}

function startManualEntry(){
    myName=pilotNameManual.value.trim();
    if(!myName){showStatus('Enter your name.','error');return}
    flights=[createEmptyFlight()];goToStep(2);renderTable();
}
function createEmptyFlight(){
    const f={sortDate:'',Date:'',flightNumber:'',From:'',To:'','Tail Number':'',Model:'',modelUnmapped:false,'Nose Number':'','Employer Name':employer.value,totalMinutes:0,dayMinutes:0,nightMinutes:0,'Total Flight Time':'','Day Flight':'','Night':'','IFR Time':'','Takeoffs (any)':false,'Landings':'','ETOPS Flight':'',role:'PIC',assumedRP:false,rightSeat:false,origPicName:'',origSicName:'',origOtherPilot:'',origOtherCrew:'',picName:'',sicName:'',otherCrew:'',Comments:'',isDup:false,hasTimeError:false,hasRoundingNotice:false,opt:{}};
    updatePilotNames(f);
    return f;
}

async function handleFiles(f){
    for(let x of f)if(!files.find(y=>y.name===x.name))files.push(x);
    renderFileList();rawFlights=[];pilotCounts={};
    for(let file of files){const c=await readFile(file);parseFileRaw(c)}
    let maxCount=0;detectedPilot='';
    for(let name in pilotCounts)if(pilotCounts[name]>maxCount){maxCount=pilotCounts[name];detectedPilot=name}
    if(detectedPilot){pilotDetection.classList.add('visible');pilotNameInput.value=detectedPilot;detectedInfo.textContent=`${maxCount}/${rawFlights.length} flights`}
    processBtn.disabled=!files.length;
    if(files.length)uploadZone.classList.add('has-file');
}
function renderFileList(){
    fileList.innerHTML=files.map((f,i)=>`<div class="file-item"><span>üìÑ ${f.name}</span><button data-idx="${i}">‚úï</button></div>`).join('');
    fileList.querySelectorAll('button').forEach(btn=>btn.onclick=e=>{
        files.splice(parseInt(e.target.dataset.idx),1);renderFileList();
        processBtn.disabled=!files.length;
        if(!files.length){uploadZone.classList.remove('has-file');pilotDetection.classList.remove('visible');rawFlights=[]}
    });
}
function readFile(f){return new Promise(r=>{const x=new FileReader();x.onload=e=>r(e.target.result);x.readAsText(f)})}
function parseFileRaw(c){
    const lines=c.split(/\r?\n/);let hdr=-1;
    for(let i=0;i<Math.min(10,lines.length);i++)if(lines[i].includes('Date')&&lines[i].includes('Type')){hdr=i;break}
    if(hdr===-1)return;
    for(let i=hdr+1;i<lines.length;i++){
        const ln=lines[i];if(!ln.trim())continue;
        const col=ln.split('\t');if(col.length<12)continue;
        const ds=col[0].trim();if(!ds||ds.toLowerCase().includes('total')||!/^[A-Za-z]{3}\s+\d{1,2}\s+\d{4}/.test(ds))continue;
        const pic=(col[5]||'').trim(),sic=(col[6]||'').trim(),crew=(col[7]||'').trim(),type=(col[1]||'').trim();
        if(pic)pilotCounts[pic]=(pilotCounts[pic]||0)+1;
        if(sic)pilotCounts[sic]=(pilotCounts[sic]||0)+1;
        if(crew)pilotCounts[crew]=(pilotCounts[crew]||0)+1;
        rawFlights.push({dateStr:ds,type,reg:(col[2]||'').trim(),fin:(col[3]||'').trim(),fltNum:(col[4]||'').trim(),picNameRaw:pic,sicNameRaw:sic,otherCrew:crew,from:(col[8]||'').trim(),to:(col[10]||'').trim(),ifrTime:(col[12]||'').trim(),dayTime:(col[14]||'').trim(),nightTime:(col[15]||'').trim(),takeoffFlag:(col[20]||'').trim().toUpperCase(),landingFlag:(col[21]||'').trim().toUpperCase(),rightSeatFlag:(col[22]||'').trim().toUpperCase(),etopsFlag:(col[23]||'').trim().toUpperCase()});
    }
}
function processAllFiles(){
    myName=pilotNameInput.value.trim();
    if(!myName){showStatus('Enter pilot name.','error');return}
    flights=[];
    rawFlights.forEach(rf=>{
        const dt=convDate(rf.dateStr);
        // Determine role: PIC > SIC > RP (in Other Crew) > Assumed RP (not listed)
        const iAmPic=rf.picNameRaw.trim()===myName;
        const iAmSic=rf.sicNameRaw.trim()===myName;
        const iAmOtherCrew=rf.otherCrew.trim()===myName;
        let role='RP',assumedRP=false;
        if(iAmPic)role='PIC';
        else if(iAmSic)role='SIC';
        else if(iAmOtherCrew)role='RP';
        else{role='RP';assumedRP=true;} // Not listed anywhere - assume RP

        const otherPilot=iAmPic?rf.sicNameRaw:rf.picNameRaw;
        const totalMins=parseTimeToMinutes(rf.ifrTime||rf.dayTime),dayMins=parseTimeToMinutes(rf.dayTime),nightMins=parseTimeToMinutes(rf.nightTime);
        const mr=normalizeModel(rf.type),model=typeof mr==='object'?mr.model:mr,unmapped=typeof mr==='object'&&mr.unmapped;

        const f={
            sortDate:dt,Date:dt,flightNumber:cleanFlt(rf.fltNum),From:rf.from,To:rf.to,
            'Tail Number':fmtTail(rf.reg),Model:model,modelUnmapped:unmapped,
            'Nose Number':extNose(rf.fin),'Employer Name':employer.value,
            totalMinutes:totalMins,dayMinutes:dayMins,nightMinutes:nightMins,
            'Total Flight Time':minutesToDisplay(totalMins),
            'Day Flight':minutesToDisplay(dayMins),'Night':minutesToDisplay(nightMins),
            'IFR Time':minutesToDisplay(parseTimeToMinutes(rf.ifrTime)),
            'Takeoffs (any)':rf.takeoffFlag==='Y','Landings':rf.landingFlag==='Y'?1:'',
            'ETOPS Flight':rf.etopsFlag==='Y'?'Yes':'',
            role:role,assumedRP:assumedRP,rightSeat:rf.rightSeatFlag==='Y',ltc:false,
            // Store originals for swapping
            origPicName:rf.picNameRaw,origSicName:rf.sicNameRaw,
            origOtherPilot:otherPilot,origOtherCrew:rf.otherCrew,
            picName:'',sicName:'',otherCrew:'',
            Comments:'',isDup:false,hasTimeError:false,hasRoundingNotice:false,opt:{}
        };
        updatePilotNames(f);
        flights.push(f);
    });
    if(!flights.length){showStatus('No flights found.','error');return}
    flights.sort((a,b)=>new Date(a.sortDate)-new Date(b.sortDate));
    detectDups();validateAllTimes();
    const hasAssumedRP=flights.some(f=>f.assumedRP);
    let msg=`Loaded ${flights.length} flights.`;
    if(hasAssumedRP)msg+=` ${flights.filter(f=>f.assumedRP).length} flight(s) marked as assumed RP - please verify.`;
    showStatus(msg,flights.some(f=>f.isDup||f.hasTimeError||f.assumedRP)?'warning':'success');
    setTimeout(()=>{goToStep(2);renderTable()},300);
}
function detectDups(){const m=new Map();flights.forEach(f=>{const k=f.Date+'_'+f.flightNumber+'_'+f.From+'_'+f.To;if(m.has(k)){f.isDup=true;m.get(k).isDup=true}else m.set(k,f)})}
function validateAllTimes(){flights.forEach(validateFlightTime)}
function validateFlightTime(f){
    const t=f.totalMinutes||0,d=f.dayMinutes||0,n=f.nightMinutes||0;
    f.hasTimeError=false;f.hasRoundingNotice=false;
    if(!t&&!d&&!n)return;
    const diff=Math.abs(t-(d+n));
    if(diff===0)return;
    if(diff<=1){const dt=parseFloat(f['Total Flight Time'])||0,dd=parseFloat(f['Day Flight'])||0,dn=parseFloat(f['Night'])||0;if(Math.abs(dt-Math.round((dd+dn)*10)/10)>0.05)f.hasRoundingNotice=true}
    else f.hasTimeError=true;
}
function autoCalcTime(f,field){
    if(field==='Total Flight Time')f.totalMinutes=parseTimeToMinutes(f['Total Flight Time']);
    else if(field==='Day Flight')f.dayMinutes=parseTimeToMinutes(f['Day Flight']);
    else if(field==='Night')f.nightMinutes=parseTimeToMinutes(f['Night']);
    const t=f.totalMinutes||0,d=f.dayMinutes||0,n=f.nightMinutes||0;
    if(field==='Day Flight'||field==='Night'){f.totalMinutes=d+n;f['Total Flight Time']=minutesToDisplay(d+n)}
    else if(field==='Total Flight Time'){
        if(t>0&&d>0&&!n){f.nightMinutes=Math.max(0,t-d);f['Night']=minutesToDisplay(f.nightMinutes)}
        else if(t>0&&n>0&&!d){f.dayMinutes=Math.max(0,t-n);f['Day Flight']=minutesToDisplay(f.dayMinutes)}
    }
    validateFlightTime(f);
}

function getVisibleCols(){
    // Filter hidden, add optFields, then Comments last
    let cols=BASE_COLS.filter(c=>!hiddenCols.has(c.k));
    optFields.forEach(k=>{const f=findF(k);if(f&&!hiddenCols.has(k))cols.push({k:f.k,l:f.l,t:f.t,isOpt:true,deletable:true})});
    cols.push({k:'Comments',l:'Comments',t:'text',deletable:true});
    return cols;
}

function getAllColKeys(){
    // All possible columns for dropdown
    const all=[...BASE_COLS.map(c=>({k:c.k,l:c.l}))];
    optFields.forEach(k=>{const f=findF(k);if(f)all.push({k:f.k,l:f.l})});
    all.push({k:'Comments',l:'Comments'});
    return all;
}

function renderColDropdown(){
    const all=getAllColKeys();
    colDropdownContent.innerHTML=all.map(c=>`<label class="dropdown-item"><input type="checkbox" data-k="${c.k}" ${hiddenCols.has(c.k)?'':'checked'}> ${c.l}</label>`).join('');
    colDropdownContent.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('change',e=>{
            const k=e.target.dataset.k;
            if(e.target.checked)hiddenCols.delete(k);
            else hiddenCols.add(k);
            savePrefs();renderTable();
        });
    });
}

function selectCell(row,col){
    selectedCell={row,col};
    flightsBody.querySelectorAll('td.selected-cell').forEach(td=>td.classList.remove('selected-cell'));
    const tr=flightsBody.children[row];
    if(tr){
        const td=tr.children[col+1];// +1 for sticky # col
        if(td)td.classList.add('selected-cell');
    }
}

function activateCell(row,col){
    const f=flights[row];if(!f)return;
    const k=col.k,t=col.t;
    if(t==='cb'||t==='yn'){
        // Just focus checkbox, don't toggle it - user can press Space to toggle
        const cb=flightsBody.querySelector(`input[data-i="${row}"][data-k="${k}"]`);
        if(cb)cb.focus();
    }else if(t==='toggle'){
        // Focus first button of role toggle
        const btn=flightsBody.querySelector(`.role-toggle button[data-i="${row}"]`);
        if(btn)btn.focus();
    }else{
        // Text, number, date fields - enter edit mode
        const el=flightsBody.querySelector(`[data-i="${row}"][data-k="${k}"].editable`);
        if(el)startEdit(el,row,k,t,col.isOpt);
    }
}

function renderTable(){
    const cols=getVisibleCols();
    let h='<tr><th class="sticky-col">#</th>';
    cols.forEach(c=>{
        const del=c.deletable!==false?`<button class="col-delete" data-k="${c.k}">√ó</button>`:'';
        const label=customLabels[c.k]||c.l;
        h+=`<th class="${['cb','toggle','yn'].includes(c.t)?'center':''}"><span class="header-label" data-k="${c.k}" title="Click to edit">${label}</span>${del}</th>`;
    });
    h+='<th></th></tr>';flightsHead.innerHTML=h;
    
    let b='';
    flights.forEach((f,i)=>{
        // Update pilot names in case showSelf changed
        updatePilotNames(f);
        let cls=f.hasTimeError?'time-error':f.hasRoundingNotice?'rounding-notice':f.isDup?'duplicate':f.assumedRP?'assumed-rp':'';
        b+=`<tr class="${cls}"><td class="sticky-col">`;
        if(f.hasTimeError)b+='<span class="badge err-badge">ERR</span>';
        else if(f.hasRoundingNotice)b+='<span class="badge info-badge">~</span>';
        else if(f.isDup)b+='<span class="badge dup-badge">DUP</span>';
        else if(f.assumedRP)b+='<span class="badge rp-badge" title="Not listed as PIC/SIC/Other Crew - assumed Relief Pilot">RP?</span>';
        b+=`${i+1}</td>`;
        cols.forEach((c,ci)=>{
            const isSelected=selectedCell.row===i&&selectedCell.col===ci;
            b+=renderCell(f,c,i,isSelected);
        });
        b+=`<td><button class="delete-btn" data-del="${i}">üóë</button></td></tr>`;
    });
    flightsBody.innerHTML=b;
    flightCount.textContent=flights.length;
    const dc=flights.filter(x=>x.isDup).length,ec=flights.filter(x=>x.hasTimeError).length,rc=flights.filter(x=>x.assumedRP).length;
    dupCount.style.display=dc?'inline':'none';dupCount.textContent=dc+' dup';
    errCount.style.display=ec?'inline':'none';errCount.textContent=ec+' err';
    rpCount.style.display=rc?'inline':'none';rpCount.textContent=rc+' RP?';
    $('confirmRpBtn').style.display=rc?'inline-block':'none';
    updateStats();renderSelFields();
}

function renderCell(f,c,i,isSelected){
    const v=c.isOpt?(f.opt[c.k]||''):f[c.k];
    const selClass=isSelected?' selected-cell':'';
    if(c.t==='cb')return `<td class="center${selClass}"><input type="checkbox" class="flight-checkbox" data-i="${i}" data-k="${c.k}" ${c.isOpt?'data-opt="1"':''} ${v?'checked':''}></td>`;
    if(c.t==='yn')return `<td class="center${selClass}"><input type="checkbox" class="flight-checkbox" data-i="${i}" data-k="${c.k}" ${c.isOpt?'data-opt="1"':''} ${v==='Yes'?'checked':''}></td>`;
    if(c.t==='toggle')return `<td class="center${selClass}"><div class="role-toggle"><button data-i="${i}" data-r="PIC" data-k="role" class="${f.role==='PIC'?'active':''}">PIC</button><button data-i="${i}" data-r="SIC" data-k="role" class="${f.role==='SIC'?'active':''}">SIC</button><button data-i="${i}" data-r="RP" data-k="role" class="${f.role==='RP'?'active':''}">RP</button></div></td>`;
    
    let cls=c.isTime?'cell-time time-cell':['From','To'].includes(c.k)?'cell-route':['picName','sicName','otherCrew'].includes(c.k)?'cell-pilot':c.k==='Model'?'cell-model':'';
    let extra=c.k==='Model'&&f.modelUnmapped?'<span class="badge unmapped-badge">?</span>':'';
    const optAttr=c.isOpt?'data-opt="1"':'data-opt="0"';
    return `<td class="${cls}${selClass}"><span class="editable" data-i="${i}" data-k="${c.k}" data-t="${c.t}" ${optAttr}>${v||'&nbsp;'}</span>${extra}</td>`;
}

function startEdit(el,i,k,t,isOpt){
    if(currentEdit)finishEdit(true);
    currentEdit={el,i,k,t,isOpt};
    const cur=isOpt?(flights[i].opt[k]||''):(flights[i][k]||'');
    const inp=document.createElement('input');
    if(t==='num'||t==='Number'){inp.type='number';inp.step='0.1';inp.min='0'}
    else if(t==='DateTime')inp.type='datetime-local';
    else if(t==='date'){inp.type='date';if(cur){const p=cur.split('/');if(p.length===3)inp.value=p[2]+'-'+p[0].padStart(2,'0')+'-'+p[1].padStart(2,'0')}}
    else{inp.type='text';inp.value=cur}
    if(t!=='date')inp.value=cur;
    inp.className='edit-input';
    inp.addEventListener('blur',()=>setTimeout(()=>{if(currentEdit)finishEdit(true)},50));
    inp.addEventListener('keydown',e=>{
        if(e.key==='Enter'){e.preventDefault();finishEdit(true)}
        else if(e.key==='Escape'){e.preventDefault();finishEdit(false)}
        else if(e.key==='Tab'){
            e.preventDefault();
            const cols=getVisibleCols();
            let{row,col}=selectedCell;
            if(e.shiftKey){col--;if(col<0){col=cols.length-1;row--;if(row<0)row=flights.length-1}}
            else{col++;if(col>=cols.length){col=0;row++;if(row>=flights.length)row=0}}
            // Finish edit, then navigate
            finishEdit(true,()=>{
                selectCell(row,col);
                // Scroll the row into view
                const tr=flightsBody.children[row];
                if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
                activateCell(row,cols[col]);
            });
        }
        else if(e.key==='ArrowDown'||e.key==='ArrowUp'){
            e.preventDefault();
            let{row,col}=selectedCell;
            row+=e.key==='ArrowDown'?1:-1;
            if(row<0)row=flights.length-1;
            if(row>=flights.length)row=0;
            finishEdit(true,()=>{
                selectCell(row,col);
                const tr=flightsBody.children[row];
                if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
                const cols=getVisibleCols();
                activateCell(row,cols[col]);
            });
        }
    });
    el.style.display='none';el.parentNode.insertBefore(inp,el);inp.focus();if(t!=='date')inp.select();
}

function finishEdit(save,andThen){
    if(!currentEdit)return;
    const{el,i,k,t,isOpt}=currentEdit;
    const inp=el.parentNode.querySelector('.edit-input');
    if(save&&inp){
        let v=inp.value.trim();
        if((t==='num'||t==='Number')&&v)v=parseFloat(v)?parseFloat(v).toFixed(1):v;
        else if(t==='DateTime'&&v){const dt=new Date(v);if(!isNaN(dt))v=(dt.getMonth()+1)+'/'+dt.getDate()+'/'+dt.getFullYear()+' '+dt.getHours().toString().padStart(2,'0')+':'+dt.getMinutes().toString().padStart(2,'0')}
        else if(t==='date'&&v){const p=v.split('-');if(p.length===3)v=parseInt(p[1])+'/'+parseInt(p[2])+'/'+p[0]}
        // Save undo state before making changes
        const oldVal=isOpt?(flights[i].opt[k]||''):(flights[i][k]||'');
        if(v!==oldVal)saveUndo();
        if(isOpt)flights[i].opt[k]=v;
        else{flights[i][k]=v;if(['Total Flight Time','Day Flight','Night'].includes(k))autoCalcTime(flights[i],k)}
        // Update cell text in place without full re-render
        el.textContent=v||'\u00A0';
    }
    if(inp)inp.remove();
    el.style.display='';
    currentEdit=null;
    // Only do full render if we need to update stats/validation, otherwise skip
    if(save&&['Total Flight Time','Day Flight','Night'].includes(k)){
        const scrollTop=tableScroll.scrollTop;
        const scrollLeft=tableScroll.scrollLeft;
        renderTable();
        tableScroll.scrollTop=scrollTop;
        tableScroll.scrollLeft=scrollLeft;
    }else{
        updateStats();
    }
    if(andThen)andThen();
}

function delFlight(i){
    saveUndo();
    flights.splice(i,1);
    if(flights.length){
        detectDups();validateAllTimes();
        if(selectedCell.row>=flights.length)selectedCell.row=flights.length-1;
    }else{
        selectedCell={row:-1,col:-1};
    }
    renderTable();
}

function clearAllFlights(){
    if(!flights.length)return;
    if(!confirm('Delete all '+flights.length+' flights?'))return;
    saveUndo();
    flights=[];
    selectedCell={row:-1,col:-1};
    renderTable();
    showStatus('All flights cleared','success');
}

function initCatTabs(){
    categoryTabs.innerHTML=Object.keys(CATS).map(c=>`<div class="category-tab ${c===activeCat?'active':''}" data-cat="${c}">${c}</div>`).join('');
    categoryTabs.onclick=e=>{if(e.target.classList.contains('category-tab')){activeCat=e.target.dataset.cat;document.querySelectorAll('.category-tab').forEach(x=>x.classList.toggle('active',x.dataset.cat===activeCat));renderFieldsGrid()}}
}
function renderFieldsGrid(){
    const s=(fieldSearch.value||'').toLowerCase();
    let arr=CATS[activeCat]||[];
    if(s){arr=[];Object.values(CATS).forEach(fs=>fs.forEach(f=>{if(f.l.toLowerCase().includes(s)||f.k.toLowerCase().includes(s))arr.push(f)}))}
    fieldsGrid.innerHTML=arr.map(f=>`<div class="field-item ${optFields.includes(f.k)?'selected':''}" data-fk="${f.k}"><input type="checkbox" ${optFields.includes(f.k)?'checked':''}><span class="field-name">${f.l}</span><span class="field-type">${f.t}</span></div>`).join('');
    fieldsGrid.querySelectorAll('.field-item').forEach(fi=>fi.onclick=()=>{
        const k=fi.dataset.fk,idx=optFields.indexOf(k);
        if(idx>-1)optFields.splice(idx,1);else optFields.push(k);
        savePrefs();renderFieldsGrid();if(flights.length)renderTable();
    });
}
function renderSelFields(){
    if(!optFields.length){selectedFields.innerHTML='<span style="font-size:.5rem;color:var(--muted)">None</span>';return}
    selectedFields.innerHTML=optFields.map((k,idx)=>{
        const f=findF(k);
        const leftBtn=idx>0?`<button class="reorder-btn" data-dir="left" data-idx="${idx}">‚Üê</button>`:'';
        const rightBtn=idx<optFields.length-1?`<button class="reorder-btn" data-dir="right" data-idx="${idx}">‚Üí</button>`:'';
        return `<span class="selected-tag" data-k="${k}">${leftBtn}${f?f.l:k}${rightBtn}<button data-remove="${k}">‚úï</button></span>`;
    }).join('');
    selectedFields.querySelectorAll('[data-remove]').forEach(btn=>btn.onclick=e=>{
        optFields.splice(optFields.indexOf(e.target.dataset.remove),1);savePrefs();renderFieldsGrid();if(flights.length)renderTable();
    });
    selectedFields.querySelectorAll('.reorder-btn').forEach(btn=>btn.onclick=e=>{
        e.stopPropagation();
        const idx=parseInt(e.target.dataset.idx),dir=e.target.dataset.dir;
        if(dir==='left'&&idx>0)[optFields[idx-1],optFields[idx]]=[optFields[idx],optFields[idx-1]];
        else if(dir==='right'&&idx<optFields.length-1)[optFields[idx],optFields[idx+1]]=[optFields[idx+1],optFields[idx]];
        savePrefs();renderSelFields();if(flights.length)renderTable();
    });
}
function findF(k){for(let c of Object.values(CATS)){const f=c.find(x=>x.k===k);if(f)return f}return null}

function updateStats(){
    let tot=0,pic=0,sic=0,rp=0,day=0,ngt=0,to=0,ldg=0;
    flights.forEach(f=>{
        const t=parseFloat(f['Total Flight Time'])||0;tot+=t;
        if(f.role==='PIC')pic+=t;else if(f.role==='SIC')sic+=t;else if(f.role==='RP')rp+=t;
        day+=parseFloat(f['Day Flight'])||0;ngt+=parseFloat(f['Night'])||0;
        to+=f['Takeoffs (any)']?1:0;ldg+=parseInt(f['Landings'])||0;
    });
    statsRow.innerHTML=`<div class="stat-box"><div class="stat-label">Total</div><div class="stat-value">${tot.toFixed(1)}</div></div><div class="stat-box"><div class="stat-label">PIC</div><div class="stat-value">${pic.toFixed(1)}</div></div><div class="stat-box"><div class="stat-label">SIC</div><div class="stat-value">${sic.toFixed(1)}</div></div>${rp?`<div class="stat-box"><div class="stat-label">RP</div><div class="stat-value">${rp.toFixed(1)}</div></div>`:''}<div class="stat-box"><div class="stat-label">Day</div><div class="stat-value">${day.toFixed(1)}</div></div><div class="stat-box"><div class="stat-label">Night</div><div class="stat-value">${ngt.toFixed(1)}</div></div><div class="stat-box"><div class="stat-label">T/O</div><div class="stat-value">${to}</div></div><div class="stat-box"><div class="stat-label">Ldg</div><div class="stat-value">${ldg}</div></div>`;
}

function generatePreview(){
    if(!flights.length){showStatus('No flights to preview','error');return}
    const hasRP=flights.some(f=>f.role==='RP');
    const hasOtherCrew=flights.some(f=>f.otherCrew);
    const visibleCols=getVisibleCols().map(c=>c.k);

    csvData=flights.map(f=>{
        const t=f['Total Flight Time']||'';
        const isPIC=f.role==='PIC',isSIC=f.role==='SIC',isRP=f.role==='RP';
        const row={};

        // Column order matches BASE_COLS order
        if(visibleCols.includes('Date'))row['Date']=f.Date;
        if(visibleCols.includes('Tail Number'))row['Tail Number']=f['Tail Number'];
        if(visibleCols.includes('Model'))row['Model']=f.Model||'';
        row['Total Flight Time']=t;
        if(visibleCols.includes('From'))row['From']=f.From;
        if(visibleCols.includes('To'))row['To']=f.To;

        // PIC/SIC/RP time (derived from role)
        row['PIC']=isPIC?t:'';
        row['SIC']=isSIC?t:'';
        if(hasRP)row['Relief Pilot Time']=isRP?t:'';

        // Names
        if(visibleCols.includes('picName'))row['Name of PIC']=f.picName;
        if(visibleCols.includes('sicName'))row['Name of SIC']=f.sicName;
        if(visibleCols.includes('otherCrew')&&hasOtherCrew)row['Additional Crew Member(s)']=f.otherCrew;

        // Time fields
        if(visibleCols.includes('IFR Time'))row['IFR Time']=f['IFR Time'];
        if(visibleCols.includes('Day Flight'))row['Day Flight']=f['Day Flight'];
        if(visibleCols.includes('Night'))row['Night']=f['Night'];
        if(visibleCols.includes('rightSeat'))row['Right Seat Time']=f.rightSeat?t:'';

        // Counts
        if(visibleCols.includes('Takeoffs (any)'))row['Takeoffs (any)']=f['Takeoffs (any)']?1:'';
        if(visibleCols.includes('Landings'))row['Landings']=f['Landings']||'';

        // Operations
        if(visibleCols.includes('ETOPS Flight'))row['ETOPS Flight']=f['ETOPS Flight']||'';
        if(visibleCols.includes('Employer Name'))row['Employer Name']=f['Employer Name'];
        if(visibleCols.includes('Nose Number'))row['Nose Number']=f['Nose Number'];
        if(visibleCols.includes('flightNumber'))row['Flight Number']=f.flightNumber;

        // Optional fields
        optFields.forEach(k=>{
            if(!hiddenCols.has(k)){
                // Special handling for LTC - export as time when checked
                if(k==='ltc')row['Line Training Captain (LTC) Time']=f.opt[k]?t:'';
                else row[k]=f.opt[k]||'';
            }
        });

        // Comments always last
        if(visibleCols.includes('Comments'))row['Comments']=f.Comments||'';

        return row;
    });
    
    const hds=Object.keys(csvData[0]);
    previewHead.innerHTML='<tr>'+hds.map(h=>`<th>${h}</th>`).join('')+'</tr>';
    previewBody.innerHTML=csvData.map(r=>'<tr>'+hds.map(h=>{
        let v=r[h],s=v==='Self'?'color:var(--purple);font-weight:500':/^\d+\.?\d*$/.test(v)&&v?'color:var(--green)':v==='Yes'?'color:var(--blue)':'';
        return `<td style="${s}">${v}</td>`;
    }).join('')+'</tr>').join('');
    previewCount.textContent=csvData.length;goToStep(3);
}

function downloadCSV(){
    if(!csvData.length){showStatus('No data.','error');return}
    const hds=Object.keys(csvData[0]);
    const lines=[hds.join(','),...csvData.map(r=>hds.map(h=>{let v=r[h]??'';v=String(v);if(v.includes(',')||v.includes('"')||v.includes('\n'))v='"'+v.replace(/"/g,'""')+'"';return v}).join(','))];
    const blob=new Blob([lines.join('\r\n')],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='myflightbook_'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();URL.revokeObjectURL(a.href);
    const btn=$('downloadBtn');
    btn.classList.add('downloaded');
    btn.innerHTML='‚úì Downloaded!';
    showStatus('CSV file downloaded successfully!','success');
    setTimeout(()=>{btn.classList.remove('downloaded');btn.innerHTML='‚¨á Download'},2000);
}

function convDate(d){const m={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};const x=d.replace(/\s+/g,' ').trim().match(/([A-Za-z]{3})\s+(\d{1,2})\s+(\d{4})/);return x?m[x[1].toLowerCase()]+'/'+parseInt(x[2])+'/'+x[3]:d}
function fmtTail(r){r=r.replace(/-/g,'').trim().toUpperCase();return r.startsWith('C')&&r.length>1?'C-'+r.substring(1):r}
function extNose(f){const m=f.match(/\d+/);return m?m[0]:f}
function cleanFlt(f){return f.replace(/^#\s*/,'').trim()}
function goToStep(s){
    document.querySelectorAll('.step').forEach((e,i)=>{e.classList.remove('active','completed');if(i+1<s)e.classList.add('completed');if(i+1===s)e.classList.add('active')});
    document.querySelectorAll('.step-connector').forEach((e,i)=>{e.classList.toggle('done',i+1<s)});
    document.querySelectorAll('.section').forEach((e,i)=>{
        const sec=e;
        if(i+1===s){sec.classList.add('active');sec.style.animation='fadeIn .3s ease'}
        else{sec.classList.remove('active')}
    });
}
function showStatus(m,t){statusMsg.innerHTML=`<div class="status status-${t}">${m}</div>`;if(t==='success')setTimeout(()=>statusMsg.innerHTML='',3000)}
</script>
</body>
</html>
