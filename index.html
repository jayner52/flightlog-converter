<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlightLog Converter - Air Canada to MyFlightBook</title>
    <meta name="description" content="Convert Air Canada PQRM logbook exports to MyFlightBook CSV format. Free, private, runs entirely in your browser.">
    <meta property="og:title" content="FlightLog Converter">
    <meta property="og:description" content="Convert Air Canada PQRM exports to MyFlightBook format. Free & private - all processing happens in your browser.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230a0f1a' width='100' height='100'/><path fill='%233b82f6' d='M70 45l-20-12V20a5 5 0 00-10 0v13L20 45v8l20-6v15l-6 4v6l11-3 11 3v-6l-6-4V47l20 6v-8z'/></svg>">
    <meta name="twitter:card" content="summary">
    <meta name="theme-color" content="#0a0f1a">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%233b82f6'><path d='M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z'/></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root,html[data-theme="dark"]{--bg:#0b0f19;--bg2:#141922;--card:#1a1f2e;--hover:#242938;--red:#ef4444;--blue:#3b82f6;--green:#22c55e;--yellow:#eab308;--purple:#a855f7;--orange:#f97316;--cyan:#06b6d4;--text:#f1f5f9;--text2:#94a3b8;--muted:#64748b;--border:rgba(148,163,184,.12);--shadow:0 1px 3px rgba(0,0,0,.3);--primary:#3b82f6;--primary-hover:#2563eb}
        html[data-theme="light"]{--bg:#f8fafc;--bg2:#ffffff;--card:#ffffff;--hover:#f1f5f9;--red:#dc2626;--blue:#2563eb;--green:#16a34a;--yellow:#ca8a04;--purple:#9333ea;--orange:#ea580c;--cyan:#0891b2;--text:#0f172a;--text2:#475569;--muted:#64748b;--border:rgba(15,23,42,.08);--shadow:0 1px 3px rgba(0,0,0,.05);--primary:#2563eb;--primary-hover:#1d4ed8}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        @keyframes slideIn{from{opacity:0;transform:translateX(-8px)}to{opacity:1;transform:translateX(0)}}
        @keyframes spin{to{transform:rotate(360deg)}}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.5;font-size:13px;-webkit-font-smoothing:antialiased}
        .container{max-width:95vw;margin:0 auto;padding:1rem 1.5rem}
        @media(min-width:1800px){.container{max-width:1700px}}
        .icon{width:16px;height:16px;stroke:currentColor;stroke-width:2;fill:none;stroke-linecap:round;stroke-linejoin:round;flex-shrink:0}
        .icon-sm{width:14px;height:14px}
        .icon-lg{width:20px;height:20px}
        .icon-xl{width:32px;height:32px}
        header{text-align:center;margin-bottom:1rem;position:relative;padding:.75rem 0}
        .logo{display:inline-flex;align-items:center;justify-content:center;margin-bottom:.25rem}
        .logo svg{width:32px;height:32px;fill:var(--primary)}
        h1{font-size:1.35rem;font-weight:700;color:var(--text);letter-spacing:-0.02em}
        .subtitle{color:var(--muted);font-size:.8rem}
        .theme-toggle{position:absolute;top:0;right:0;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:2px;display:flex;gap:1px}
        .theme-toggle button{border:none;background:transparent;width:26px;height:26px;border-radius:4px;cursor:pointer;transition:all .15s;display:flex;align-items:center;justify-content:center;color:var(--muted)}
        .theme-toggle button:hover{background:var(--hover);color:var(--text)}
        .theme-toggle button.active{background:var(--primary);color:#fff}
        .theme-toggle button svg{width:14px;height:14px}
        .steps{display:flex;justify-content:center;align-items:center;gap:0;margin:1rem 0}
        .step{display:flex;align-items:center;gap:.4rem;padding:.5rem 1rem;background:var(--card);border:1px solid var(--border);color:var(--muted);font-size:.8rem;font-weight:500;transition:all .2s}
        .step:first-child{border-radius:6px 0 0 6px}.step:last-child{border-radius:0 6px 6px 0}
        .step.active{background:var(--primary);border-color:var(--primary);color:#fff}
        .step.completed{background:var(--green);border-color:var(--green);color:#fff}
        .step.completed .step-num svg{display:block}
        .step.completed .step-num span{display:none}
        .step-num{display:flex;align-items:center;justify-content:center;width:18px;height:18px;background:rgba(255,255,255,.15);border-radius:50%;font-size:.7rem;font-weight:600}
        .step-num svg{display:none;width:10px;height:10px}
        .step-connector{width:24px;height:2px;background:var(--border);transition:background .2s}
        .step-connector.done{background:var(--green)}
        .card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:1rem;margin-bottom:.5rem;box-shadow:var(--shadow)}
        .loading{position:relative;pointer-events:none;opacity:.6}
        .loading::after{content:'';position:absolute;top:50%;left:50%;width:18px;height:18px;margin:-9px 0 0 -9px;border:2px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .6s linear infinite}
        .btn.loading{color:transparent}
        .btn.loading::after{width:14px;height:14px;margin:-7px 0 0 -7px}
        .card-header{display:flex;align-items:center;gap:.4rem;margin-bottom:.5rem;padding-bottom:.4rem;border-bottom:1px solid var(--border);flex-wrap:wrap}
        .card-title{font-size:.85rem;font-weight:600;display:flex;align-items:center;gap:.35rem}
        .format-row{display:flex;gap:.75rem;flex-wrap:wrap;margin-bottom:.75rem}
        .format-group{flex:1;min-width:180px}
        .format-group label{display:block;font-size:.7rem;font-weight:600;color:var(--muted);margin-bottom:.3rem;text-transform:uppercase;letter-spacing:.04em}
        .format-group select{width:100%;padding:.45rem .6rem;background:var(--bg2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:.8rem;cursor:pointer;transition:border-color .15s}
        .format-group select:hover{border-color:var(--primary)}
        .mode-toggle{display:inline-flex;background:var(--bg2);border:1px solid var(--border);border-radius:5px;padding:2px;margin-bottom:.75rem}
        .mode-toggle button{padding:.4rem .75rem;border:none;background:transparent;color:var(--muted);font-size:.75rem;font-weight:500;border-radius:4px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:.3rem}
        .mode-toggle button.active{background:var(--primary);color:#fff}
        .mode-toggle button:hover:not(.active){color:var(--text);background:var(--hover)}
        .upload-zone{border:1px dashed var(--border);border-radius:8px;padding:1.5rem 1rem;text-align:center;cursor:pointer;transition:all .2s;background:var(--bg2)}
        .upload-zone:hover,.upload-zone.dragover{border-color:var(--primary);background:rgba(59,130,246,.04)}
        .upload-zone.has-file{border-color:var(--green);border-style:solid;background:rgba(34,197,94,.04)}
        .upload-icon{margin-bottom:.5rem;color:var(--muted);transition:color .2s}
        .upload-zone:hover .upload-icon{color:var(--primary)}
        .upload-icon svg{width:32px;height:32px}
        .upload-text{font-size:.85rem;color:var(--text);margin-bottom:.2rem;font-weight:500}.upload-hint{font-size:.75rem;color:var(--muted)}
        .file-input{display:none}
        .file-list{margin-top:.6rem;display:flex;flex-direction:column;gap:.25rem}
        .file-item{display:flex;align-items:center;justify-content:space-between;padding:.4rem .6rem;background:var(--bg2);border-radius:5px;font-size:.8rem;color:var(--green);border:1px solid rgba(34,197,94,.2);animation:slideIn .2s ease}
        .file-item .icon{margin-right:.35rem;width:14px;height:14px}
        .file-item button{background:none;border:none;color:var(--muted);cursor:pointer;padding:.2rem;border-radius:4px;transition:all .15s;display:flex}
        .file-item button:hover{color:var(--red);background:rgba(239,68,68,.1)}
        .pilot-detection{background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--purple);border-radius:6px;padding:.75rem;margin-top:.75rem;display:none}
        .pilot-detection.visible{display:block;animation:fadeIn .2s ease}
        .pilot-detection h4{color:var(--text);font-size:.8rem;font-weight:600;margin-bottom:.4rem;display:flex;align-items:center;gap:.35rem}
        .pilot-detection h4 .icon{color:var(--purple)}
        .pilot-detection .detected-info{font-size:.7rem;color:var(--muted);margin-top:.3rem}
        .pilot-detection input{width:180px;padding:.4rem .5rem;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:.8rem}
        .pilot-detection input:focus{border-color:var(--purple);outline:none}
        .instructions{background:var(--bg2);border-left:3px solid var(--muted);border-radius:6px;padding:.6rem .75rem;margin-top:.75rem}
        .instructions h4{color:var(--text);font-size:.75rem;font-weight:600;margin-bottom:.25rem;display:flex;align-items:center;gap:.3rem}
        .instructions h4 .icon{color:var(--muted)}
        .instructions p{color:var(--muted);line-height:1.4;font-size:.75rem}
        .settings-row{display:flex;gap:.75rem;flex-wrap:wrap;margin-top:.75rem;align-items:flex-end}
        .setting-group{min-width:120px}
        .setting-group.small{min-width:auto}
        label{display:block;font-size:.7rem;font-weight:600;color:var(--muted);margin-bottom:.25rem;text-transform:uppercase;letter-spacing:.04em}
        input[type="text"],input[type="date"],input[type="number"],input[type="datetime-local"],select{width:100%;padding:.4rem .5rem;background:var(--bg2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:.8rem;transition:border-color .15s}
        input:focus,select:focus{outline:none;border-color:var(--primary)}
        .toggle-group{display:flex;align-items:center;gap:.3rem}
        .toggle-label{font-size:.75rem;color:var(--muted)}
        .toggle{width:32px;height:18px;background:var(--bg2);border:1px solid var(--border);border-radius:9px;cursor:pointer;position:relative;transition:all .15s}
        .toggle.active{background:var(--primary);border-color:var(--primary)}
        .toggle::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;background:#fff;border-radius:50%;transition:transform .15s;box-shadow:0 1px 2px rgba(0,0,0,.2)}
        .toggle.active::after{transform:translateX(14px)}
        .btn{display:inline-flex;align-items:center;gap:.3rem;padding:.45rem .85rem;border-radius:5px;font-size:.8rem;font-weight:500;cursor:pointer;border:none;transition:all .15s}
        .btn-primary{background:var(--primary);color:#fff}.btn-primary:hover:not(:disabled){background:var(--primary-hover)}
        .btn-primary:disabled{opacity:.5;cursor:not-allowed}
        .btn-secondary{background:var(--bg2);color:var(--text);border:1px solid var(--border)}
        .btn-secondary:hover{border-color:var(--text2);background:var(--hover)}
        .btn-success{background:var(--green);color:#fff}.btn-success:hover{background:#059669}
        .btn-success.downloaded{background:#059669}
        .btn-small{padding:.25rem .5rem;font-size:.7rem}
        .btn-row{display:flex;gap:.5rem;margin-top:1.25rem;flex-wrap:wrap}
        .dropdown{position:relative;display:inline-block}
        .dropdown-content{display:none;position:absolute;top:100%;left:0;background:var(--card);border:1px solid var(--border);border-radius:8px;min-width:160px;z-index:50;max-height:250px;overflow-y:auto;margin-top:4px;box-shadow:var(--shadow)}
        .dropdown.open .dropdown-content{display:block}
        .dropdown-item{padding:.5rem .75rem;font-size:.85rem;cursor:pointer;display:flex;align-items:center;gap:.5rem;transition:background .15s}
        .dropdown-item:hover{background:var(--hover)}
        .dropdown-item input{width:14px;height:14px}
        .table-wrapper{position:relative;margin-top:.5rem;border:1px solid var(--border);border-radius:8px;overflow:hidden}
        .table-wrapper::after{content:'';position:absolute;top:0;right:0;bottom:8px;width:20px;background:linear-gradient(to right,transparent,var(--card));pointer-events:none;opacity:.8;z-index:15}
        .table-scroll{max-height:450px;overflow:auto;-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
        .table-scroll::-webkit-scrollbar{height:8px;width:8px}
        .table-scroll::-webkit-scrollbar-track{background:var(--bg2)}
        .table-scroll::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
        .table-scroll::-webkit-scrollbar-thumb:hover{background:var(--muted)}
        table{width:100%;border-collapse:collapse;font-size:.75rem}
        thead{position:sticky;top:0;z-index:20}
        th{background:var(--bg2);padding:.35rem .3rem;text-align:left;font-weight:600;color:var(--text2);font-size:.65rem;border-bottom:1px solid var(--border);white-space:nowrap;position:relative;text-transform:uppercase;letter-spacing:.02em}
        th.center,td.center{text-align:center}
        th.sticky-col,td.sticky-col{position:sticky;left:0;z-index:10;background:var(--bg2);box-shadow:2px 0 4px rgba(0,0,0,.1)}
        td.sticky-col{background:var(--card)}
        th .col-delete{display:none;position:absolute;right:2px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:.6rem;padding:1px 3px;border-radius:2px}
        th:hover .col-delete{display:inline}
        th .col-delete:hover{color:var(--red);background:rgba(220,38,38,.1)}
        .header-label{cursor:pointer;border-bottom:1px dashed transparent;transition:border-color .15s}
        .header-label:hover{border-bottom-color:var(--primary)}
        td{padding:.3rem .3rem;border-bottom:1px solid var(--border);font-family:'SF Mono',Monaco,monospace;font-size:.7rem;white-space:nowrap}
        tbody tr{transition:background .15s ease}
        tr:nth-child(even) td{background:rgba(255,255,255,.02)}
        tr:nth-child(even) td.sticky-col{background:var(--hover)}
        tr:hover td{background:var(--hover)}
        tr.duplicate td{background:rgba(249,115,22,.12);border-left:3px solid var(--orange)}
        tr.time-error td{background:rgba(220,38,38,.1);border-left:3px solid var(--red)}
        tr.time-error td.time-cell{color:var(--red);font-weight:600}
        tr.rounding-notice td.time-cell{color:var(--cyan)}
        tr.assumed-rp td{border-left:3px solid var(--yellow)}
        td.selected-cell{outline:2px solid var(--primary);outline-offset:-1px}
        .cell-route{color:var(--blue);font-weight:600}
        .cell-time{color:var(--green)}
        .cell-pilot{color:var(--purple)}
        .cell-model{color:var(--cyan)}
        .editable{cursor:pointer;padding:.1rem .15rem;border-radius:3px;min-width:24px;display:inline-block;transition:background .1s}
        .editable:hover{background:rgba(59,130,246,.12)}
        .edit-input{width:100%;min-width:32px;padding:.15rem .2rem;background:var(--bg);border:1px solid var(--primary);border-radius:3px;color:var(--text);font-family:'SF Mono',Monaco,monospace;font-size:.7rem}
        .edit-input[type="datetime-local"]{min-width:130px}
        .edit-input[type="number"]{min-width:45px}
        .edit-input[type="date"]{min-width:90px}
        .flight-checkbox{width:14px;height:14px;accent-color:var(--primary);cursor:pointer}
        .flight-checkbox:focus{outline:2px solid var(--primary);outline-offset:1px}
        .role-toggle{display:inline-flex;background:var(--bg2);border-radius:4px;padding:1px;gap:0}
        .role-toggle button{padding:.15rem .3rem;border:none;background:transparent;color:var(--muted);font-size:.6rem;font-weight:600;border-radius:3px;cursor:pointer;transition:all .1s}
        .role-toggle button.active{background:var(--primary);color:#fff}
        .role-toggle button:hover:not(.active){background:var(--hover)}
        .role-toggle button:focus{outline:1px solid var(--cyan);outline-offset:1px}
        .delete-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:.15rem;font-size:.75rem;border-radius:3px;transition:all .1s}
        .delete-btn:hover{color:var(--red);background:rgba(220,38,38,.1)}
        .badge{display:inline-block;padding:.1rem .3rem;border-radius:3px;font-size:.55rem;font-weight:700;margin-right:.15rem}
        .dup-badge{background:rgba(249,115,22,.15);border:1px solid var(--orange);color:var(--orange)}
        .err-badge{background:rgba(220,38,38,.15);border:1px solid var(--red);color:var(--red)}
        .info-badge{background:rgba(6,182,212,.12);border:1px solid var(--cyan);color:var(--cyan)}
        .unmapped-badge{background:rgba(139,92,246,.12);border:1px solid var(--purple);color:var(--purple);font-size:.5rem}
        .conflict-badge{background:rgba(249,115,22,.15);border:1px solid var(--orange);color:var(--orange);font-size:.5rem}
        .rp-badge{background:rgba(234,179,8,.15);border:1px solid var(--yellow);color:var(--yellow)}
        .assumed-rp{background:rgba(234,179,8,.05)}
        .stats-row{display:flex;gap:.35rem;flex-wrap:wrap;margin-top:.5rem;padding-top:.5rem;border-top:1px solid var(--border)}
        .stat-box{background:var(--bg2);padding:.35rem .5rem;border-radius:5px;min-width:50px;border:1px solid var(--border)}
        .stat-label{font-size:.6rem;color:var(--muted);text-transform:uppercase;letter-spacing:.03em;margin-bottom:0}
        .stat-value{font-size:.85rem;font-weight:700;color:var(--primary);font-family:'SF Mono',Monaco,monospace}
        .status{padding:.6rem 1rem;border-radius:8px;margin-top:.75rem;font-size:.85rem;font-weight:500;animation:fadeIn .3s ease;display:flex;align-items:center;gap:.5rem}
        .status .status-icon{width:16px;height:16px;flex-shrink:0}
        .status-error{background:rgba(220,38,38,.1);border:1px solid rgba(220,38,38,.3);color:#fca5a5}
        .status-success{background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);color:#6ee7b7}
        .status-warning{background:rgba(249,115,22,.1);border:1px solid rgba(249,115,22,.3);color:#fdba74}
        .toolbar{display:flex;gap:.35rem;flex-wrap:wrap;align-items:center;margin-bottom:.5rem;padding:.5rem .6rem;background:var(--bg2);border-radius:6px;border:1px solid var(--border)}
        .toolbar .btn-small{transition:all .15s}
        .toolbar-sep{width:1px;height:18px;background:var(--border);margin:0 .25rem}
        .shortcuts-help{font-size:.7rem;color:var(--muted);padding:.25rem .45rem;background:var(--card);border:1px solid var(--border);border-radius:4px;cursor:help;position:relative;display:flex;align-items:center;gap:.25rem}
        .shortcuts-help:hover .shortcuts-popup{display:block}
        .shortcuts-popup{display:none;position:absolute;bottom:100%;left:0;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:.75rem;width:240px;z-index:100;margin-bottom:6px;box-shadow:var(--shadow)}
        .shortcuts-popup div{font-size:.8rem;padding:.25rem 0;display:flex;justify-content:space-between}
        .shortcuts-popup kbd{background:var(--bg2);padding:.15rem .35rem;border-radius:4px;font-family:'SF Mono',Monaco,monospace;font-size:.75rem;border:1px solid var(--border)}
        .model-settings{display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;padding:.4rem .6rem;background:var(--bg2);border:1px solid var(--border);border-radius:6px}
        .model-label{font-size:.7rem;font-weight:600;color:var(--muted);text-transform:uppercase}
        .toggle-pills{display:flex;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:1px}
        .toggle-pills .pill{padding:.2rem .5rem;font-size:.65rem;font-weight:500;border:none;background:transparent;color:var(--muted);cursor:pointer;border-radius:3px;transition:all .15s}
        .toggle-pills .pill.active{background:var(--primary);color:#fff}
        .toggle-pills .pill:hover:not(.active){background:var(--hover);color:var(--text)}
        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem}
        .modal{background:var(--card);border:1px solid var(--border);border-radius:10px;width:100%;max-width:700px;max-height:80vh;display:flex;flex-direction:column;box-shadow:0 10px 40px rgba(0,0,0,.4)}
        .modal-header{display:flex;align-items:center;justify-content:space-between;padding:.75rem 1rem;border-bottom:1px solid var(--border)}
        .modal-header h3{font-size:.9rem;font-weight:600;display:flex;align-items:center;gap:.4rem;color:var(--text)}
        .modal-close{background:none;border:none;color:var(--muted);cursor:pointer;padding:.25rem;border-radius:4px;transition:all .15s}
        .modal-close:hover{color:var(--red);background:rgba(220,38,38,.1)}
        .modal-filters{display:flex;gap:.5rem;padding:.5rem 1rem;border-bottom:1px solid var(--border);flex-wrap:wrap}
        .modal-filters input,.modal-filters select{padding:.35rem .5rem;background:var(--bg2);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:.75rem}
        .modal-filters input{flex:1;min-width:150px}
        .modal-filters select{min-width:120px}
        .modal-body{flex:1;overflow:auto;padding:0}
        .catalog-table{width:100%;border-collapse:collapse;font-size:.7rem}
        .catalog-table th{background:var(--bg2);padding:.4rem .5rem;text-align:left;font-weight:600;color:var(--text2);font-size:.65rem;text-transform:uppercase;position:sticky;top:0}
        .catalog-table td{padding:.35rem .5rem;border-bottom:1px solid var(--border);font-family:'SF Mono',Monaco,monospace}
        .catalog-table tr:hover td{background:var(--hover)}
        .modal-footer{padding:.5rem 1rem;border-top:1px solid var(--border);font-size:.7rem;color:var(--muted)}
        .feedback-form{padding:1rem}
        .feedback-field{margin-bottom:.75rem}
        .feedback-field label{display:block;font-size:.75rem;font-weight:600;color:var(--text2);margin-bottom:.3rem}
        .feedback-field input,.feedback-field select,.feedback-field textarea{width:100%;padding:.5rem .6rem;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:.8rem;font-family:inherit;transition:border-color .15s}
        .feedback-field input:focus,.feedback-field select:focus,.feedback-field textarea:focus{outline:none;border-color:var(--primary)}
        .feedback-field textarea{resize:vertical;min-height:80px}
        .feedback-actions{display:flex;justify-content:flex-end;margin-top:1rem}
        .feedback-status{margin-top:.75rem;padding:.5rem .75rem;border-radius:6px;font-size:.8rem;text-align:center}
        .feedback-status.success{background:rgba(34,197,94,.1);color:var(--green);border:1px solid rgba(34,197,94,.2)}
        .feedback-status.error{background:rgba(239,68,68,.1);color:var(--red);border:1px solid rgba(239,68,68,.2)}
        .optional-panel{margin-top:.75rem;padding-top:.75rem;border-top:1px solid var(--border)}
        .optional-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.4rem;flex-wrap:wrap;gap:.35rem}
        .optional-header h4{font-size:.8rem;color:var(--text);font-weight:600}
        .search-box{display:flex;align-items:center;background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:.4rem .6rem}
        .search-box input{background:transparent;border:none;color:var(--text);font-size:.85rem;width:120px;outline:none}
        .search-box input::placeholder{color:var(--muted)}
        .category-tabs{display:flex;gap:.25rem;flex-wrap:wrap;margin-bottom:.5rem}
        .category-tab{padding:.4rem .7rem;background:var(--bg2);border:1px solid var(--border);border-radius:6px;font-size:.8rem;color:var(--muted);cursor:pointer;transition:all .15s;font-weight:500}
        .category-tab:hover{border-color:var(--primary);color:var(--text)}
        .category-tab.active{background:var(--primary);border-color:var(--primary);color:#fff}
        .fields-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.35rem;max-height:150px;overflow-y:auto;padding:.5rem;background:var(--bg2);border-radius:8px}
        .field-item{display:flex;align-items:center;gap:.35rem;padding:.4rem .5rem;background:var(--card);border:1px solid var(--border);border-radius:6px;font-size:.8rem;cursor:pointer;transition:all .15s}
        .field-item:hover{border-color:var(--primary);background:var(--hover)}
        .field-item.selected{background:rgba(59,130,246,.1);border-color:var(--primary)}
        .field-item input{width:14px;height:14px}
        .field-item .field-name{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
        .field-item .field-type{font-size:.65rem;padding:.1rem .25rem;background:var(--bg2);border-radius:4px;color:var(--muted)}
        .selected-fields{display:flex;flex-wrap:wrap;gap:.35rem;margin-top:.5rem}
        .selected-tag{display:flex;align-items:center;gap:.25rem;padding:.35rem .5rem;background:rgba(59,130,246,.1);border:1px solid var(--primary);border-radius:6px;font-size:.8rem;color:var(--primary);font-weight:500}
        .selected-tag button{background:none;border:none;color:var(--primary);cursor:pointer;font-size:.85rem;line-height:1;padding:.1rem;border-radius:3px;transition:all .15s}
        .selected-tag button:hover{color:var(--red);background:rgba(220,38,38,.1)}
        .selected-tag .reorder-btn{color:var(--muted);font-size:.75rem}
        .selected-tag .reorder-btn:hover{color:var(--primary);background:rgba(59,130,246,.1)}
        .section{display:none;opacity:0}.section.active{display:block;opacity:1}
        .preview-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:.75rem}
        .row-count,.dup-count,.err-count,.rp-count{padding:.25rem .6rem;border-radius:4px;font-size:.75rem;font-weight:600;color:#fff;display:inline-flex;align-items:center;gap:.25rem}
        .row-count{background:var(--primary)}.dup-count{background:var(--orange)}.err-count{background:var(--red)}.rp-count{background:var(--yellow);color:#000}
        footer{text-align:center;padding:1.25rem;color:var(--muted);font-size:.75rem;border-top:1px solid var(--border);margin-top:1rem}
        footer a{color:var(--primary);text-decoration:none;font-weight:500;transition:color .15s}
        footer a:hover{color:var(--cyan)}
        .hidden{display:none!important}
        @media(max-width:768px){.container{padding:.75rem}.toolbar{flex-wrap:wrap;gap:.25rem}.toolbar-sep{display:none}.shortcuts-help{display:none}}
        @media(max-width:640px){.container{padding:.5rem}.format-row{flex-direction:column}.format-group{min-width:100%}.settings-row{flex-direction:column}.table-scroll{max-height:300px}th,td{padding:.25rem .2rem;font-size:.65rem}.btn{padding:.4rem .6rem;font-size:.7rem}.btn-small{padding:.2rem .4rem;font-size:.65rem}.card{padding:.75rem}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="theme-toggle" id="themeToggle" title="Switch theme">
                <button data-theme="light"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/></svg></button>
                <button data-theme="dark" class="active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg></button>
            </div>
            <div class="logo"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg></div>
            <h1>FlightLog Converter</h1>
            <p class="subtitle">Convert <strong>Air Canada</strong> logbooks to <strong>MyFlightBook</strong> format</p>
        </header>
        <div class="steps">
            <div class="step active" id="step1"><span class="step-num"><span>1</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span> Setup</div>
            <div class="step-connector" id="conn1"></div>
            <div class="step" id="step2"><span class="step-num"><span>2</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span> Review</div>
            <div class="step-connector" id="conn2"></div>
            <div class="step" id="step3"><span class="step-num"><span>3</span><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span> Export</div>
        </div>
        <div class="section active" id="section1">
            <div class="card">
                <div class="card-header"><h2 class="card-title">Configure Import & Export</h2></div>
                <div class="format-row">
                    <div class="format-group">
                        <label>Source Format</label>
                        <select id="sourceFormat"><option value="ac-pqrm">Air Canada PQRM</option><option value="other" disabled>Other (Coming Soon)</option></select>
                    </div>
                    <div class="format-group">
                        <label>Export Format</label>
                        <select id="exportFormat"><option value="myflightbook">MyFlightBook</option><option value="other" disabled>Other (Coming Soon)</option></select>
                    </div>
                </div>
                <div class="mode-toggle" id="modeToggle">
                    <button class="active" data-mode="upload"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> Upload</button>
                    <button data-mode="manual"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Manual</button>
                </div>
                <div id="uploadSection">
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                        <p class="upload-text">Drop your Air Canada XLS files here</p>
                        <p class="upload-hint">or click to browse</p>
                        <input type="file" class="file-input" id="fileInput" accept=".xls,.xlsx,.csv,.txt" multiple>
                    </div>
                    <div class="file-list" id="fileList"></div>
                    <div class="pilot-detection" id="pilotDetection">
                        <h4><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Detected Pilot</h4>
                        <input type="text" id="pilotName" placeholder="Your name">
                        <div class="detected-info" id="detectedInfo"></div>
                    </div>
                    <div class="instructions">
                        <h4><svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg> Export from Aeronet</h4>
                        <p>Aeronet → Flight Ops → PQRM → Logbook → Select month → Submit → Save as Excel</p>
                    </div>
                </div>
                <div id="manualSection" class="hidden">
                    <div class="pilot-detection visible">
                        <h4><svg class="icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg> Your Name</h4>
                        <input type="text" id="pilotNameManual" placeholder="Enter your name">
                        <div class="detected-info">Used for "Self" in PIC/SIC fields</div>
                    </div>
                </div>
                <div class="settings-row">
                    <div class="setting-group">
                        <label>Employer</label>
                        <select id="employer"><option value="Rouge">Air Canada Rouge</option><option value="Air Canada">Air Canada Mainline</option></select>
                    </div>
                    <div class="setting-group small">
                        <label>&nbsp;</label>
                        <div class="toggle-group">
                            <span class="toggle-label">Self</span>
                            <div class="toggle" id="selfToggle"></div>
                            <span class="toggle-label">Name</span>
                        </div>
                    </div>
                </div>
                <div id="statusMessage"></div>
                <div class="btn-row">
                    <button class="btn btn-primary" id="processBtn" disabled>Process →</button>
                    <button class="btn btn-primary hidden" id="manualStartBtn">Start →</button>
                </div>
            </div>
        </div>
        <div class="section" id="section2">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Review & Edit</h2>
                    <span class="row-count" id="flightCount">0</span>
                    <span class="dup-count" id="dupCount" style="display:none">0</span>
                    <span class="err-count" id="errCount" style="display:none">0</span>
                    <span class="rp-count" id="rpCount" style="display:none">0</span>
                </div>
                <div class="model-settings" id="modelSettings">
                    <span class="model-label">Model Output:</span>
                    <div class="toggle-pills" id="modelModePills">
                        <button class="pill" data-mode="generic">Generic</button>
                        <button class="pill active" data-mode="specific">Specific</button>
                    </div>
                    <button class="btn btn-small btn-secondary" id="catalogBtn" title="View aircraft catalog"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg> Catalog</button>
                </div>
                <div class="toolbar">
                    <button class="btn btn-small btn-secondary" id="addBtn">+ Add</button>
                    <button class="btn btn-small btn-secondary" id="clearAllBtn" style="color:var(--red)">Clear All</button>
                    <div class="toolbar-sep"></div>
                    <button class="btn btn-small btn-secondary" id="allPicBtn">All PIC</button>
                    <button class="btn btn-small btn-secondary" id="allSicBtn">All SIC</button>
                    <button class="btn btn-small btn-secondary" id="allRpBtn">All RP</button>
                    <button class="btn btn-small btn-secondary" id="resetRolesBtn" title="Reset all changes to original file values"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg> Reset</button>
                    <button class="btn btn-small btn-secondary" id="confirmRpBtn" style="display:none;color:var(--yellow)" title="Confirm all flights marked as assumed RP">Confirm RP?</button>
                    <div class="toolbar-sep"></div>
                    <div class="dropdown" id="colDropdown">
                        <button class="btn btn-small btn-secondary" id="colDropdownBtn">+ Columns</button>
                        <div class="dropdown-content" id="colDropdownContent"></div>
                    </div>
                    <div class="toolbar-sep"></div>
                    <div class="shortcuts-help">
                        <svg class="icon icon-sm" viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="8" x2="6" y2="8"/><line x1="10" y1="8" x2="10" y2="8"/><line x1="14" y1="8" x2="14" y2="8"/><line x1="18" y1="8" x2="18" y2="8"/><line x1="6" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="18" y2="12"/><line x1="8" y1="16" x2="16" y2="16"/></svg> Keys
                        <div class="shortcuts-popup">
                            <div><span>Navigate</span><kbd>Tab</kbd> <kbd>Arrows</kbd></div>
                            <div><span>Edit cell</span><kbd>Enter</kbd></div>
                            <div><span>Cancel</span><kbd>Esc</kbd></div>
                            <div><span>Toggle checkbox</span><kbd>Space</kbd></div>
                            <div><span>Clear cell</span><kbd>Del</kbd></div>
                            <div><span>Undo</span><kbd>Ctrl+Z</kbd></div>
                            <div><span>Add row</span><kbd>Ctrl+N</kbd></div>
                            <div><span>Delete row</span><kbd>Ctrl+Del</kbd></div>
                            <div><span>Fill column</span><kbd>Ctrl+Shift+F</kbd></div>
                        </div>
                    </div>
                    <div class="toolbar-sep"></div>
                    <a href="https://myflightbook.com/logbook/mvc/pub/ImportTable" target="_blank" class="btn btn-small btn-secondary" style="text-decoration:none;color:var(--cyan)"><svg class="icon icon-sm" viewBox="0 0 24 24"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg> MFB Fields</a>
                </div>
                <div class="table-wrapper">
                    <div class="table-scroll" id="tableScroll">
                        <table id="flightsTable"><thead id="flightsHead"></thead><tbody id="flightsBody"></tbody></table>
                    </div>
                </div>
                <div class="stats-row" id="statsRow"></div>
                <div class="optional-panel">
                    <div class="optional-header">
                        <h4>Optional Fields</h4>
                        <div class="search-box"><input type="text" id="fieldSearch" placeholder="Search..."></div>
                    </div>
                    <div class="category-tabs" id="categoryTabs"></div>
                    <div class="fields-grid" id="fieldsGrid"></div>
                    <div class="selected-fields" id="selectedFields"></div>
                </div>
                <div class="btn-row">
                    <button class="btn btn-secondary" id="backBtn1">← Back</button>
                    <button class="btn btn-primary" id="previewBtn">Preview →</button>
                </div>
            </div>
        </div>
        <div class="section" id="section3">
            <div class="card">
                <div class="preview-header">
                    <div style="display:flex;align-items:center;gap:.2rem">
                        <h2 class="card-title">CSV Preview</h2>
                        <span class="row-count" id="previewCount">0</span>
                    </div>
                    <button class="btn btn-success" id="downloadBtn"><svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download</button>
                </div>
                <div class="table-wrapper" style="margin-top:.3rem">
                    <div class="table-scroll" style="max-height:240px">
                        <table><thead id="previewHead"></thead><tbody id="previewBody"></tbody></table>
                    </div>
                </div>
                <div class="btn-row"><button class="btn btn-secondary" id="backBtn2">← Back</button></div>
            </div>
        </div>
        <!-- Aircraft Catalog Modal -->
        <div class="modal-overlay" id="catalogModal" style="display:none">
            <div class="modal">
                <div class="modal-header">
                    <h3><svg class="icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg> Aircraft Catalog</h3>
                    <button class="modal-close" id="closeCatalogBtn"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                </div>
                <div class="modal-filters">
                    <input type="text" id="catalogSearch" placeholder="Search registration, fin, variant...">
                    <select id="catalogFamilyFilter">
                        <option value="">All Families</option>
                        <option value="A320">A319/A320/A321</option>
                        <option value="A330">A330</option>
                        <option value="B767">B767</option>
                        <option value="B777">B777</option>
                        <option value="B787">B787</option>
                    </select>
                </div>
                <div class="modal-body">
                    <table class="catalog-table">
                        <thead><tr><th>Reg</th><th>FIN</th><th>Family</th><th>Variant</th><th>Sub-Variant</th><th>MSN</th></tr></thead>
                        <tbody id="catalogTableBody"></tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <span id="catalogCount">0 aircraft</span>
                </div>
            </div>
        </div>
        <!-- Feedback Modal -->
        <div class="modal-overlay" id="feedbackModal" style="display:none">
            <div class="modal" style="max-width:450px">
                <div class="modal-header">
                    <h3><svg class="icon" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg> Send Feedback</h3>
                    <button class="modal-close" id="closeFeedbackBtn"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                </div>
                <form id="feedbackForm" class="feedback-form">
                    <div class="feedback-field">
                        <label for="feedbackType">Type</label>
                        <select id="feedbackType" name="type" required>
                            <option value="">Select type...</option>
                            <option value="Bug Report">Bug Report</option>
                            <option value="Missing Aircraft">Missing Aircraft</option>
                            <option value="Feature Request">Feature Request</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="feedback-field" id="aircraftField" style="display:none">
                        <label for="feedbackAircraft">Aircraft Info</label>
                        <input type="text" id="feedbackAircraft" name="aircraft" placeholder="Registration, fin #, or description...">
                    </div>
                    <div class="feedback-field">
                        <label for="feedbackDetails">Details <span style="color:var(--red)">*</span></label>
                        <textarea id="feedbackDetails" name="details" required rows="4" placeholder="Please describe your feedback..."></textarea>
                    </div>
                    <div class="feedback-field">
                        <label for="feedbackEmail">Email <span style="color:var(--muted);font-weight:400">(optional, for follow-up)</span></label>
                        <input type="email" id="feedbackEmail" name="email" placeholder="your@email.com">
                    </div>
                    <div class="feedback-actions">
                        <button type="submit" class="btn btn-primary" id="feedbackSubmitBtn">Send Feedback</button>
                    </div>
                    <div id="feedbackStatus" class="feedback-status" style="display:none"></div>
                </form>
            </div>
        </div>
        <footer>
            <div style="margin-bottom:.35rem;display:flex;align-items:center;justify-content:center;gap:.4rem"><svg style="width:16px;height:16px" viewBox="0 0 24 24" fill="var(--primary)"><path d="M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z"/></svg> FlightLog Converter</div>
            <div style="display:flex;align-items:center;justify-content:center;gap:.4rem"><svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg> All data processed locally in your browser &bull; <a href="https://myflightbook.com/logbook/mvc/pub/ImportTable" target="_blank">MyFlightBook Docs</a> &bull; <a href="#" id="feedbackBtn" style="color:var(--muted);text-decoration:none" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--muted)'">Feedback</a></div>
        </footer>
    </div>
<script>
const STORAGE_KEY='flightlog_prefs';

// Undo stack
const undoStack = [];
const MAX_UNDO = 50;
function saveUndo(){
    undoStack.push(JSON.stringify(flights.map(f=>({...f,opt:{...f.opt}}))));
    if(undoStack.length > MAX_UNDO) undoStack.shift();
}
function doUndo(){
    if(!undoStack.length){showStatus('Nothing to undo','warning');return}
    const scrollTop=tableScroll?tableScroll.scrollTop:0;
    const scrollLeft=tableScroll?tableScroll.scrollLeft:0;
    const prev = JSON.parse(undoStack.pop());
    flights = prev;
    renderTable();
    if(tableScroll){tableScroll.scrollTop=scrollTop;tableScroll.scrollLeft=scrollLeft}
    showStatus('Undone','success');
}

const MODEL_MAP={'l319':'A320','l-319':'A320','l 319':'A320','l320':'A320','l-320':'A320','l 320':'A320','l321':'A320','l-321':'A320','l 321':'A320','a319':'A320','a320':'A320','a321':'A320','319':'A320','320':'A320','321':'A320','l330':'A330','l-330':'A330','l 330':'A330','a330':'A330','330':'A330','l350':'A350','l-350':'A350','l 350':'A350','a350':'A350','350':'A350','b737':'B737','b-737':'B737','737':'B737','737max':'B737','7m8':'B737','7m9':'B737','b767':'B767','767':'B767','b777':'B777','777':'B777','77l':'B777','77w':'B777','b787':'B787','787':'B787','788':'B787','789':'B787','e175':'E175','e190':'E190','crj':'CRJ','q400':'Q400'};
function normalizeModel(t){if(!t)return'';const n=t.toLowerCase().replace(/[\s\-]+/g,'');if(MODEL_MAP[n])return MODEL_MAP[n];for(const[k,v]of Object.entries(MODEL_MAP))if(n.includes(k)||k.includes(n))return v;return{model:t.trim().toUpperCase(),unmapped:true}}

// ==================== AIRCRAFT CATALOG ====================
// Air Canada fleet data from FCOM/AOM appendix cross-reference tables
// Provides specific variant lookup by registration, fin, or nose number

const AIRCRAFT_CATALOG_RAW = [
// A319 Fleet
{fin:'0251',reg:'C-FYNS',msn:'00572',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0252',reg:'C-FYIY',msn:'00634',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0255',reg:'C-FYJE',msn:'00656',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0256',reg:'C-FYJG',msn:'00670',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0257',reg:'C-FYJH',msn:'00672',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0258',reg:'C-FYJI',msn:'00682',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0259',reg:'C-FYJP',msn:'00688',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0260',reg:'C-FYKC',msn:'00691',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0262',reg:'C-FYKW',msn:'00695',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0263',reg:'C-FZUG',msn:'00697',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0272',reg:'C-GARJ',msn:'00752',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0273',reg:'C-GARO',msn:'00757',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0276',reg:'C-GBHO',msn:'00779',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0277',reg:'C-GBHR',msn:'00785',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0278',reg:'C-GBHY',msn:'00800',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0279',reg:'C-GBHZ',msn:'00813',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0280',reg:'C-GBIA',msn:'00817',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0281',reg:'C-GBIJ',msn:'00829',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0283',reg:'C-GBIM',msn:'00840',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0284',reg:'C-GBIN',msn:'00845',variant:'A319',family:'A320',sub:'319-114'},
{fin:'0286',reg:'C-GITP',msn:'01562',variant:'A319',family:'A320',sub:'319-112'},
{fin:'0287',reg:'C-GITR',msn:'01577',variant:'A319',family:'A320',sub:'319-112'},
{fin:'0290',reg:'C-GSJB',msn:'01673',variant:'A319',family:'A320',sub:'319-112'},
// A320 Fleet
{fin:'0225',reg:'C-FKPT',msn:'00324',variant:'A320',family:'A320',sub:'320-211'},
{fin:'0226',reg:'C-FKOJ',msn:'00330',variant:'A320',family:'A320',sub:'320-211'},
{fin:'0232',reg:'C-FMSX',msn:'00378',variant:'A320',family:'A320',sub:'320-211'},
{fin:'0235',reg:'C-GJVT',msn:'01719',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0236',reg:'C-GKOD',msn:'01864',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0237',reg:'C-GKOE',msn:'01874',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0238',reg:'C-FZUB',msn:'01940',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0239',reg:'C-FXCD',msn:'02018',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0240',reg:'C-FZQS',msn:'02145',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0241',reg:'C-FGJI',msn:'01787',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0242',reg:'C-FGKH',msn:'01975',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0243',reg:'C-GFCH',msn:'03160',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0244',reg:'C-GFCI',msn:'03286',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0245',reg:'C-GFCP',msn:'03123',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0246',reg:'C-GFDU',msn:'03149',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0247',reg:'C-GFWX',msn:'03304',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0401',reg:'C-GPWG',msn:'00174',variant:'A320',family:'A320',sub:'320-211'},
{fin:'0402',reg:'C-FPWE',msn:'00175',variant:'A320',family:'A320',sub:'320-211'},
{fin:'0405',reg:'C-FDCA',msn:'00232',variant:'A320',family:'A320',sub:'320-211'},
{fin:'0415',reg:'C-FNVU',msn:'00403',variant:'A320',family:'A320',sub:'320-211'},
{fin:'0416',reg:'C-FNVV',msn:'00404',variant:'A320',family:'A320',sub:'320-211'},
{fin:'0417',reg:'C-FCQD',msn:'03155',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0418',reg:'C-FCQX',msn:'04948',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0419',reg:'C-FCYX',msn:'05034',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0420',reg:'C-FCZF',msn:'03465',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0421',reg:'C-FCUG',msn:'02708',variant:'A320',family:'A320',sub:'320-214'},
{fin:'0422',reg:'C-FDGQ',msn:'02770',variant:'A320',family:'A320',sub:'320-214'},
// A321 Fleet
{fin:'0451',reg:'C-GITU',msn:'01602',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0452',reg:'C-GITY',msn:'01611',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0453',reg:'C-GIUB',msn:'01623',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0454',reg:'C-GIUE',msn:'01632',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0455',reg:'C-GIUF',msn:'01638',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0456',reg:'C-GJVX',msn:'01726',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0457',reg:'C-GJWD',msn:'01748',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0458',reg:'C-GJWI',msn:'01772',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0459',reg:'C-GJWN',msn:'01783',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0460',reg:'C-GJWO',msn:'01811',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0461',reg:'C-FGKN',msn:'03051',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0462',reg:'C-FGKP',msn:'03884',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0463',reg:'C-FGKZ',msn:'03401',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0464',reg:'C-FJNX',msn:'01691',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0465',reg:'C-GYFM',msn:'05354',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0466',reg:'C-GYFY',msn:'05377',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0467',reg:'C-GYGU',msn:'05328',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0468',reg:'C-FJOK',msn:'06844',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0469',reg:'C-FJOU',msn:'06873',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0470',reg:'C-FJQD',msn:'06884',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0471',reg:'C-FJQH',msn:'06905',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0472',reg:'C-FJQL',msn:'07117',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0473',reg:'C-FLKX',msn:'01299',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0474',reg:'C-FYXF',msn:'05038',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0475',reg:'C-GHPD',msn:'05681',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0476',reg:'C-GHPJ',msn:'05733',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0477',reg:'C-GHQG',msn:'06210',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0478',reg:'C-GHQI',msn:'06232',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0479',reg:'C-GJTH',msn:'07433',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0480',reg:'C-GJTX',msn:'07650',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0481',reg:'C-GKFA',msn:'08104',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0482',reg:'C-GKFB',msn:'08232',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0483',reg:'C-FCEU',msn:'05808',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0484',reg:'C-FFGZ',msn:'05849',variant:'A321',family:'A320',sub:'321-211'},
{fin:'0301',reg:'C-GXLR',msn:'12696',variant:'A321XLR',family:'A320',sub:'321-271NY'},
// A330 Fleet
{fin:'0931',reg:'C-GFAF',msn:'0277',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0932',reg:'C-GFAH',msn:'0279',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0933',reg:'C-GFAJ',msn:'0284',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0934',reg:'C-GFUR',msn:'0344',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0935',reg:'C-GHKR',msn:'0400',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0936',reg:'C-GHKW',msn:'0408',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0937',reg:'C-GHKX',msn:'0412',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0938',reg:'C-GHLM',msn:'0419',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0939',reg:'C-GEFA',msn:'0997',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0940',reg:'C-GEGC',msn:'1006',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0941',reg:'C-GEGI',msn:'1012',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0942',reg:'C-GEGP',msn:'1015',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0943',reg:'C-GHKC',msn:'0986',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0944',reg:'C-GKUG',msn:'1149',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0945',reg:'C-GKUH',msn:'1156',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0946',reg:'C-GOFV',msn:'1447',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0947',reg:'C-GOFW',msn:'1485',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0948',reg:'C-GXZD',msn:'1517',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0949',reg:'C-FDHG',msn:'1427',variant:'A330',family:'A330',sub:'330-343'},
{fin:'0950',reg:'C-FDHU',msn:'1105',variant:'A330',family:'A330',sub:'330-343'},
// B767 Fleet
{fin:'637',reg:'C-FPCA',msn:'24306',variant:'767-300ER',family:'B767',sub:'375ER'},
{fin:'638',reg:'C-FTCA',msn:'24307',variant:'767-300ER',family:'B767',sub:'375ER'},
{fin:'639',reg:'C-FXCA',msn:'24574',variant:'767-300ER',family:'B767',sub:'375ER'},
{fin:'646',reg:'C-GDUZ',msn:'25347',variant:'767-300ER',family:'B767',sub:'38EER'},
{fin:'660',reg:'C-GHLU',msn:'30851',variant:'767-300ER',family:'B767',sub:'333ER'},
{fin:'661',reg:'C-GHLV',msn:'30852',variant:'767-300ER',family:'B767',sub:'333ER'},
{fin:'662',reg:'C-GXHI',msn:'67023',variant:'767-300F',family:'B767',sub:'300FFG'},
{fin:'663',reg:'C-GXHM',msn:'67024',variant:'767-300F',family:'B767',sub:'300FFG'},
// B777 Fleet - 777-200LR
{fin:'701',reg:'C-FIUA',msn:'35239',variant:'777-200LR',family:'B777',sub:'777-233LR'},
{fin:'702',reg:'C-FIUF',msn:'35243',variant:'777-200LR',family:'B777',sub:'777-233LR'},
{fin:'703',reg:'C-FIUJ',msn:'35244',variant:'777-200LR',family:'B777',sub:'777-233LR'},
{fin:'704',reg:'C-FIVK',msn:'35245',variant:'777-200LR',family:'B777',sub:'777-233LR'},
{fin:'705',reg:'C-FNND',msn:'35246',variant:'777-200LR',family:'B777',sub:'777-233LR'},
{fin:'706',reg:'C-FNNH',msn:'35247',variant:'777-200LR',family:'B777',sub:'777-233LR'},
// B777 Fleet - 777-300ER
{fin:'731',reg:'C-FITL',msn:'35256',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'732',reg:'C-FITU',msn:'35254',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'733',reg:'C-FITW',msn:'35298',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'734',reg:'C-FIUL',msn:'35255',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'735',reg:'C-FIUR',msn:'35242',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'736',reg:'C-FIUV',msn:'35248',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'737',reg:'C-FIUW',msn:'35249',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'738',reg:'C-FIVM',msn:'35251',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'739',reg:'C-FRAM',msn:'35250',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'740',reg:'C-FIVQ',msn:'35240',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'741',reg:'C-FIVR',msn:'35241',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'742',reg:'C-FIVS',msn:'35784',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'743',reg:'C-FIVW',msn:'42218',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'744',reg:'C-FIVX',msn:'42219',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'745',reg:'C-FNNQ',msn:'43251',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'746',reg:'C-FNNU',msn:'43249',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'747',reg:'C-FNNW',msn:'43250',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'748',reg:'C-FJZS',msn:'62400',variant:'777-300ER',family:'B777',sub:'777-333ER'},
{fin:'749',reg:'C-FKAU',msn:'62401',variant:'777-300ER',family:'B777',sub:'777-333ER'},
// B787 Fleet - 787-8
{fin:'801',reg:'C-GHPQ',msn:'35257',variant:'787-8',family:'B787',sub:'787-8'},
{fin:'802',reg:'C-GHPT',msn:'35258',variant:'787-8',family:'B787',sub:'787-8'},
{fin:'803',reg:'C-GHPU',msn:'35259',variant:'787-8',family:'B787',sub:'787-8'},
{fin:'804',reg:'C-GHPV',msn:'35260',variant:'787-8',family:'B787',sub:'787-8'},
{fin:'805',reg:'C-GHPX',msn:'35261',variant:'787-8',family:'B787',sub:'787-8'},
{fin:'806',reg:'C-GHPY',msn:'35262',variant:'787-8',family:'B787',sub:'787-8'},
{fin:'807',reg:'C-GHQQ',msn:'35263',variant:'787-8',family:'B787',sub:'787-8'},
{fin:'808',reg:'C-GHQY',msn:'35264',variant:'787-8',family:'B787',sub:'787-8'},
// B787 Fleet - 787-9
{fin:'831',reg:'C-FNOE',msn:'35265',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'832',reg:'C-FNOG',msn:'35266',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'833',reg:'C-FNOH',msn:'35267',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'834',reg:'C-FNOI',msn:'35268',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'835',reg:'C-FGDT',msn:'37171',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'836',reg:'C-FGDX',msn:'35269',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'837',reg:'C-FGDZ',msn:'37173',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'838',reg:'C-FGEI',msn:'37174',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'839',reg:'C-FGEO',msn:'37180',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'840',reg:'C-FGFZ',msn:'37172',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'841',reg:'C-FPQB',msn:'35270',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'842',reg:'C-FGHZ',msn:'37169',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'843',reg:'C-FKSV',msn:'37170',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'844',reg:'C-FRSA',msn:'37175',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'845',reg:'C-FRSE',msn:'37181',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'846',reg:'C-FRSI',msn:'37176',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'847',reg:'C-FRSO',msn:'37177',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'848',reg:'C-FRSR',msn:'37178',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'849',reg:'C-FRTG',msn:'37184',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'850',reg:'C-FRTU',msn:'37183',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'851',reg:'C-FRTW',msn:'37179',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'852',reg:'C-FSBV',msn:'37182',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'853',reg:'C-FVLQ',msn:'38357',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'854',reg:'C-FVLU',msn:'38360',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'855',reg:'C-FVLX',msn:'38356',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'856',reg:'C-FVLZ',msn:'38358',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'857',reg:'C-FVNB',msn:'38359',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'858',reg:'C-FVND',msn:'38361',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'859',reg:'C-FVNF',msn:'38362',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'860',reg:'C-GWUU',msn:'66991',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'861',reg:'C-GYJW',msn:'66992',variant:'787-9',family:'B787',sub:'787-9'},
{fin:'862',reg:'C-FEGI',msn:'66993',variant:'787-9',family:'B787',sub:'787-9'}
];

// Build lookup indexes
const aircraftCatalog = {byReg:{},byFin:{},byNose:{},entries:AIRCRAFT_CATALOG_RAW};
function buildCatalogIndexes(){
    AIRCRAFT_CATALOG_RAW.forEach(ac=>{
        const regKey=(ac.reg||'').replace(/-/g,'').toUpperCase();
        const finKey=(ac.fin||'').replace(/^0+/,'');
        if(regKey)aircraftCatalog.byReg[regKey]=ac;
        if(finKey){aircraftCatalog.byFin[finKey]=ac;aircraftCatalog.byNose[finKey]=ac;}
    });
}
buildCatalogIndexes();

// Family groupings for UI toggles
// Model output preferences (user-configurable)
let modelOutputMode='specific'; // 'generic' or 'specific'

// Normalize registration for lookup (remove dashes, uppercase)
function normalizeReg(r){return(r||'').replace(/-/g,'').toUpperCase();}

// Resolve aircraft variant from available identifiers
function resolveAircraftVariant(identifiers){
    const{registration,fin,nose,typeCode}=identifiers;

    // Get generic family from type code (existing logic)
    const genericResult=normalizeModel(typeCode);
    const genericFamily=typeof genericResult==='object'?genericResult.model:genericResult;

    let resolved=null,source='fallback',conflict=false;

    // Priority 1: Registration lookup
    if(registration){
        const regKey=normalizeReg(registration);
        resolved=aircraftCatalog.byReg[regKey];
        if(resolved)source='registration';
    }

    // Priority 2: Nose number lookup
    if(!resolved&&nose){
        const noseKey=(nose+'').replace(/^0+/,'');
        resolved=aircraftCatalog.byNose[noseKey];
        if(resolved)source='nose';
    }

    // Priority 3: Fin number lookup
    if(!resolved&&fin){
        const finKey=(fin+'').replace(/^0+/,'');
        resolved=aircraftCatalog.byFin[finKey];
        if(resolved)source='fin';
    }

    // Check for conflicts (multiple identifiers resolve to different aircraft)
    if(registration&&fin){
        const regResult=aircraftCatalog.byReg[normalizeReg(registration)];
        const finResult=aircraftCatalog.byFin[(fin+'').replace(/^0+/,'')];
        if(regResult&&finResult&&regResult.variant!==finResult.variant)conflict=true;
    }

    return{
        family:resolved?.family||genericFamily,
        variant:resolved?.variant||genericFamily,
        subVariant:resolved?.sub||null,
        source:source,
        conflict:conflict,
        catalogMatch:resolved,
        originalTypeCode:typeCode
    };
}

// Get model string for display/export based on user preferences
function getModelForOutput(flight){
    const family=flight._variantInfo?.family||flight.family||flight.Model;
    const variant=flight._variantInfo?.variant||flight.variant||flight.Model;
    if(modelOutputMode==='generic')return family;
    return variant;
}

const CATS={
'Time':[
    {k:'X-Country',l:'X-Country',t:'Number'},
    {k:'IMC',l:'IMC',t:'Number'},
    {k:'Simulated Instrument',l:'Sim Inst',t:'Number'},
    {k:'Dual Received',l:'Dual Rcvd',t:'Number'},
    {k:'CFI',l:'CFI',t:'Number'},
    {k:'Ground Simulator',l:'Ground Sim',t:'Number'},
    {k:'Pilot Flying Time',l:'PF Time',t:'Number'},
    {k:'Pilot Monitoring Time',l:'PM Time',t:'Number'},
    {k:'Multi-Pilot Time',l:'Multi-Pilot',t:'Number'},
    {k:'Solo Time',l:'Solo',t:'Number'},
    {k:'Relief Pilot Time',l:'Relief Time',t:'Number'},
    {k:'Night Cross-country Time',l:'Night XC',t:'Number'},
    {k:'Right Seat Time',l:'R Seat Time',t:'Number'},
    {k:'Turbine Time',l:'Turbine',t:'Number'},
    {k:'Jet Time',l:'Jet',t:'Number'},
    {k:'Acting PIC Time',l:'Acting PIC',t:'Number'}
],
'Landings':[
    {k:'FS Day Landings',l:'FS Day',t:'Number'},
    {k:'FS Night Landings',l:'FS Night',t:'Number'},
    {k:'Landings - Touch and Go',l:'Touch&Go',t:'Number'},
    {k:'Landings - Autoland',l:'Autoland',t:'Number'},
    {k:'Go-arounds',l:'Go-around',t:'Number'},
    {k:'Takeoffs - Night',l:'Night TO',t:'Number'},
    {k:'Landings - Night, towered Airport',l:'Night Twr',t:'Number'},
    {k:'Landings - Night, Non-towered airport',l:'Night Non-Twr',t:'Number'},
    {k:'Landings - Cross-wind',l:'Crosswind',t:'Number'}
],
'Approaches':[
    {k:'Approaches',l:'Approaches',t:'Number'},
    {k:'Hold',l:'Hold',t:'Yes/No'},
    {k:'Approaches - ILS',l:'ILS',t:'Number'},
    {k:'Approaches - GPS/LPV',l:'GPS/LPV',t:'Number'},
    {k:'Approaches - RNAV/GPS',l:'RNAV',t:'Number'},
    {k:'Approaches - VOR',l:'VOR',t:'Number'},
    {k:'Approaches - Visual',l:'Visual',t:'Number'},
    {k:'Approaches - Localizer',l:'LOC',t:'Number'},
    {k:'Approaches - Category I',l:'CAT I',t:'Number'},
    {k:'Approaches - Category II',l:'CAT II',t:'Number'},
    {k:'Approaches - Category III',l:'CAT III',t:'Number'},
    {k:'Missed Approaches',l:'Missed',t:'Number'}
],
'Personnel':[
    {k:'Instructor Name',l:'Instructor',t:'Text'},
    {k:'Safety-Pilot Name',l:'Safety Pilot',t:'Text'},
    {k:'Pilot Flying (Name)',l:'PF Name',t:'Text'},
    {k:'Pilot Monitoring (Name)',l:'PM Name',t:'Text'},
    {k:'Captain Name',l:'Captain',t:'Text'},
    {k:'First Officer Name',l:'First Officer',t:'Text'},
    {k:'Relief Crew Name(s)',l:'Relief Crew',t:'Text'},
    {k:'Flight Attendant Name(s)',l:'F/As',t:'Text'},
    {k:'Student Name',l:'Student',t:'Text'},
    {k:'Examiner Name',l:'Examiner',t:'Text'}
],
'Aircraft':[
    {k:'Route',l:'Route',t:'Text'},
    {k:'Additional Flight Remarks',l:'Remarks',t:'Text'},
    {k:'Distance Flown',l:'Distance',t:'Number'},
    {k:'Maximum Altitude',l:'Max Alt',t:'Number'},
    {k:'Aircraft Registration',l:'Registration',t:'Text'},
    {k:'Fuel Added',l:'Fuel Added',t:'Number'},
    {k:'Fuel Consumed',l:'Fuel Used',t:'Number'}
],
'Training':[
    {k:'ltc',l:'LTC',t:'cb',desc:'Line Training Captain'},
    {k:'Flight Review',l:'Flt Review',t:'Yes/No'},
    {k:'Instrument Proficiency Check (IPC) Received',l:'IPC',t:'Yes/No'},
    {k:'Line Check Flight',l:'Line Check',t:'Yes/No'},
    {k:'Line Training Flight',l:'Line Trng',t:'Yes/No'},
    {k:'Line Training Captain (LTC) Time',l:'LTC Time',t:'Number'},
    {k:'Line Check Airman (LCA) Time',l:'LCA Time',t:'Number'},
    {k:'Base Check/Check-Out',l:'Base Check',t:'Yes/No'},
    {k:'Checkride - ATP',l:'ATP Checkride',t:'Yes/No'},
    {k:'Checkride - Commercial',l:'Comm Checkride',t:'Yes/No'},
    {k:'Checkride - Instrument',l:'Inst Checkride',t:'Yes/No'},
    {k:'PIC Proficiency Check (FAR 61.58)',l:'61.58 Check',t:'Yes/No'},
    {k:'Initial Operating Experience Flight',l:'IOE',t:'Yes/No'}
],
'Operations':[
    {k:'International Flight',l:'Int\'l',t:'Yes/No'},
    {k:'Deadhead',l:'Deadhead',t:'Yes/No'},
    {k:'Diversion',l:'Diversion',t:'Yes/No'},
    {k:'Ferry Flight',l:'Ferry',t:'Yes/No'},
    {k:'Rejected Takeoff',l:'RTO',t:'Yes/No'},
    {k:'V1 Cut',l:'V1 Cut',t:'Yes/No'},
    {k:'Trans-Atlantic Flight',l:'Trans-Atl',t:'Yes/No'},
    {k:'Trans-Pacific Flight',l:'Trans-Pac',t:'Yes/No'},
    {k:'Oceanic Flight',l:'Oceanic',t:'Yes/No'},
    {k:'Revenue Flight',l:'Revenue',t:'Yes/No'},
    {k:'Repositioning Flight',l:'Repo',t:'Yes/No'}
],
'Regs':[
    {k:'Part 91 Flight',l:'Pt 91',t:'Yes/No'},
    {k:'Part 121 Flight',l:'Pt 121',t:'Yes/No'},
    {k:'Part 135 Flight',l:'Pt 135',t:'Yes/No'},
    {k:'Part 705 Flight',l:'Pt 705',t:'Yes/No'},
    {k:'Part 704 Flight',l:'Pt 704',t:'Yes/No'},
    {k:'Part 121 Check Flight',l:'121 Check',t:'Yes/No'},
    {k:'Part 135.293 Competency Check',l:'135.293',t:'Yes/No'},
    {k:'Part 135.297 Instrument Proficiency Check',l:'135.297 IPC',t:'Yes/No'}
],
'Duty':[
    {k:'Block Out Time',l:'Blk Out',t:'DateTime'},
    {k:'Block In Time',l:'Blk In',t:'DateTime'},
    {k:'Pay Time',l:'Pay',t:'Number'},
    {k:'Flight Duty Period Start (UTC)',l:'FDP Start',t:'DateTime'},
    {k:'Flight Duty Period End (UTC)',l:'FDP End',t:'DateTime'},
    {k:'Duty Time Start (UTC)',l:'Duty Start',t:'DateTime'},
    {k:'Duty Time End (UTC)',l:'Duty End',t:'DateTime'},
    {k:'RON (Remain Over Night)',l:'RON',t:'Number'}
]
};

// Base columns - PIC, SIC names derived; Comments always last
// Column order matches export CSV order
const BASE_COLS=[
{k:'Date',l:'Date',t:'date',deletable:false},
{k:'Tail Number',l:'Tail#',t:'text',deletable:true},
{k:'Model',l:'Model',t:'text',deletable:true},
{k:'Total Flight Time',l:'Total',t:'num',isTime:true,deletable:false},
{k:'From',l:'From',t:'text',deletable:false},
{k:'To',l:'To',t:'text',deletable:false},
{k:'role',l:'Role',t:'toggle',deletable:false},
{k:'picName',l:'PIC Name',t:'text',deletable:true},
{k:'sicName',l:'SIC Name',t:'text',deletable:true},
{k:'otherCrew',l:'Other Crew',t:'text',deletable:true},
{k:'IFR Time',l:'IFR',t:'num',deletable:true},
{k:'Day Flight',l:'Day',t:'num',isTime:true,deletable:true},
{k:'Night',l:'Night',t:'num',isTime:true,deletable:true},
{k:'Takeoffs (any)',l:'T/O',t:'cb',deletable:true},
{k:'Landings',l:'Ldg',t:'cb',deletable:true},
{k:'rightSeat',l:'RSeat',t:'cb',deletable:true},
{k:'ETOPS Flight',l:'ETOPS',t:'yn',deletable:true},
{k:'Employer Name',l:'Employer',t:'text',deletable:true},
{k:'Nose Number',l:'Nose#',t:'text',deletable:true},
{k:'flightNumber',l:'Flt#',t:'text',deletable:true}
];

let files=[],rawFlights=[],flights=[],optFields=[],activeCat='Time',showSelf=true,csvData=[],customLabels={};
let detectedPilot='',pilotCounts={},entryMode='upload',hiddenCols=new Set();
let selectedCell={row:-1,col:-1},currentEdit=null,myName='';

const $=id=>document.getElementById(id);
const uploadZone=$('uploadZone'),fileInput=$('fileInput'),fileList=$('fileList'),
pilotDetection=$('pilotDetection'),pilotNameInput=$('pilotName'),pilotNameManual=$('pilotNameManual'),detectedInfo=$('detectedInfo'),
statusMsg=$('statusMessage'),employer=$('employer'),selfToggle=$('selfToggle'),
processBtn=$('processBtn'),manualStartBtn=$('manualStartBtn'),
flightsHead=$('flightsHead'),flightsBody=$('flightsBody'),flightCount=$('flightCount'),
dupCount=$('dupCount'),errCount=$('errCount'),rpCount=$('rpCount'),statsRow=$('statsRow'),
categoryTabs=$('categoryTabs'),fieldsGrid=$('fieldsGrid'),tableScroll=$('tableScroll'),
selectedFields=$('selectedFields'),fieldSearch=$('fieldSearch'),previewHead=$('previewHead'),
previewBody=$('previewBody'),previewCount=$('previewCount'),
uploadSection=$('uploadSection'),manualSection=$('manualSection'),
modeToggle=$('modeToggle'),colDropdown=$('colDropdown'),colDropdownBtn=$('colDropdownBtn'),colDropdownContent=$('colDropdownContent'),
themeToggle=$('themeToggle');

// Theme handling
let currentTheme='dark';
function setTheme(theme){
    currentTheme=theme;
    document.documentElement.setAttribute('data-theme',theme);
    themeToggle.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.theme===theme));
    // Update meta theme-color for mobile browsers
    document.querySelector('meta[name="theme-color"]').content=theme==='dark'?'#0a0f1a':'#f1f5f9';
    try{localStorage.setItem('flightlog_theme',theme)}catch(e){}
}
function loadTheme(){
    try{
        const saved=localStorage.getItem('flightlog_theme');
        // Default to system preference if no saved preference
        if(saved){setTheme(saved)}
        else if(window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches){setTheme('light')}
    }catch(e){}
}
themeToggle.addEventListener('click',e=>{
    const btn=e.target.closest('button');
    if(btn&&btn.dataset.theme)setTheme(btn.dataset.theme);
});
loadTheme();

function loadPrefs(){
    try{
        const p=JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
        if(p.employer)employer.value=p.employer;
        if(p.showSelf!==undefined){showSelf=p.showSelf;selfToggle.classList.toggle('active',!showSelf)}
        if(p.hiddenCols)hiddenCols=new Set(p.hiddenCols);
        if(p.optFields)optFields=p.optFields;
        if(p.customLabels)customLabels=p.customLabels;
        if(p.modelOutputMode){
            modelOutputMode=p.modelOutputMode;
            $('modelModePills').querySelectorAll('.pill').forEach(pl=>pl.classList.toggle('active',pl.dataset.mode===modelOutputMode));
        }
    }catch(e){}
}
function savePrefs(){
    try{localStorage.setItem(STORAGE_KEY,JSON.stringify({employer:employer.value,showSelf,hiddenCols:[...hiddenCols],optFields,customLabels,modelOutputMode}))}catch(e){}
}

modeToggle.addEventListener('click',e=>{
    const btn=e.target.closest('button');if(!btn)return;
    entryMode=btn.dataset.mode;
    modeToggle.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.mode===entryMode));
    uploadSection.classList.toggle('hidden',entryMode==='manual');
    manualSection.classList.toggle('hidden',entryMode==='upload');
    processBtn.classList.toggle('hidden',entryMode==='manual');
    manualStartBtn.classList.toggle('hidden',entryMode==='upload');
});

employer.addEventListener('change',savePrefs);
// Toggle: active (right/blue) = show full Name, inactive (left) = show Self
selfToggle.addEventListener('click',()=>{showSelf=!showSelf;selfToggle.classList.toggle('active',!showSelf);savePrefs();if(flights.length)renderTable()});

uploadZone.addEventListener('click',e=>{if(e.target!==fileInput)fileInput.click()});
uploadZone.addEventListener('dragover',e=>{e.preventDefault();uploadZone.classList.add('dragover')});
uploadZone.addEventListener('dragleave',()=>uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop',e=>{e.preventDefault();uploadZone.classList.remove('dragover');handleFiles(e.dataTransfer.files)});
fileInput.addEventListener('change',e=>handleFiles(e.target.files));

processBtn.addEventListener('click',()=>{
    processBtn.classList.add('loading');
    processBtn.disabled=true;
    setTimeout(()=>{
        processAllFiles();
        processBtn.classList.remove('loading');
        processBtn.disabled=false;
    },100);
});
manualStartBtn.addEventListener('click',startManualEntry);
$('addBtn').addEventListener('click',addNewRow);
$('clearAllBtn').addEventListener('click',clearAllFlights);
function addNewRow(){
    flights.push(createEmptyFlight());
    const newRowIdx=flights.length-1;
    selectedCell={row:newRowIdx,col:0};
    renderTable();
    // Scroll to new row and start editing
    setTimeout(()=>{
        const tr=flightsBody.children[newRowIdx];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
        const cols=getVisibleCols();
        activateCell(newRowIdx,cols[0]);
    },30);
}
function fillColumn(){
    if(selectedCell.row<0||selectedCell.col<0)return;
    const cols=getVisibleCols();
    const col=cols[selectedCell.col];
    if(!col||col.t==='toggle')return;// Can't fill role toggle this way
    const srcFlight=flights[selectedCell.row];
    const val=col.isOpt?(srcFlight.opt[col.k]||''):(srcFlight[col.k]||'');
    if(!val){showStatus('Select a cell with a value first','warning');return}
    saveUndo();
    flights.forEach(f=>{
        if(col.isOpt)f.opt[col.k]=val;
        else if(col.t==='cb')f[col.k]=srcFlight[col.k];
        else if(col.t==='yn')f[col.k]=val;
        else f[col.k]=val;
    });
    showStatus(`Filled ${flights.length} rows with "${val}"`,'success');
    renderTable();
}
function scrollToCell(row,col){
    setTimeout(()=>{
        const tr=flightsBody.children[row];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
    },10);
}
$('allPicBtn').addEventListener('click',()=>{saveUndo();flights.forEach(f=>{f.role='PIC';f.assumedRP=false;updatePilotNames(f)});renderTable()});
$('allSicBtn').addEventListener('click',()=>{saveUndo();flights.forEach(f=>{f.role='SIC';f.assumedRP=false;updatePilotNames(f)});renderTable()});
$('allRpBtn').addEventListener('click',()=>{saveUndo();flights.forEach(f=>{f.role='RP';f.assumedRP=false;updatePilotNames(f)});renderTable()});
$('resetRolesBtn').addEventListener('click',()=>{
    saveUndo();
    flights.forEach((f,i)=>{
        if(!f._original)return;
        const orig=f._original;
        // Restore all editable fields from original
        Object.keys(orig).forEach(k=>{if(k!=='_original')f[k]=typeof orig[k]==='object'?JSON.parse(JSON.stringify(orig[k])):orig[k]});
    });
    detectDups();validateAllTimes();renderTable();
    showStatus('All changes reset to original file values.','success');
});
$('confirmRpBtn').addEventListener('click',()=>{flights.forEach(f=>{if(f.assumedRP)f.assumedRP=false});renderTable();showStatus('All assumed RP flights confirmed.','success')});

// Model output mode controls
$('modelModePills').addEventListener('click',e=>{
    const pill=e.target.closest('.pill');
    if(!pill)return;
    modelOutputMode=pill.dataset.mode;
    $('modelModePills').querySelectorAll('.pill').forEach(p=>p.classList.toggle('active',p.dataset.mode===modelOutputMode));
    flights.forEach(f=>{f.Model=getModelForOutput(f)});
    if(flights.length)renderTable();
    savePrefs();
});

// Catalog modal functions
function renderCatalogTable(){
    const search=($('catalogSearch').value||'').toLowerCase().trim();
    const familyFilter=$('catalogFamilyFilter').value;
    const tbody=$('catalogTableBody');
    tbody.innerHTML='';
    let count=0;
    AIRCRAFT_CATALOG_RAW.forEach(ac=>{
        if(familyFilter&&ac.family!==familyFilter)return;
        if(search){
            const searchStr=`${ac.reg} ${ac.fin} ${ac.variant} ${ac.sub} ${ac.msn}`.toLowerCase();
            if(!searchStr.includes(search))return;
        }
        count++;
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${ac.reg}</td><td>${ac.fin}</td><td>${ac.family}</td><td>${ac.variant}</td><td>${ac.sub||'-'}</td><td>${ac.msn||'-'}</td>`;
        tbody.appendChild(tr);
    });
    $('catalogCount').textContent=`${count} aircraft`;
}

function openCatalogModal(){
    $('catalogSearch').value='';
    $('catalogFamilyFilter').value='';
    renderCatalogTable();
    $('catalogModal').style.display='flex';
}

function closeCatalogModal(){
    $('catalogModal').style.display='none';
}

$('catalogBtn').addEventListener('click',openCatalogModal);
$('closeCatalogBtn').addEventListener('click',closeCatalogModal);
$('catalogModal').addEventListener('click',e=>{if(e.target===$('catalogModal'))closeCatalogModal()});
$('catalogSearch').addEventListener('input',renderCatalogTable);
$('catalogFamilyFilter').addEventListener('change',renderCatalogTable);

// Feedback modal functions
function openFeedbackModal(){
    $('feedbackForm').reset();
    $('aircraftField').style.display='none';
    $('feedbackStatus').style.display='none';
    $('feedbackSubmitBtn').disabled=false;
    $('feedbackSubmitBtn').textContent='Send Feedback';
    $('feedbackModal').style.display='flex';
}

function closeFeedbackModal(){
    $('feedbackModal').style.display='none';
}

function handleFeedbackTypeChange(){
    const type=$('feedbackType').value;
    $('aircraftField').style.display=type==='Missing Aircraft'?'block':'none';
}

async function submitFeedback(e){
    e.preventDefault();
    const btn=$('feedbackSubmitBtn');
    const status=$('feedbackStatus');

    btn.disabled=true;
    btn.textContent='Sending...';
    status.style.display='none';

    const formData=new FormData($('feedbackForm'));

    try{
        const response=await fetch('https://formspree.io/f/xlgbkoyn',{
            method:'POST',
            body:formData,
            headers:{'Accept':'application/json'}
        });

        if(response.ok){
            status.textContent='Thanks for your feedback!';
            status.className='feedback-status success';
            status.style.display='block';
            btn.textContent='Sent!';
            setTimeout(closeFeedbackModal,2000);
        }else{
            throw new Error('Failed to send');
        }
    }catch(err){
        status.textContent='Failed to send. Please try again.';
        status.className='feedback-status error';
        status.style.display='block';
        btn.disabled=false;
        btn.textContent='Send Feedback';
    }
}

$('feedbackBtn').addEventListener('click',e=>{e.preventDefault();openFeedbackModal()});
$('closeFeedbackBtn').addEventListener('click',closeFeedbackModal);
$('feedbackModal').addEventListener('click',e=>{if(e.target===$('feedbackModal'))closeFeedbackModal()});
$('feedbackType').addEventListener('change',handleFeedbackTypeChange);
$('feedbackForm').addEventListener('submit',submitFeedback);

$('backBtn1').addEventListener('click',()=>goToStep(1));
$('previewBtn').addEventListener('click',generatePreview);
$('backBtn2').addEventListener('click',()=>goToStep(2));
$('downloadBtn').addEventListener('click',downloadCSV);
fieldSearch.addEventListener('input',renderFieldsGrid);

colDropdownBtn.addEventListener('click',e=>{e.stopPropagation();colDropdown.classList.toggle('open');renderColDropdown()});
document.addEventListener('click',()=>colDropdown.classList.remove('open'));

// Global keyboard shortcuts
document.addEventListener('keydown',e=>{
    const inInput=document.activeElement.tagName==='INPUT'&&document.activeElement.type!=='checkbox';
    const cols=getVisibleCols();
    
    // Ctrl+Z: Undo
    if(e.ctrlKey&&e.key==='z'&&!e.shiftKey){
        e.preventDefault();
        doUndo();
        return;
    }
    
    // Ctrl+N: Add new row
    if(e.ctrlKey&&e.key==='n'){
        e.preventDefault();
        addNewRow();
        return;
    }
    
    // Ctrl+Shift+F: Fill column with current cell value
    if(e.ctrlKey&&e.shiftKey&&(e.key==='F'||e.key==='f')&&selectedCell.row>=0){
        e.preventDefault();
        fillColumn();
        return;
    }
    
    // Ctrl+Delete or Ctrl+Backspace: Delete current row
    if(e.ctrlKey&&(e.key==='Delete'||e.key==='Backspace')&&selectedCell.row>=0&&!inInput){
        e.preventDefault();
        delFlight(selectedCell.row);
        return;
    }
    
    // Don't process other keys if in text input
    if(inInput)return;
    if(!flights.length)return;
    
    // F2 or Enter: Enter edit mode on selected cell
    if((e.key==='F2'||e.key==='Enter')&&selectedCell.row>=0&&!currentEdit){
        e.preventDefault();
        const col=cols[selectedCell.col];
        if(col)activateCell(selectedCell.row,col);
        return;
    }
    
    // Delete/Backspace: Clear current cell
    if((e.key==='Delete'||e.key==='Backspace')&&selectedCell.row>=0&&!currentEdit&&!e.ctrlKey){
        e.preventDefault();
        const col=cols[selectedCell.col];
        if(col&&!['toggle','cb','yn'].includes(col.t)){
            saveUndo();
            if(col.isOpt)flights[selectedCell.row].opt[col.k]='';
            else flights[selectedCell.row][col.k]='';
            const el=flightsBody.querySelector(`[data-i="${selectedCell.row}"][data-k="${col.k}"].editable`);
            if(el)el.textContent='\u00A0';
            updateStats();
        }
        return;
    }
    
    // Home: Go to first cell of row (Ctrl+Home = first cell of table)
    if(e.key==='Home'&&selectedCell.row>=0){
        e.preventDefault();
        const targetRow=e.ctrlKey?0:selectedCell.row;
        selectCell(targetRow,0);
        const tr=flightsBody.children[targetRow];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
        return;
    }
    
    // End: Go to last cell of row (Ctrl+End = last cell of table)
    if(e.key==='End'&&selectedCell.row>=0){
        e.preventDefault();
        const lastCol=cols.length-1;
        const targetRow=e.ctrlKey?flights.length-1:selectedCell.row;
        selectCell(targetRow,lastCol);
        const tr=flightsBody.children[targetRow];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
        return;
    }
    
    // Arrow key navigation
    if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)&&selectedCell.row>=0){
        e.preventDefault();
        let{row,col}=selectedCell;
        if(e.key==='ArrowUp'){row--;if(row<0)row=flights.length-1}
        else if(e.key==='ArrowDown'){row++;if(row>=flights.length)row=0}
        else if(e.key==='ArrowLeft'){col--;if(col<0){col=cols.length-1;row--;if(row<0)row=flights.length-1}}
        else if(e.key==='ArrowRight'){col++;if(col>=cols.length){col=0;row++;if(row>=flights.length)row=0}}
        selectCell(row,col);
        const tr=flightsBody.children[row];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
    }
});

flightsBody.addEventListener('click',e=>{
    const td=e.target.closest('td');
    if(!td||td.classList.contains('sticky-col'))return;
    const tr=td.closest('tr');if(!tr)return;
    const rowIdx=[...flightsBody.children].indexOf(tr);
    const colIdx=[...tr.children].indexOf(td)-1;
    if(rowIdx>=0&&colIdx>=0)selectCell(rowIdx,colIdx);
    
    const ed=e.target.closest('.editable');
    if(ed){const cols=getVisibleCols();activateCell(rowIdx,cols[colIdx])}
    const del=e.target.closest('.delete-btn');
    if(del)delFlight(parseInt(del.dataset.del));
    const rb=e.target.closest('.role-toggle button');
    if(rb){
        const i=parseInt(rb.dataset.i);
        flights[i].role=rb.dataset.r;
        flights[i].assumedRP=false; // User confirmed the role
        updatePilotNames(flights[i]);
        renderTable();
    }
});
flightsBody.addEventListener('change',e=>{
    if(e.target.classList.contains('flight-checkbox')){
        const i=parseInt(e.target.dataset.i),k=e.target.dataset.k,isOpt=e.target.dataset.opt==='1';
        if(isOpt){
            // For optional checkbox fields like ltc, store as boolean for special handling
            if(k==='ltc')flights[i].opt[k]=e.target.checked;
            else flights[i].opt[k]=e.target.checked?'Yes':'';
        }
        else if(k==='rightSeat'||k==='Takeoffs (any)'||k==='Landings')flights[i][k]=e.target.checked;
        else flights[i][k]=e.target.checked?'Yes':'';
        updateStats();
    }
});
flightsBody.addEventListener('keydown',e=>{
    const cb=e.target.closest('.flight-checkbox');
    const rb=e.target.closest('.role-toggle button');
    
    if(e.key==='Tab'&&(cb||rb)){
        e.preventDefault();
        const cols=getVisibleCols();
        let{row,col}=selectedCell;
        if(e.shiftKey){col--;if(col<0){col=cols.length-1;row--;if(row<0)row=flights.length-1}}
        else{col++;if(col>=cols.length){col=0;row++;if(row>=flights.length)row=0}}
        selectCell(row,col);
        const tr=flightsBody.children[row];
        if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
        activateCell(row,cols[col]);
    }
    // Arrow keys for role toggle
    if(rb&&(e.key==='ArrowLeft'||e.key==='ArrowRight')){
        e.preventDefault();
        const i=parseInt(rb.dataset.i);
        const roles=['PIC','SIC','RP'];
        const curIdx=roles.indexOf(flights[i].role);
        const newIdx=e.key==='ArrowRight'?(curIdx+1)%3:(curIdx+2)%3;
        flights[i].role=roles[newIdx];
        flights[i].assumedRP=false; // User confirmed the role
        updatePilotNames(flights[i]);
        // Update just the role buttons and pilot name cells without full re-render
        const btns=flightsBody.querySelectorAll(`.role-toggle button[data-i="${i}"]`);
        btns.forEach(b=>b.classList.toggle('active',b.dataset.r===roles[newIdx]));
        // Re-focus
        const btn=flightsBody.querySelector(`.role-toggle button[data-i="${i}"][data-r="${roles[newIdx]}"]`);
        if(btn)btn.focus();
    }
});

flightsHead.addEventListener('click',e=>{
    const delBtn=e.target.closest('.col-delete');
    if(delBtn){
        const k=delBtn.dataset.k;
        hiddenCols.add(k);
        savePrefs();
        renderTable();
        return;
    }
    const headerLabel=e.target.closest('.header-label');
    if(headerLabel&&!headerLabel.querySelector('input')){
        const k=headerLabel.dataset.k;
        const col=getVisibleCols().find(c=>c.k===k);
        const currentLabel=customLabels[k]||col.l;
        const inp=document.createElement('input');
        inp.type='text';
        inp.value=currentLabel;
        inp.className='header-edit-input';
        inp.style.cssText='width:100%;font-size:inherit;font-weight:inherit;padding:0;border:1px solid var(--blue);background:var(--bg);color:inherit;border-radius:2px;text-align:center';
        headerLabel.innerHTML='';
        headerLabel.appendChild(inp);
        inp.focus();
        inp.select();
        const finish=(save)=>{
            if(save&&inp.value.trim()){
                if(inp.value.trim()!==col.l)customLabels[k]=inp.value.trim();
                else delete customLabels[k];
                savePrefs();
            }
            renderTable();
        };
        inp.addEventListener('blur',()=>finish(true));
        inp.addEventListener('keydown',ev=>{
            if(ev.key==='Enter'){ev.preventDefault();finish(true)}
            else if(ev.key==='Escape'){ev.preventDefault();finish(false)}
        });
    }
});

loadPrefs();initCatTabs();renderFieldsGrid();

function parseTimeToMinutes(t){if(!t)return 0;t=String(t).trim();const hm=t.match(/^(\d+):(\d+)$/);if(hm)return parseInt(hm[1])*60+parseInt(hm[2]);const d=parseFloat(t);return isNaN(d)?0:Math.round(d*60)}
function minutesToDisplay(m){return m?(m/60).toFixed(1):''}

function updatePilotNames(f){
    const self=showSelf?'Self':myName;
    if(f.role==='PIC'){
        f.picName=self;
        f.sicName=f.origOtherPilot||'';
        f.otherCrew=f.origOtherCrew||'';
    }else if(f.role==='SIC'){
        f.picName=f.origOtherPilot||'';
        f.sicName=self;
        f.otherCrew=f.origOtherCrew||'';
    }else{// RP
        f.picName=f.origPicName||'';
        f.sicName=f.origSicName||'';
        // User is other crew when RP
        // Don't duplicate if pilot is already listed in origOtherCrew
        if(f.origOtherCrew && f.origOtherCrew.trim()===myName){
            f.otherCrew=self; // Replace their name with Self display
        }else if(f.origOtherCrew){
            f.otherCrew=f.origOtherCrew+', '+self; // Add to existing crew
        }else{
            f.otherCrew=self; // No existing crew, just Self
        }
    }
}

function startManualEntry(){
    myName=pilotNameManual.value.trim();
    if(!myName){showStatus('Enter your name.','error');return}
    flights=[createEmptyFlight()];goToStep(2);renderTable();
}
function createEmptyFlight(){
    const f={sortDate:'',Date:'',flightNumber:'',From:'',To:'','Tail Number':'',Model:'',modelUnmapped:false,'Nose Number':'','Employer Name':employer.value,totalMinutes:0,dayMinutes:0,nightMinutes:0,'Total Flight Time':'','Day Flight':'','Night':'','IFR Time':'','Takeoffs (any)':false,'Landings':false,'ETOPS Flight':'',role:'PIC',assumedRP:false,rightSeat:false,origRole:'PIC',origAssumedRP:false,origPicName:'',origSicName:'',origOtherPilot:'',origOtherCrew:'',picName:'',sicName:'',otherCrew:'',Comments:'',isDup:false,hasTimeError:false,hasRoundingNotice:false,opt:{},_variantInfo:null,family:'',variant:'',variantSource:'',variantConflict:false,originalTypeCode:''};
    updatePilotNames(f);
    return f;
}

async function handleFiles(f){
    for(let x of f)if(!files.find(y=>y.name===x.name))files.push(x);
    renderFileList();rawFlights=[];pilotCounts={};
    for(let file of files){const c=await readFile(file);parseFileRaw(c)}
    let maxCount=0;detectedPilot='';
    for(let name in pilotCounts)if(pilotCounts[name]>maxCount){maxCount=pilotCounts[name];detectedPilot=name}
    if(detectedPilot){pilotDetection.classList.add('visible');pilotNameInput.value=detectedPilot;detectedInfo.textContent=`${maxCount}/${rawFlights.length} flights`}
    processBtn.disabled=!files.length;
    if(files.length)uploadZone.classList.add('has-file');
}
function renderFileList(){
    fileList.innerHTML=files.map((f,i)=>`<div class="file-item"><span><svg class="icon" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg> ${f.name}</span><button data-idx="${i}"><svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>`).join('');
    fileList.querySelectorAll('button').forEach(btn=>btn.onclick=e=>{
        files.splice(parseInt(e.target.dataset.idx),1);renderFileList();
        processBtn.disabled=!files.length;
        if(!files.length){uploadZone.classList.remove('has-file');pilotDetection.classList.remove('visible');rawFlights=[]}
    });
}
function readFile(f){return new Promise(r=>{const x=new FileReader();x.onload=e=>r(e.target.result);x.readAsText(f)})}
function parseFileRaw(c){
    const lines=c.split(/\r?\n/);let hdr=-1;
    for(let i=0;i<Math.min(10,lines.length);i++)if(lines[i].includes('Date')&&lines[i].includes('Type')){hdr=i;break}
    if(hdr===-1)return;
    for(let i=hdr+1;i<lines.length;i++){
        const ln=lines[i];if(!ln.trim())continue;
        const col=ln.split('\t');if(col.length<12)continue;
        const ds=col[0].trim();if(!ds||ds.toLowerCase().includes('total')||!/^[A-Za-z]{3}\s+\d{1,2}\s+\d{4}/.test(ds))continue;
        const pic=(col[5]||'').trim(),sic=(col[6]||'').trim(),crew=(col[7]||'').trim(),type=(col[1]||'').trim();
        if(pic)pilotCounts[pic]=(pilotCounts[pic]||0)+1;
        if(sic)pilotCounts[sic]=(pilotCounts[sic]||0)+1;
        if(crew)pilotCounts[crew]=(pilotCounts[crew]||0)+1;
        rawFlights.push({dateStr:ds,type,reg:(col[2]||'').trim(),fin:(col[3]||'').trim(),fltNum:(col[4]||'').trim(),picNameRaw:pic,sicNameRaw:sic,otherCrew:crew,from:(col[8]||'').trim(),to:(col[10]||'').trim(),ifrTime:(col[12]||'').trim(),dayTime:(col[14]||'').trim(),nightTime:(col[15]||'').trim(),takeoffFlag:(col[20]||'').trim().toUpperCase(),landingFlag:(col[21]||'').trim().toUpperCase(),rightSeatFlag:(col[22]||'').trim().toUpperCase(),etopsFlag:(col[23]||'').trim().toUpperCase()});
    }
}
function processAllFiles(){
    myName=pilotNameInput.value.trim();
    if(!myName){showStatus('Enter pilot name.','error');return}
    flights=[];
    rawFlights.forEach(rf=>{
        const dt=convDate(rf.dateStr);
        // Determine role: PIC > SIC > RP (in Other Crew) > Assumed RP (not listed)
        const iAmPic=rf.picNameRaw.trim()===myName;
        const iAmSic=rf.sicNameRaw.trim()===myName;
        const iAmOtherCrew=rf.otherCrew.trim()===myName;
        let role='RP',assumedRP=false;
        if(iAmPic)role='PIC';
        else if(iAmSic)role='SIC';
        else if(iAmOtherCrew)role='RP';
        else{role='RP';assumedRP=true;} // Not listed anywhere - assume RP

        const otherPilot=iAmPic?rf.sicNameRaw:rf.picNameRaw;
        const totalMins=parseTimeToMinutes(rf.ifrTime||rf.dayTime),dayMins=parseTimeToMinutes(rf.dayTime),nightMins=parseTimeToMinutes(rf.nightTime);

        // Resolve aircraft variant using catalog
        const variantInfo=resolveAircraftVariant({
            registration:rf.reg,
            fin:rf.fin,
            nose:extNose(rf.fin),
            typeCode:rf.type
        });
        const model=getModelForOutput({_variantInfo:variantInfo});
        const unmapped=variantInfo.source==='fallback';

        const f={
            sortDate:dt,Date:dt,flightNumber:cleanFlt(rf.fltNum),From:rf.from,To:rf.to,
            'Tail Number':fmtTail(rf.reg),Model:model,modelUnmapped:unmapped,
            // Aircraft variant resolution data
            _variantInfo:variantInfo,
            family:variantInfo.family,
            variant:variantInfo.variant,
            variantSource:variantInfo.source,
            variantConflict:variantInfo.conflict,
            originalTypeCode:rf.type,
            'Nose Number':extNose(rf.fin),'Employer Name':employer.value,
            totalMinutes:totalMins,dayMinutes:dayMins,nightMinutes:nightMins,
            'Total Flight Time':minutesToDisplay(totalMins),
            'Day Flight':minutesToDisplay(dayMins),'Night':minutesToDisplay(nightMins),
            'IFR Time':minutesToDisplay(parseTimeToMinutes(rf.ifrTime)),
            'Takeoffs (any)':rf.takeoffFlag==='Y','Landings':rf.landingFlag==='Y',
            'ETOPS Flight':rf.etopsFlag==='Y'?'Yes':'',
            role:role,assumedRP:assumedRP,rightSeat:rf.rightSeatFlag==='Y',ltc:false,
            // Store originals for swapping and reset
            origRole:role,origAssumedRP:assumedRP,
            origPicName:rf.picNameRaw,origSicName:rf.sicNameRaw,
            origOtherPilot:otherPilot,origOtherCrew:rf.otherCrew,
            picName:'',sicName:'',otherCrew:'',
            Comments:'',isDup:false,hasTimeError:false,hasRoundingNotice:false,opt:{}
        };
        updatePilotNames(f);
        // Store original state for full reset
        f._original=JSON.parse(JSON.stringify({...f,opt:{...f.opt}}));
        flights.push(f);
    });
    if(!flights.length){showStatus('No flights found.','error');return}
    flights.sort((a,b)=>new Date(a.sortDate)-new Date(b.sortDate));
    detectDups();validateAllTimes();
    const hasAssumedRP=flights.some(f=>f.assumedRP);
    let msg=`Loaded ${flights.length} flights.`;
    if(hasAssumedRP)msg+=` ${flights.filter(f=>f.assumedRP).length} flight(s) marked as assumed RP - please verify.`;
    showStatus(msg,flights.some(f=>f.isDup||f.hasTimeError||f.assumedRP)?'warning':'success');
    setTimeout(()=>{goToStep(2);renderTable()},300);
}
function detectDups(){const m=new Map();flights.forEach(f=>{const k=f.Date+'_'+f.flightNumber+'_'+f.From+'_'+f.To;if(m.has(k)){f.isDup=true;m.get(k).isDup=true}else m.set(k,f)})}
function validateAllTimes(){flights.forEach(validateFlightTime)}
function validateFlightTime(f){
    const t=f.totalMinutes||0,d=f.dayMinutes||0,n=f.nightMinutes||0;
    f.hasTimeError=false;f.hasRoundingNotice=false;
    if(!t&&!d&&!n)return;
    const diff=Math.abs(t-(d+n));
    if(diff===0)return;
    if(diff<=1){const dt=parseFloat(f['Total Flight Time'])||0,dd=parseFloat(f['Day Flight'])||0,dn=parseFloat(f['Night'])||0;if(Math.abs(dt-Math.round((dd+dn)*10)/10)>0.05)f.hasRoundingNotice=true}
    else f.hasTimeError=true;
}
function autoCalcTime(f,field){
    if(field==='Total Flight Time')f.totalMinutes=parseTimeToMinutes(f['Total Flight Time']);
    else if(field==='Day Flight')f.dayMinutes=parseTimeToMinutes(f['Day Flight']);
    else if(field==='Night')f.nightMinutes=parseTimeToMinutes(f['Night']);
    const t=f.totalMinutes||0,d=f.dayMinutes||0,n=f.nightMinutes||0;
    if(field==='Day Flight'||field==='Night'){f.totalMinutes=d+n;f['Total Flight Time']=minutesToDisplay(d+n)}
    else if(field==='Total Flight Time'){
        if(t>0&&d>0&&!n){f.nightMinutes=Math.max(0,t-d);f['Night']=minutesToDisplay(f.nightMinutes)}
        else if(t>0&&n>0&&!d){f.dayMinutes=Math.max(0,t-n);f['Day Flight']=minutesToDisplay(f.dayMinutes)}
    }
    validateFlightTime(f);
}

function getVisibleCols(){
    // Filter hidden, add optFields, then Comments last
    let cols=BASE_COLS.filter(c=>!hiddenCols.has(c.k));
    optFields.forEach(k=>{const f=findF(k);if(f&&!hiddenCols.has(k))cols.push({k:f.k,l:f.l,t:f.t,isOpt:true,deletable:true})});
    cols.push({k:'Comments',l:'Comments',t:'text',deletable:true});
    return cols;
}

function getAllColKeys(){
    // All possible columns for dropdown
    const all=[...BASE_COLS.map(c=>({k:c.k,l:c.l}))];
    optFields.forEach(k=>{const f=findF(k);if(f)all.push({k:f.k,l:f.l})});
    all.push({k:'Comments',l:'Comments'});
    return all;
}

function renderColDropdown(){
    const all=getAllColKeys();
    colDropdownContent.innerHTML=all.map(c=>`<label class="dropdown-item"><input type="checkbox" data-k="${c.k}" ${hiddenCols.has(c.k)?'':'checked'}> ${c.l}</label>`).join('');
    colDropdownContent.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('change',e=>{
            const k=e.target.dataset.k;
            if(e.target.checked)hiddenCols.delete(k);
            else hiddenCols.add(k);
            savePrefs();renderTable();
        });
    });
}

function selectCell(row,col){
    selectedCell={row,col};
    flightsBody.querySelectorAll('td.selected-cell').forEach(td=>td.classList.remove('selected-cell'));
    const tr=flightsBody.children[row];
    if(tr){
        const td=tr.children[col+1];// +1 for sticky # col
        if(td)td.classList.add('selected-cell');
    }
}

function activateCell(row,col){
    const f=flights[row];if(!f)return;
    const k=col.k,t=col.t;
    if(t==='cb'||t==='yn'){
        // Just focus checkbox, don't toggle it - user can press Space to toggle
        const cb=flightsBody.querySelector(`input[data-i="${row}"][data-k="${k}"]`);
        if(cb)cb.focus();
    }else if(t==='toggle'){
        // Focus first button of role toggle
        const btn=flightsBody.querySelector(`.role-toggle button[data-i="${row}"]`);
        if(btn)btn.focus();
    }else{
        // Text, number, date fields - enter edit mode
        const el=flightsBody.querySelector(`[data-i="${row}"][data-k="${k}"].editable`);
        if(el)startEdit(el,row,k,t,col.isOpt);
    }
}

function renderTable(){
    const cols=getVisibleCols();
    let h='<tr><th class="sticky-col">#</th>';
    cols.forEach(c=>{
        const del=c.deletable!==false?`<button class="col-delete" data-k="${c.k}">×</button>`:'';
        const label=customLabels[c.k]||c.l;
        h+=`<th class="${['cb','toggle','yn'].includes(c.t)?'center':''}"><span class="header-label" data-k="${c.k}" title="Click to edit">${label}</span>${del}</th>`;
    });
    h+='<th></th></tr>';flightsHead.innerHTML=h;
    
    let b='';
    flights.forEach((f,i)=>{
        // Update pilot names in case showSelf changed
        updatePilotNames(f);
        let cls=f.hasTimeError?'time-error':f.hasRoundingNotice?'rounding-notice':f.isDup?'duplicate':f.assumedRP?'assumed-rp':'';
        b+=`<tr class="${cls}"><td class="sticky-col">`;
        if(f.hasTimeError)b+='<span class="badge err-badge">ERR</span>';
        else if(f.hasRoundingNotice)b+='<span class="badge info-badge">~</span>';
        else if(f.isDup)b+='<span class="badge dup-badge">DUP</span>';
        else if(f.assumedRP)b+='<span class="badge rp-badge" title="Not listed as PIC/SIC/Other Crew - assumed Relief Pilot">RP?</span>';
        b+=`${i+1}</td>`;
        cols.forEach((c,ci)=>{
            const isSelected=selectedCell.row===i&&selectedCell.col===ci;
            b+=renderCell(f,c,i,isSelected);
        });
        b+=`<td><button class="delete-btn" data-del="${i}">🗑</button></td></tr>`;
    });
    flightsBody.innerHTML=b;
    flightCount.textContent=flights.length;
    const dc=flights.filter(x=>x.isDup).length,ec=flights.filter(x=>x.hasTimeError).length,rc=flights.filter(x=>x.assumedRP).length;
    dupCount.style.display=dc?'inline':'none';dupCount.textContent=dc+' dup';
    errCount.style.display=ec?'inline':'none';errCount.textContent=ec+' err';
    rpCount.style.display=rc?'inline':'none';rpCount.textContent=rc+' RP?';
    $('confirmRpBtn').style.display=rc?'inline-block':'none';
    updateStats();renderSelFields();
}

function renderCell(f,c,i,isSelected){
    const v=c.isOpt?(f.opt[c.k]||''):f[c.k];
    const selClass=isSelected?' selected-cell':'';
    if(c.t==='cb')return `<td class="center${selClass}"><input type="checkbox" class="flight-checkbox" data-i="${i}" data-k="${c.k}" ${c.isOpt?'data-opt="1"':''} ${v?'checked':''}></td>`;
    if(c.t==='yn')return `<td class="center${selClass}"><input type="checkbox" class="flight-checkbox" data-i="${i}" data-k="${c.k}" ${c.isOpt?'data-opt="1"':''} ${v==='Yes'?'checked':''}></td>`;
    if(c.t==='toggle')return `<td class="center${selClass}"><div class="role-toggle"><button data-i="${i}" data-r="PIC" data-k="role" class="${f.role==='PIC'?'active':''}">PIC</button><button data-i="${i}" data-r="SIC" data-k="role" class="${f.role==='SIC'?'active':''}">SIC</button><button data-i="${i}" data-r="RP" data-k="role" class="${f.role==='RP'?'active':''}">RP</button></div></td>`;
    
    let cls=c.isTime?'cell-time time-cell':['From','To'].includes(c.k)?'cell-route':['picName','sicName','otherCrew'].includes(c.k)?'cell-pilot':c.k==='Model'?'cell-model':'';
    let extra='';
    let displayVal=v;
    // Special handling for Model column - use variant resolution
    if(c.k==='Model'){
        displayVal=getModelForOutput(f)||v||'';
        if(f.variantConflict)extra+='<span class="badge conflict-badge" title="Identifiers resolved to different variants">!</span>';
        if(f.variantSource==='fallback')extra+='<span class="badge unmapped-badge" title="No catalog match">?</span>';
    }
    const optAttr=c.isOpt?'data-opt="1"':'data-opt="0"';
    return `<td class="${cls}${selClass}"><span class="editable" data-i="${i}" data-k="${c.k}" data-t="${c.t}" ${optAttr}>${displayVal||'&nbsp;'}</span>${extra}</td>`;
}

function startEdit(el,i,k,t,isOpt){
    if(currentEdit)finishEdit(true);
    currentEdit={el,i,k,t,isOpt};
    const cur=isOpt?(flights[i].opt[k]||''):(flights[i][k]||'');
    const inp=document.createElement('input');
    if(t==='num'||t==='Number'){inp.type='number';inp.step='0.1';inp.min='0'}
    else if(t==='DateTime')inp.type='datetime-local';
    else if(t==='date'){inp.type='date';if(cur){const p=cur.split('/');if(p.length===3)inp.value=p[2]+'-'+p[0].padStart(2,'0')+'-'+p[1].padStart(2,'0')}}
    else{inp.type='text';inp.value=cur}
    if(t!=='date')inp.value=cur;
    inp.className='edit-input';
    inp.addEventListener('blur',()=>setTimeout(()=>{if(currentEdit)finishEdit(true)},50));
    inp.addEventListener('keydown',e=>{
        if(e.key==='Enter'){e.preventDefault();finishEdit(true)}
        else if(e.key==='Escape'){e.preventDefault();finishEdit(false)}
        else if(e.key==='Tab'){
            e.preventDefault();
            const cols=getVisibleCols();
            let{row,col}=selectedCell;
            if(e.shiftKey){col--;if(col<0){col=cols.length-1;row--;if(row<0)row=flights.length-1}}
            else{col++;if(col>=cols.length){col=0;row++;if(row>=flights.length)row=0}}
            // Finish edit, then navigate
            finishEdit(true,()=>{
                selectCell(row,col);
                // Scroll the row into view
                const tr=flightsBody.children[row];
                if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
                activateCell(row,cols[col]);
            });
        }
        else if(e.key==='ArrowDown'||e.key==='ArrowUp'){
            e.preventDefault();
            let{row,col}=selectedCell;
            row+=e.key==='ArrowDown'?1:-1;
            if(row<0)row=flights.length-1;
            if(row>=flights.length)row=0;
            finishEdit(true,()=>{
                selectCell(row,col);
                const tr=flightsBody.children[row];
                if(tr)tr.scrollIntoView({block:'nearest',behavior:'instant'});
                const cols=getVisibleCols();
                activateCell(row,cols[col]);
            });
        }
    });
    el.style.display='none';el.parentNode.insertBefore(inp,el);inp.focus();if(t!=='date')inp.select();
}

function finishEdit(save,andThen){
    if(!currentEdit)return;
    const{el,i,k,t,isOpt}=currentEdit;
    const inp=el.parentNode.querySelector('.edit-input');
    if(save&&inp){
        let v=inp.value.trim();
        if((t==='num'||t==='Number')&&v)v=parseFloat(v)?parseFloat(v).toFixed(1):v;
        else if(t==='DateTime'&&v){const dt=new Date(v);if(!isNaN(dt))v=(dt.getMonth()+1)+'/'+dt.getDate()+'/'+dt.getFullYear()+' '+dt.getHours().toString().padStart(2,'0')+':'+dt.getMinutes().toString().padStart(2,'0')}
        else if(t==='date'&&v){const p=v.split('-');if(p.length===3)v=parseInt(p[1])+'/'+parseInt(p[2])+'/'+p[0]}
        // Save undo state before making changes
        const oldVal=isOpt?(flights[i].opt[k]||''):(flights[i][k]||'');
        if(v!==oldVal)saveUndo();
        if(isOpt)flights[i].opt[k]=v;
        else{flights[i][k]=v;if(['Total Flight Time','Day Flight','Night'].includes(k))autoCalcTime(flights[i],k)}
        // Update cell text in place without full re-render
        el.textContent=v||'\u00A0';
    }
    if(inp)inp.remove();
    el.style.display='';
    currentEdit=null;
    // Only do full render if we need to update stats/validation, otherwise skip
    if(save&&['Total Flight Time','Day Flight','Night'].includes(k)){
        const scrollTop=tableScroll.scrollTop;
        const scrollLeft=tableScroll.scrollLeft;
        renderTable();
        tableScroll.scrollTop=scrollTop;
        tableScroll.scrollLeft=scrollLeft;
    }else{
        updateStats();
    }
    if(andThen)andThen();
}

function delFlight(i){
    saveUndo();
    flights.splice(i,1);
    if(flights.length){
        detectDups();validateAllTimes();
        if(selectedCell.row>=flights.length)selectedCell.row=flights.length-1;
    }else{
        selectedCell={row:-1,col:-1};
    }
    renderTable();
}

function clearAllFlights(){
    if(!flights.length)return;
    if(!confirm('Delete all '+flights.length+' flights?'))return;
    saveUndo();
    flights=[];
    selectedCell={row:-1,col:-1};
    renderTable();
    showStatus('All flights cleared','success');
}

function initCatTabs(){
    categoryTabs.innerHTML=Object.keys(CATS).map(c=>`<div class="category-tab ${c===activeCat?'active':''}" data-cat="${c}">${c}</div>`).join('');
    categoryTabs.onclick=e=>{if(e.target.classList.contains('category-tab')){activeCat=e.target.dataset.cat;document.querySelectorAll('.category-tab').forEach(x=>x.classList.toggle('active',x.dataset.cat===activeCat));renderFieldsGrid()}}
}
function renderFieldsGrid(){
    const s=(fieldSearch.value||'').toLowerCase();
    let arr=CATS[activeCat]||[];
    if(s){arr=[];Object.values(CATS).forEach(fs=>fs.forEach(f=>{if(f.l.toLowerCase().includes(s)||f.k.toLowerCase().includes(s))arr.push(f)}))}
    fieldsGrid.innerHTML=arr.map(f=>`<div class="field-item ${optFields.includes(f.k)?'selected':''}" data-fk="${f.k}"><input type="checkbox" ${optFields.includes(f.k)?'checked':''}><span class="field-name">${f.l}</span><span class="field-type">${f.t}</span></div>`).join('');
    fieldsGrid.querySelectorAll('.field-item').forEach(fi=>fi.onclick=()=>{
        const k=fi.dataset.fk,idx=optFields.indexOf(k);
        if(idx>-1)optFields.splice(idx,1);else optFields.push(k);
        savePrefs();renderFieldsGrid();if(flights.length)renderTable();
    });
}
function renderSelFields(){
    if(!optFields.length){selectedFields.innerHTML='<span style="font-size:.5rem;color:var(--muted)">None</span>';return}
    selectedFields.innerHTML=optFields.map((k,idx)=>{
        const f=findF(k);
        const leftBtn=idx>0?`<button class="reorder-btn" data-dir="left" data-idx="${idx}">←</button>`:'';
        const rightBtn=idx<optFields.length-1?`<button class="reorder-btn" data-dir="right" data-idx="${idx}">→</button>`:'';
        return `<span class="selected-tag" data-k="${k}">${leftBtn}${f?f.l:k}${rightBtn}<button data-remove="${k}"><svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></span>`;
    }).join('');
    selectedFields.querySelectorAll('[data-remove]').forEach(btn=>btn.onclick=e=>{
        optFields.splice(optFields.indexOf(e.target.dataset.remove),1);savePrefs();renderFieldsGrid();if(flights.length)renderTable();
    });
    selectedFields.querySelectorAll('.reorder-btn').forEach(btn=>btn.onclick=e=>{
        e.stopPropagation();
        const idx=parseInt(e.target.dataset.idx),dir=e.target.dataset.dir;
        if(dir==='left'&&idx>0)[optFields[idx-1],optFields[idx]]=[optFields[idx],optFields[idx-1]];
        else if(dir==='right'&&idx<optFields.length-1)[optFields[idx],optFields[idx+1]]=[optFields[idx+1],optFields[idx]];
        savePrefs();renderSelFields();if(flights.length)renderTable();
    });
}
function findF(k){for(let c of Object.values(CATS)){const f=c.find(x=>x.k===k);if(f)return f}return null}

function updateStats(){
    let tot=0,pic=0,sic=0,rp=0,day=0,ngt=0,to=0,ldg=0;
    flights.forEach(f=>{
        const t=parseFloat(f['Total Flight Time'])||0;tot+=t;
        if(f.role==='PIC')pic+=t;else if(f.role==='SIC')sic+=t;else if(f.role==='RP')rp+=t;
        day+=parseFloat(f['Day Flight'])||0;ngt+=parseFloat(f['Night'])||0;
        to+=f['Takeoffs (any)']?1:0;ldg+=f['Landings']?1:0;
    });
    statsRow.innerHTML=`<div class="stat-box"><div class="stat-label">Total</div><div class="stat-value">${tot.toFixed(1)}</div></div><div class="stat-box"><div class="stat-label">PIC</div><div class="stat-value">${pic.toFixed(1)}</div></div><div class="stat-box"><div class="stat-label">SIC</div><div class="stat-value">${sic.toFixed(1)}</div></div>${rp?`<div class="stat-box"><div class="stat-label">RP</div><div class="stat-value">${rp.toFixed(1)}</div></div>`:''}<div class="stat-box"><div class="stat-label">Day</div><div class="stat-value">${day.toFixed(1)}</div></div><div class="stat-box"><div class="stat-label">Night</div><div class="stat-value">${ngt.toFixed(1)}</div></div><div class="stat-box"><div class="stat-label">T/O</div><div class="stat-value">${to}</div></div><div class="stat-box"><div class="stat-label">Ldg</div><div class="stat-value">${ldg}</div></div>`;
}

function generatePreview(){
    if(!flights.length){showStatus('No flights to preview','error');return}
    const hasRP=flights.some(f=>f.role==='RP');
    const hasOtherCrew=flights.some(f=>f.otherCrew);
    const visibleCols=getVisibleCols().map(c=>c.k);

    csvData=flights.map(f=>{
        const t=f['Total Flight Time']||'';
        const isPIC=f.role==='PIC',isSIC=f.role==='SIC',isRP=f.role==='RP';
        const row={};

        // Column order matches BASE_COLS order
        if(visibleCols.includes('Date'))row['Date']=f.Date;
        if(visibleCols.includes('Tail Number'))row['Tail Number']=f['Tail Number'];
        if(visibleCols.includes('Model'))row['Model']=getModelForOutput(f)||'';
        row['Total Flight Time']=t;
        if(visibleCols.includes('From'))row['From']=f.From;
        if(visibleCols.includes('To'))row['To']=f.To;

        // PIC/SIC/RP time (derived from role)
        row['PIC']=isPIC?t:'';
        row['SIC']=isSIC?t:'';
        if(hasRP)row['Relief Pilot Time']=isRP?t:'';

        // Names
        if(visibleCols.includes('picName'))row['Name of PIC']=f.picName;
        if(visibleCols.includes('sicName'))row['Name of SIC']=f.sicName;
        if(visibleCols.includes('otherCrew')&&hasOtherCrew)row['Additional Crew Member(s)']=f.otherCrew;

        // Time fields
        if(visibleCols.includes('IFR Time'))row['IFR Time']=f['IFR Time'];
        if(visibleCols.includes('Day Flight'))row['Day Flight']=f['Day Flight'];
        if(visibleCols.includes('Night'))row['Night']=f['Night'];
        if(visibleCols.includes('rightSeat'))row['Right Seat Time']=f.rightSeat?t:'';

        // Counts
        if(visibleCols.includes('Takeoffs (any)'))row['Takeoffs (any)']=f['Takeoffs (any)']?1:'';
        if(visibleCols.includes('Landings'))row['Landings']=f['Landings']?1:'';

        // Operations
        if(visibleCols.includes('ETOPS Flight'))row['ETOPS Flight']=f['ETOPS Flight']||'';
        if(visibleCols.includes('Employer Name'))row['Employer Name']=f['Employer Name'];
        if(visibleCols.includes('Nose Number'))row['Nose Number']=f['Nose Number'];
        if(visibleCols.includes('flightNumber'))row['Flight Number']=f.flightNumber;

        // Optional fields
        optFields.forEach(k=>{
            if(!hiddenCols.has(k)){
                // Special handling for LTC - export as time when checked
                if(k==='ltc')row['Line Training Captain (LTC) Time']=f.opt[k]?t:'';
                else row[k]=f.opt[k]||'';
            }
        });

        // Comments always last
        if(visibleCols.includes('Comments'))row['Comments']=f.Comments||'';

        return row;
    });
    
    const hds=Object.keys(csvData[0]);
    previewHead.innerHTML='<tr>'+hds.map(h=>`<th>${h}</th>`).join('')+'</tr>';
    previewBody.innerHTML=csvData.map(r=>'<tr>'+hds.map(h=>{
        let v=r[h],s=v==='Self'?'color:var(--purple);font-weight:500':/^\d+\.?\d*$/.test(v)&&v?'color:var(--green)':v==='Yes'?'color:var(--blue)':'';
        return `<td style="${s}">${v}</td>`;
    }).join('')+'</tr>').join('');
    previewCount.textContent=csvData.length;goToStep(3);
}

function downloadCSV(){
    if(!csvData.length){showStatus('No data.','error');return}
    const hds=Object.keys(csvData[0]);
    const lines=[hds.join(','),...csvData.map(r=>hds.map(h=>{let v=r[h]??'';v=String(v);if(v.includes(',')||v.includes('"')||v.includes('\n'))v='"'+v.replace(/"/g,'""')+'"';return v}).join(','))];
    const blob=new Blob([lines.join('\r\n')],{type:'text/csv'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='myflightbook_'+new Date().toISOString().slice(0,10)+'.csv';
    a.click();URL.revokeObjectURL(a.href);
    const btn=$('downloadBtn');
    btn.classList.add('downloaded');
    btn.innerHTML='<svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Downloaded!';
    showStatus('CSV file downloaded successfully!','success');
    setTimeout(()=>{btn.classList.remove('downloaded');btn.innerHTML='<svg class="icon" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg> Download'},2000);
}

function convDate(d){const m={jan:1,feb:2,mar:3,apr:4,may:5,jun:6,jul:7,aug:8,sep:9,oct:10,nov:11,dec:12};const x=d.replace(/\s+/g,' ').trim().match(/([A-Za-z]{3})\s+(\d{1,2})\s+(\d{4})/);return x?m[x[1].toLowerCase()]+'/'+parseInt(x[2])+'/'+x[3]:d}
function fmtTail(r){r=r.replace(/-/g,'').trim().toUpperCase();return r.startsWith('C')&&r.length>1?'C-'+r.substring(1):r}
function extNose(f){const m=f.match(/\d+/);return m?m[0]:f}
function cleanFlt(f){return f.replace(/^#\s*/,'').trim()}
function goToStep(s){
    document.querySelectorAll('.step').forEach((e,i)=>{e.classList.remove('active','completed');if(i+1<s)e.classList.add('completed');if(i+1===s)e.classList.add('active')});
    document.querySelectorAll('.step-connector').forEach((e,i)=>{e.classList.toggle('done',i+1<s)});
    document.querySelectorAll('.section').forEach((e,i)=>{
        const sec=e;
        if(i+1===s){sec.classList.add('active');sec.style.animation='fadeIn .3s ease'}
        else{sec.classList.remove('active')}
    });
}
function showStatus(m,t){
    const icons={
        error:'<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>',
        success:'<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
        warning:'<svg class="status-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>'
    };
    statusMsg.innerHTML=`<div class="status status-${t}">${icons[t]||''}${m}</div>`;
    if(t==='success')setTimeout(()=>statusMsg.innerHTML='',3000)
}
</script>
</body>
</html>
